---
title: "State wide NO~3~ leaching results"
author: "Elke Brandes"
date: "November 8, 2016"
output: ioslides_presentation:
  incremental: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)
```

## DNDC - Model assumptions

- Iowa, subfield resolution

- 4 model runs:

    1. Status quo (corn, soybean), 2012-2015
    
    2. Switchgrass, low yield (7,500 kg/ha), 2006-2015
    
    3. Switchgrass, med yield (10,000 kg/ha), 2006-2015
    
    4. Switchgrass, high yield (12,500 kg/ha), 2006-2015
    
## DNDC - Model assumptions cont'd

- Row crop fertilization rates are constant, varying by year (optimal return on N)
- Switchgrass: 50 kg N/ha
- Switchgrass C/N above ground biomass = 75
- Switchgrass C/N below ground biomass = 60

## Results - Outline

1. Distributions of NO~3~ leaching in Iowa
2. Correlation between profitability and NO~3~ leaching in corn and soybean fields
3. Switchgrass integration scenarios
4. Disproportionate benefits?
5. Spatial distribution of NO~3~ leaching changes

## 1. Distributions of NO~3~ leaching in Iowa
```{r intro, message=FALSE, warning=FALSE}
library('RPostgreSQL') # PostgreSQL database connection
library("ggplot2") # for the figures
library("maps") # to plot maps, contains country/state/county outlines
library("gridGraphics") # needed for the function unit in ggplot
library("tidyverse") # to make tidy tables, includes dplyr needed for PostgreSQL database connection
library('knitr') # to use kable() function

library(rgdal) # to read in shape files
library(ggmap)
library(scales)
library(RColorBrewer)
library("sp") # to use merge with a spatial data frame

library("tmap")

pw <- {
  "5QUXJHTbxj"
}
isuag_db <- src_postgres(dbname = 'isuag',
                           host = 'isu-ag-db.agsolver.com',
                           port = 5432,
                           user = 'isuag',
                           password = pw)
pw <- {
  "5QUXJHTbxj"
}
drv <- dbDriver("PostgreSQL") # loads the PostgreSQL driver
con <- dbConnect(drv, dbname = "isuag",  # creates a connection to the postgres database
                 host = "isu-ag-db.agsolver.com", port = 5432,
                 user = "isuag", password = pw)
# note that "con" will be used later in each connection to the database

cgsb_leach <-tbl(isuag_db, "06_cgsb_ave_no3_leach_rounded_aggr")  %>%
  as.data.frame()
swg_low <-tbl(isuag_db, "06_swg_7500_ave_no3_leach_rounded_aggr")  %>%
  as.data.frame()
swg_med <-tbl(isuag_db, "06_swg_10000_ave_no3_leach_rounded_aggr")  %>%
  as.data.frame()
swg_hi <-tbl(isuag_db, "06_swg_12500_ave_no3_leach_rounded_aggr")  %>%
  as.data.frame()

data_list <- list(cgsb_leach, swg_low, swg_med, swg_hi)

theme_b_border <- function (base_size = 12, base_family = "") 
{
  theme_grey(base_size = base_size, base_family = base_family) %+replace% 
    theme(
      axis.text = element_text(size = rel(0.8), margin = margin(r=10)), #margin 
      axis.ticks = element_line(colour = "black"),
      axis.ticks.length = unit(0.15, "cm"),
      legend.key = element_rect(colour = NA), panel.background = element_rect(fill = "white", 
      colour = NA), panel.border = element_rect(fill = NA, 
      colour = "black"), panel.grid.major = element_line(colour = NA, 
      size = 0.2), panel.grid.minor = element_line(colour = NA, 
      size = 0.5), strip.background = element_rect(fill = "grey80", 
      colour = "grey50", size = 0.2))
}

scenario <- c(rep("cgsb", sum(sapply(data_list[1],nrow))), rep("swg_low", sum(sapply(data_list[2],nrow))), rep("swg_med", sum(sapply(data_list[3],nrow))), rep("swg_hi", sum(sapply(data_list[4],nrow)))) %>%
factor(levels= c('cgsb', 'swg_low', 'swg_med', 'swg_hi')) # make it a factor so that it is plotted in the right order in the facets

leaching <- vector(mode="numeric", length=0)
 for (i in seq(data_list))
   leaching <- append(leaching, data_list[[i]][,1])
  
area <- vector(mode="numeric", length=0)
 for (i in seq(data_list))
   area <- append(area, data_list[[i]][,2])

leach <- data.frame(scenario, leaching, area = area*1e-6) # this factor to show Mha

```



```{r histograms, warning=FALSE, message=FALSE, cache=TRUE, fig.cap="Figure 1: Distributions of NO3 leaching"}
scenarios <- c('cgsb'= "Status Quo (corn/soybeans)", 'swg_low' = "Low yielding switchgrass", 'swg_med' = "Medium yielding switchgrass", 'swg_hi' = "High yielding switchgrass")

ggplot(leach, aes(leaching, weight = area)) + 
  geom_histogram(binwidth=2, alpha = .5, position="identity") +
  theme_b_border() +
  scale_x_continuous(name="Mean NO3 leaching 2006-2015 (kg N/ha)") +
  scale_y_continuous(name="Area (Mha)") +
  theme(legend.position="bottom") +
  facet_wrap( ~ scenario, ncol=2, labeller = as_labeller(scenarios)) 
```

##2. Correlation between profitability and NO~3~ leaching

```{sql, connection=con, cache=TRUE, include=FALSE}
SELECT setseed(0.5)
```
```{sql, connection=con, message=FALSE, cache=TRUE}
DROP TABLE IF EXISTS "r_dndc_clumu_cgsb_swg_sample";
```
```{sql, connection=con, message=FALSE, cache=TRUE}
CREATE TABLE "r_dndc_clumu_cgsb_swg_sample" AS SELECT mean_profit_ha, ave_no3_leach_ha_cgsb FROM "05_dndc_clumu_cgsb_swg" ORDER BY random() LIMIT 10000
```

```{r data_sample}
sample = tbl(isuag_db, "r_dndc_clumu_cgsb_swg_sample") %>%
  as.data.frame(sample)
```

```{r scatterplot, cache=TRUE, fig.show="hold", fig.width=4, fig.height=4, fig.cap="Figure 2: Scatterplot of a subsample (n=10000) of profitability and corn/soy leaching data on subfield areas in Iowa."}
ggplot() +
  geom_point(data = sample, aes(x = mean_profit_ha, y = ave_no3_leach_ha_cgsb)) +
  theme_b_border() +
  scale_x_continuous(name="Mean profitability 2012-2015 (US$/ha)") +
  scale_y_continuous(name="Mean NO3 leaching 2006-2015 (kg N/ha)") +
  geom_vline(aes(xintercept= -150, linetype= "dashed", color = "red"),  show.legend = FALSE) +
  geom_hline(aes(yintercept= 60, linetype= "dotted", color = "red"),  show.legend = FALSE) 

ggplot() +
  geom_point(data = sample, aes(x = mean_profit_ha, y = ave_no3_leach_ha_cgsb)) +
  theme_b_border() +
  scale_x_continuous(name="Mean profitability 2012-2015 (US$/ha)") +
  scale_y_continuous(name="Mean NO3 leaching 2006-2015 (kg N/ha)", limits=c(0,20)) +
  geom_vline(aes(xintercept= -150, linetype= "dashed", color = "red"),  show.legend = FALSE)
  
```

## 3. Switchgrass integration scenarios

```{r total_leaching, cache=TRUE}
scen_areas <-tbl(isuag_db, "05_dndc_no3_leach_sums_iowa_scenarios")  %>%
  as.data.frame()
perc_leach_red <- 
kable(scen_areas, col.names=c("Status Quo","PO 7500", "PO 10000", "PO 12500","WO 7500", "WO 10000", "WO 12500"), caption="Annual NO3 leaching (Mg N) in Iowa modelled with DNDC under different switchgrass integration scenarios. PO: Profitability optimized, WO: Water quality optimized." )
perc_leach_red
```

- PO scenario: Areas losing 150 US$/ha or more are in switchgrass
- WO scenario: Areas leaching 60 kg/ha or more are in switchgrass

## 4. Switchgrass integration: Disproportionate benefits?

```{r profit_distribution, fig.cap="Figure 4: Distribution of mean profitability 2012-2015."}
profit = tbl(isuag_db, "01_profit_mean_2012_2015_aggregated") %>%
  as.data.frame()

ggplot(profit, aes(profit_mean_ha_rounded, weight = sum_ha)) + 
  geom_histogram(binwidth=20, alpha = .5, position="identity") +
  theme_b_border() +
  scale_x_continuous(name="Mean profitability 2012-2015 (US$/ha)") +
  scale_y_continuous(name="Area (Mha)") +
  geom_vline(aes(xintercept= 0, linetype= "dashed"),  show.legend = FALSE) 
```

## 4. Switchgrass integration: Disproportionate benefits?
```{r swg_areas_po, cache=TRUE}
swg_areas_po <- vector(mode="numeric", length=0)
# profit <- tbl(isuag_db, "05_dndc_clumu_cgsb_swg")
profit_cutoffs <- c(-500, -400, -300, -200, -150, -100, -50, 0, 50, 100, 150)
 for (i in 1:length(profit_cutoffs)) {
    query <- paste("SELECT SUM(clumuha) FROM \"05_dndc_clumu_cgsb_swg\" WHERE mean_profit_ha < ", as.character(profit_cutoffs[i]))
    sum_area <- tbl(isuag_db, sql(query)) %>%
      as.data.frame()
    sum_area <- sum_area[1,1]
    swg_areas_po <- append(swg_areas_po, sum_area) 
  }

sum_leaching <- tbl(isuag_db, "05_dndc_no3_leach_sums_iowa_dispr_benefits") %>%
  as.data.frame() %>%
  gather(corn_soybeans, swg_7500_1, swg_7500_2, swg_7500_3, swg_7500_4, swg_7500_5, swg_7500_6, swg_7500_7, swg_7500_8, swg_7500_9, swg_7500_10, swg_7500_11, swg_10000_1, swg_10000_2, swg_10000_3, swg_10000_4, swg_10000_5, swg_10000_6, swg_10000_7, swg_10000_8, swg_10000_9, swg_10000_10, swg_10000_11, swg_12500_1, swg_12500_2, swg_12500_3, swg_12500_4, swg_12500_5, swg_12500_6, swg_12500_7, swg_12500_8, swg_12500_9, swg_12500_10, swg_12500_11, key = swg_scenarios, value=ave_no2_leach)

```

```{sql connection=con, message=FALSE, include=FALSE, cache=TRUE}
select sum(clumuha) from "05_dndc_clumu_cgsb_swg";
```
```{r swg_areas_wo, cache=TRUE}
swg_areas_wo <- vector(mode="numeric", length=0)
leach_cutoff <- c(100, 90, 80, 70, 60, 50)
 for (i in 1:length(leach_cutoff)) {
    query <- paste("SELECT SUM(clumuha) FROM \"05_dndc_clumu_cgsb_swg\" WHERE ave_no3_leach_ha_cgsb > ", as.character(leach_cutoff[i]))
    sum_area <- tbl(isuag_db, sql(query)) %>%
      as.data.frame()
    sum_area <- sum_area[1,1]
    swg_areas_wo <- append(swg_areas_wo, sum_area) 
  }
swg_yield <- as.factor(c("NA",rep("7500",11), rep("10000",11),rep("12500",11)))
profit_cutoff <- c(NA, rep(profit_cutoffs,3))
swg_area_po <- c(0,rep(swg_areas_po,3))
swg_area_po_percent <- (swg_area_po/9374362)*100
N_leaching <- sum_leaching[,2]
N_reduction <- abs((N_leaching - N_leaching[1])/N_leaching[1])*100

relation_po <- data.frame(swg_yield, profit_cutoff, swg_area_po_percent, N_reduction)

swg_area_wo_percent <- (swg_areas_wo/9374362)*100

relation_wo <- data.frame(leach_cutoff, swg_area_wo_percent)
```

```{r thresholds, fig.show="hold", fig.height= 3, fig.width=3.5, fig.cap="Figure 5: Relation between the set thresholds in the profitability (left panel) and water quality optimized (right panel) scenario and the resulting area in switchgrass."}
ggplot() +
  geom_point(data = relation_po, aes(x = profit_cutoff, y = swg_area_po_percent)) +
  theme_b_border() +
  scale_x_continuous(name="Profitability threshold (US$/ha)", breaks=seq(from=-500, to=200, by= 100)) +
  scale_y_continuous(name="Area in switchgrass (%)", limits= c(0,65))

ggplot() +
  geom_point(data = relation_wo, aes(x = leach_cutoff, y = swg_area_wo_percent)) +
  theme_b_border() +
  scale_x_reverse(name="NO3 leaching threshold (kg/ha)", breaks=seq(from=50, to=100, by= 10)) +
  scale_y_continuous(name="Area in switchgrass (%)", limits= c(0,65))


```