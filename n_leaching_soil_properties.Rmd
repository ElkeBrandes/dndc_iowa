---
title: "Understanding low NO~3~-N leaching / high NH~3~ volatilizing soils in Iowa modelled with DNDC"
author: "Elke Brandes"
date: "Tuesday, November 01, 2016"
output: 
  html_document:
    toc: true
    toc_depth: 2
    bibliography: nutrient_bibliography.bib
---


---
```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning = FALSE)

```


```{r packages, message=FALSE, warning=FALSE}
library('RPostgreSQL') # PostgreSQL database connection
library("ggplot2") # for the figures
library("maps") # to plot maps, contains country/state/county outlines
library("gridGraphics") # needed for the function unit in ggplot
library("tidyverse") # to make tidy tables, includes dplyr needed for PostgreSQL database connection
library('knitr') # to use kable() function

library(rgdal) # to read in shape files
library(ggmap)
library(scales) # needed for ggradar
library(RColorBrewer)
library("sp") # to use merge with a spatial data frame

library("tmap")
library("grDevices") # for colors of surface plot
# library("graphics") # for surface plot
# library("rgl") # for surface plot (3d graphics, more powerful than persp()
library("plot3D") # another package to plot surface plots
library(gridExtra) # need to plot ggplots in a grid
library(ggradar) # to plot radar charts with gglot
library("Hmisc") # to calculate weighted standard deviation


```



```{r connect_dplyr, message=FALSE, include=FALSE}


pw <- "angst-vrpFhB" # enter password here
db_con <- src_postgres(dbname = 'AgSolver',
                           host = 'heatonagsolver.cv5vlzyvdngx.us-east-1.rds.amazonaws.com',
                           port = 5432,
                           user = 'heatonlab',
                           password = pw)

```

```{r, connect_rpostgres, message=FALSE, include=FALSE}

drv <- dbDriver("PostgreSQL") # loads the PostgreSQL driver
con <- dbConnect(drv, dbname = "AgSolver",  # creates a connection to the postgres database
                 host = "heatonagsolver.cv5vlzyvdngx.us-east-1.rds.amazonaws.com", port = 5432,
                 user = "heatonlab", password = pw)
# note that "con" will be used later in each connection to the database
```


```{r theme, cache=TRUE, include = FALSE}

# I am using a modified theme for ggplot that has a black border and white background.

theme_b_border <- function (base_size = 12, base_family = "") 
{
  theme_grey(base_size = base_size, base_family = base_family) %+replace% 
    theme(
      axis.text = element_text(size = rel(0.8), margin = margin(r=10)), #margin 
      axis.ticks = element_line(colour = "black"),
      axis.ticks.length = unit(0.15, "cm"),
      legend.key = element_rect(colour = NA), panel.background = element_rect(fill = "white", 
      colour = NA), panel.border = element_rect(fill = NA, 
      colour = "black"), panel.grid.major = element_line(colour = NA, 
      size = 0.2), panel.grid.minor = element_line(colour = NA, 
      size = 0.5), strip.background = element_rect(fill = "grey80", 
      colour = "grey50", size = 0.2))
}
```

## 1. Correlation between profitability and NO~3~^-^ leaching in corn and soybean fields
In this chapter, I am only looking at the N loss through NO~3~^-^ leaching to check wether the numbers are reasonable.
I am using the table `05_dndc_clumu_cgsb_swg` in the isuag database, that contains 2012-2015 mean profit and leaching values for each of the four scenarios on a subfield (clu-map unit) scale. I want to see if there is a correlation between profitability and NO3 leaching, but since the complete data set contains more than 3 million records, I want to randomly select a sub-sample for the correlation.

Pull a table of a sub-sample (n=10,000) into R:
```{r data_sample, include=FALSE}
sample = tbl(db_con, "r_dndc_clumu_cgsb_swg_sample") %>%
  as.data.frame(sample)
```

I plot the sample as a scatter plot:
```{r scatterplot, warning=FALSE, cache=TRUE, fig.width=4.5, fig.height=3, fig.cap="Figure 1: Scatterplot of a subsample (n=10,000) of profitability and corn/soy leaching data on subfield areas in Iowa. The red lines indicate possible cut off values, such as -150 US$ ha^-1^ for profitability (solid) and 60 kg N ha^-1^ for NO3 leaching (dashed)."}
ggplot() +
  geom_point(data = sample, aes(x = mean_profit_ha, y = ave_no3_leach_ha_cgsb), alpha=0.2, stroke=0) +
  theme_b_border() +
  labs(y=expression(Mean~NO[3]^{"-"}~leaching~(kg~N~ha^{-1})),
       x=expression(Mean~profitability~("US$"~ha^{-1}))) +
  geom_vline(aes(xintercept= -100, linetype= "dashed", color = "red"),  show.legend = FALSE) +
  geom_hline(aes(yintercept= 50, linetype= "dotted", color = "red"),  show.legend = FALSE)
  
```
### Areas with very low NO~3~^-^ leaching

There are many records with leaching values close to 0, and then only a few that are higher but below about 10. The next plot zooms in on the y axis to see this better:
```{r scatterplot_zoom, warning = FALSE, cache=TRUE, fig.width=4.5, fig.height=3, fig.cap="Figure 2: Scatterplot of a subsample (n=10000) of profitability and corn/soy leaching data on subfield areas in Iowa. The y axis is zoomed in on 0-20 kg N ha^-1^ to better see the low leaching values. The red line indicates a possible cut off value of -150 US$ ha^-1^ for profitability."}
ggplot() +
  geom_point(data = sample, aes(x = mean_profit_ha, y = ave_no3_leach_ha_cgsb), alpha=0.2, stroke=0) +
  theme_b_border() +
  labs(y=expression(Mean~NO[3]^{"-"}~leaching~(kg~N~ha^{-1})),
       x=expression(Mean~profitability~("US$"~ha^{-1}))) +
  scale_x_continuous() +
  scale_y_continuous(limits=c(0,20)) +
  geom_vline(aes(xintercept= -100, linetype= "dashed", color = "red"),  show.legend = FALSE)
  
```

## 2. Soil properties on low leaching areas

I looked into the soil properties of those low leaching areas. For this, I queried the SSURGO database through the [SQL interface](http://sdmdataaccess.nrcs.usda.gov/Query.aspx) to get data on total sand fraction and pH per component and horizon. I imported the table into the isuag PostgreSQL database and joined the soil data (total sand fraction and pH), aggregated to the mapunit, to the DNDC results. 

I then drew random samples from that table to analyze the relationship between leaching and sand fraction / pH.
In high pH soils the equilibrium between NH~3~^+^ and NH~3~ is shifted toward NH~3~, therefore they might show higher volatilization and lower NO~3~^-^ leaching, because the equilibrium is calculated before the nitrification to NO~3~^-^ and subsequent leaching in the DNDC model. Higher sand fraction means lower CEC (cation exchange capacity), therefore more NH~3~^+^ is available (not sorbed by negatively charged colloids).


I make a dataframe out of the db table:
```{r soil_sample}
soil = tbl(db_con, "r_leaching_soil_sample") %>%
  as.data.frame()
```

Then I plot the sample:
```{r scatter_leach_sand, warning=FALSE, fig.width=4.5, fig.height=3, fig.show = "hold", fig.cap="Figure 3: Scatterplot of a subsample (n=10,000) of corn/soy leaching data and sand fraction on subfield areas in Iowa."}
ggplot() +
  geom_point(data = soil, aes(x = avg_sandtotal_r, y = ave_no3_leach_ha_cgsb), alpha=0.2, stroke=0) +
  theme_b_border() +
  scale_x_continuous() +
  scale_y_continuous() +
  labs(y=expression(Mean~NO[3]^{"-"}~leaching~(kg~N~ha^{-1})),
       x=expression(Sand~fraction~("%")))

ggplot() +
  geom_point(data = soil, aes(x = avg_sandtotal_r, y = ave_no3_leach_ha_cgsb), alpha=0.2, stroke=0) +
  theme_b_border() +
  scale_x_continuous() +
  scale_y_continuous(limits=c(0,20)) +
  labs(y=expression(Mean~NO[3]^{"-"}~leaching~(kg~N~ha^{-1})),
       x=expression(Sand~fraction~("%")))
  
ggplot() +
  geom_point(data = soil, aes(x = avg_ph1to1h2o_r, y = ave_no3_leach_ha_cgsb), alpha=0.2, stroke=0) +
  theme_b_border() +
  scale_x_continuous() +
  scale_y_continuous() +
  labs(y=expression(Mean~NO[3]^{"-"}~leaching~(kg~N~ha^{-1})),
       x=expression(pH))

ggplot() +
  geom_point(data = soil, aes(x = avg_ph1to1h2o_r, y = ave_no3_leach_ha_cgsb), alpha=0.2, stroke=0) +
  theme_b_border() +
  scale_x_continuous() +
  scale_y_continuous(limits=c(0,20)) +
  labs(y=expression(Mean~NO[3]^{"-"}~leaching~(kg~N~ha^{-1})),
       x=expression(pH))
```

```{r scatter_ph, fig.width=4.5, fig.height=3, warning=FALSE, fig.cap="Figure 4: Scatterplot of a subsample (n=10,000) of pH values measured with different methods from the SSURGO database."}
ggplot() +
  geom_point(data = soil, aes(x = avg_ph1to1h2o_r, y = avg_ph01mcacl2_r)) +
  theme_b_border() +
  scale_x_continuous() +
  scale_y_continuous() +
  labs(y=expression(pH~CaCl2), x=expression(pH~H2O)) +
  geom_abline(intercept=0, slope = 1)


```

Figure 6 shows that the low leaching values do not fall out of the general pattern. Soils with lower sand fraction generally show lower leaching, but the very low leaching soils show a range of sand fraction. There is a cluster of low leaching subfield areas of pH 7.9 - 8.1. For these soils, NO~3~^-^ leaching might be low because the NH~3~ <-> NH~4~^+^ equilibrium is shifted toward the volatile NH~3~ that is leaving the soil.

To eliminate artifacts that are caused by model structure and mechansim, we decided to sum up NO~3~^-^ leaching and NH~3~ volatilization, assuming that volatilization is negligible since it is minimized by management (i.e. timing of fertilization before rain events, injecting anhydrous ammonia below the surface). Estimated N losses due to NH~3~ volatilization from synthetic fertilizers range between 0 and 5 kg ha^-1^ in the USA, not including the use of inhibiting chemicals [@bouwman2002nh3].

## 3. N loss through NO~3~^-^ leaching and NH~3~ volatilization

I calculated N losses as a sum of the model outputs NO~3~^-^ leaching and NH~3~ volatilization in PostgreSQL for corn/soybean and for the three switchgrass yield scenarios.

### Correlation between NO~3~^-^ leaching and NH~3~ volatilization

I draw a sample from the original DNDC result table for the status quo to look at the relationship between the two N loss pools. Note: I am not transforming the values into metric units in this case, so the units are lbs/acre.

Pull the new table into R:
```{r leach_vol_sample}
sample = tbl(db_con, "r_isu_cgsb_clumu_proc_sample") %>%
  as.data.frame(sample)
```

I plot the sample as a scatter plot:
```{r leach_vol_scatterplot, warning=FALSE, cache=TRUE, fig.width=4.5, fig.height=3, fig.cap="Figure 5: Scatterplot of a subsample (n=10,000) of corn/soy NO~3~^-^ leaching and NH~3~ volatilization data (averaged over 2012 - 2015) on subfield areas in Iowa."}
ggplot() +
  geom_point(data = sample, aes(x = ave_no3_leach, y = ave_nh3_vol), alpha=0.2, stroke=0) +
  theme_b_border() +
  labs(x=expression(Mean~NO[3]^{"-"}~leaching~(lbs~N~acre^{-1})),
       y=expression(Mean~NH[3]~volatilization~(lbs~N~acre^{-1})))
  
```


### Correlation between profitability and N loss in corn and soybean fields

I am using the table `05_dndc_clumu_cgsb_swg_n_loss` in the isuag database, that contains 2012-2015 mean profit and N loss values for each of the four scenarios on a subfield (clu-map unit) scale. I want to see if there is a correlation between profitability and N loss, and if the artifact of low leaching patches seen in Figure 4. disappears as the high NH~3~ volatilization compensates the low NO~3~^-^ leaching.


Pull the subset table into R:
```{r data_sample_n_loss}
sample_n_loss = tbl(db_con, "r_dndc_clumu_cgsb_swg_n_loss_sample") %>%
  as.data.frame(sample)

```

I visualize the sample as a scatter plot:
```{r scatterplot_n_loss, warning=FALSE, fig.cap="Figure 6: Scatterplot of a subsample (n=10,000) of profitability and corn/soy N loss data on subfield areas in Iowa. The red lines indicate possible cut off values, such as -150 US$ ha^-1^ for profitability (solid) and 60 kg N ha^-1^ for N loss (dashed)."}
ggplot() +
  geom_point(data = sample_n_loss, aes(x = mean_profit_ha, y = ave_n_loss_ha_cgsb), alpha=0.2, stroke=0) +
  theme_b_border() +
  labs(y=expression(Mean~N~loss~2006-2015~(kg~N~ha^{-1})),
       x=expression(Mean~profitability~("US$"~ha^{-1}))) +
  geom_vline(aes(xintercept= -100, linetype= "dashed", color = "red"),  show.legend = FALSE) +
  geom_hline(aes(yintercept= 50, linetype= "dotted", color = "red"),  show.legend = FALSE)
  
```
As expected, there are no extreme values falling out of the point cloud when nitrate leaching and ammonium volatilization are summed up into total N loss.

We narrowed the causes of the extreme leaching and volatilization values down to the soil properties, because annual variation would not show up so significantly in a variable averaged over four years.

## 4. Spatial distribution of low-leaching soils


Next, I looked at the spatial distribution of the low leaching values, and of volatilization in general.

It strikes that mean county volatilization is very high in a few west Iowa counties, shown in this map:

```{r nh3_vol_county, fig.cap="Figure 7: County mean ammonium volatilization."}

 counties_no3_leach = tbl(db_con, "07_dndc_counties") %>%
   as.data.frame()
 # change the data in the column named "FIPS", so that is contains the county identifiers in the same format as the spatial file:
 for (i in 1:length(counties_no3_leach$fips)) {
   counties_no3_leach$fips[i] <- sub("IA", "19", counties_no3_leach$fips[i])
    }
 # make it a factor
  counties_no3_leach$fips <- as.factor(counties_no3_leach$fips)

counties <- readOGR(dsn="./shapefiles/county.shp",layer="county")
names(counties)[9] <- "fips" # change to lower case so that we can join on this field later on

# join the attribute data with the spatial data, using a left join and the identifier "fips":
counties@data <- left_join(counties@data, counties_no3_leach, by = "fips")

# make a dataframe out of the spatial object
counties_df <- fortify(counties)
counties$id <- row.names(counties) # assign a column with the variable ID that is equal to the row names (=numbers), starting with 0.
# join the attributes back to the data frame, to create a dataframe used to map the baseline (corn/soybean):
counties_baseline_df <- left_join(counties_df, counties@data)

# add a spatial data frame with the county centroids, to be used to plot the total leaching N per county:
centroids <- getSpPPolygonsLabptSlots(counties) %>%
  as.data.frame() 
centroids$id <- as.character(0:98)

# join the total N leaching data to the centroids 
counties_baseline_df <- left_join(counties_baseline_df, centroids)

# create a theme without axes:
ditch_the_axes <- theme(
  axis.text = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank()
  )

ggplot() +
  geom_polygon(data = counties_baseline_df, aes(long, lat, group = group, fill=ave_nh3_vol_cgsb), color = "white") +
  #geom_point(data = counties_baseline_df, aes(V1, V2, size = tot_no3_leach_cgsb), color = "yellow") +
  #labs(size = expression(Total~N~loss~(Mg~N~ha^{-1}))) +
  coord_equal() +
  ditch_the_axes +
  labs(fill = expression(Average~N~loss~(kg~N~ha^{-1}))) +
  scale_fill_gradient(low = "white", high="#009E73", guide = "colourbar") +
  ggtitle("Average annual N loss by ammonia volatilization per county")
```

```{r subfield_leaching, fig.height=5, fig.width=4, fig.cap="Figure 8: 2012-2015 average nitrate leaching (a) and ammonium volatilization (b) in Iowa at a subfield resolution."}
include_graphics("imported_images/DNDC_subfield_NO3_NH3_CGSB_raster_small.png", dpi = 200)
```
## 5. Properties of extremely high and low volatilizing soils

Looking at some soil properties of the extreme high leaching and extreme high volatilizing areas:

```{r extreme_high_samples, cache=TRUE, fig.width=9, fig.height=15, fig.show="hold", fig.cap="Figure 9: Highest leaching and highest volatilizing values plotted against selected soil characteristics."}
hi_leach <- read.table("high_no3_leach.txt", header = TRUE, sep = "")
hi_leach$cat <- as.factor(rep("hi_leach",1000))

hi_vol <- read.table("high_nh3_vol.txt", header = TRUE, sep = "")
hi_vol$cat <- as.factor(rep("hi_vol",1000))

# combine the two data frames into one

extreme <- rbind(hi_leach, hi_vol)

# make a scatter plot

# colorblind friendly palette
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")




plot1 <- ggplot() +
  geom_point(data = extreme, aes(x = ave_nh3_vol, y =  ave_no3_leach, color = cat), alpha=0.2, stroke=0) +
  theme_b_border() +
  scale_colour_manual(values=cbPalette)

plot2 <- ggplot() +
  geom_point(data = extreme, aes(x = bulk_dens, y =  ave_no3_leach, color = cat), alpha=0.2, stroke=0) +
  theme_b_border() +
  scale_colour_manual(values=cbPalette)

plot3 <- ggplot() +
  geom_point(data = extreme, aes(x = ph, y =  ave_no3_leach, color = cat), alpha=0.2, stroke=0) +
  theme_b_border() +
  scale_colour_manual(values=cbPalette)

plot4 <- ggplot() +
  geom_point(data = extreme, aes(x = wthirdbar, y =  ave_no3_leach, color = cat), alpha=0.2, stroke=0) +
  theme_b_border() +
  scale_colour_manual(values=cbPalette)

plot5 <- ggplot() +
  geom_point(data = extreme, aes(x = wfifteenbar, y =  ave_no3_leach, color = cat), alpha=0.2, stroke=0) +
  theme_b_border() +
  scale_colour_manual(values=cbPalette)

plot6 <- ggplot() +
  geom_point(data = extreme, aes(x = awc, y =  ave_no3_leach, color = cat), alpha=0.2, stroke=0) +
  theme_b_border() +
  scale_colour_manual(values=cbPalette)

plot7 <- ggplot() +
  geom_point(data = extreme, aes(x = clay_frac, y =  ave_no3_leach, color = cat), alpha=0.2, stroke=0) +
  theme_b_border() +
  scale_colour_manual(values=cbPalette)

plot8 <- ggplot() +
  geom_point(data = extreme, aes(x = sand_frac, y =  ave_no3_leach, color = cat), alpha=0.2, stroke=0) +
  theme_b_border() +
  scale_colour_manual(values=cbPalette)

plot9 <- ggplot() +
  geom_point(data = extreme, aes(x = ksat, y =  ave_no3_leach, color = cat), alpha=0.2, stroke=0) +
  theme_b_border() +
  scale_colour_manual(values=cbPalette)

plot10 <- ggplot() +
  geom_point(data = extreme, aes(x = om, y =  ave_no3_leach, color = cat), alpha=0.2, stroke=0) +
  theme_b_border() +
  scale_colour_manual(values=cbPalette)

grid.arrange(plot1, plot2, plot3, plot4, plot5, plot6, plot7, plot8, plot9, plot10, ncol=2)


```

## 6. Leaching and volatilization as function of soil properties

### Soil variables to look at:

- bulk_dens: Bulk Density ()
- ph
- wthirdbar
- wfifteenbar
- awc: plant available water capacity (cm/cm) The amount of water that an increment of soil depth, inclusive of fragments, can store that is available to plants. AWC is expressed as a volume fraction, and is commonly estimated as the difference between the water contents at 1/10 or 1/3 bar (field capacity) and 15 bars (permanent wilting point) tension and adjusted for salinity, and fragments.
- clay_frac: Clay fraction
- sand_frac: Sand fraction
- ksat: The amount of water that would move vertically through a unit area of saturated soil in unit time under unit hydraulic gradient.
- om: Organic Matter (%) The amount by weight of decomposed plant and animal residue expressed as a weight percentage of the less than 2 mm soil material.
- soc: Soil organic carbon
- porosity
- fld_capacity: Field capacity
- wilt_pt: Wilting point

```{r all_soil_leach, fig.width=9, fig.height=17, cache=TRUE, fig.cap="Figure 10: Average (2012-2015) nitrate leaching as a function of soil parameters used in the DNDC model."}
all_soil <- tbl(db_con, "no3_soil_sample") %>%
  as.data.frame()

plot1 <- ggplot() +
  geom_point(data = all_soil, aes(x = ave_no3_leach, y = ave_nh3_vol), alpha=0.2, stroke=0) +
  theme_b_border() 

plot2 <- ggplot() +
  geom_point(data = all_soil, aes(x = bulk_dens, y = ave_no3_leach), alpha=0.2, stroke=0) +
  theme_b_border()

plot3 <- ggplot() +
  geom_point(data = all_soil, aes(x = ph , y = ave_no3_leach), alpha=0.2, stroke=0) +
  theme_b_border()

plot4 <- ggplot() +
  geom_point(data = all_soil, aes(x = wthirdbar , y = ave_no3_leach), alpha=0.2, stroke=0) +
  theme_b_border()

plot5 <- ggplot() +
  geom_point(data = all_soil, aes(x = wfifteenbar, y = ave_no3_leach), alpha=0.2, stroke=0) +
  theme_b_border()

plot6 <- ggplot() +
  geom_point(data = all_soil, aes(x = awc, y = ave_no3_leach), alpha=0.2, stroke=0) +
  theme_b_border()

plot7 <- ggplot() +
  geom_point(data = all_soil, aes(x = clay_frac, y = ave_no3_leach), alpha=0.2, stroke=0) +
  theme_b_border()

plot8 <- ggplot() +
  geom_point(data = all_soil, aes(x = sand_frac, y = ave_no3_leach), alpha=0.2, stroke=0) +
  theme_b_border()

plot9 <- ggplot() +
  geom_point(data = all_soil, aes(x = ksat, y = ave_no3_leach), alpha=0.2, stroke=0) +
  theme_b_border()

plot10 <- ggplot() +
  geom_point(data = all_soil, aes(x = om, y = ave_no3_leach), alpha=0.2, stroke=0) +
  theme_b_border()

plot11 <- ggplot() +
  geom_point(data = all_soil, aes(x = soc, y = ave_no3_leach), alpha=0.2, stroke=0) +
  theme_b_border()

plot12 <- ggplot() +
  geom_point(data = all_soil, aes(x = porosity, y = ave_no3_leach), alpha=0.2, stroke=0) +
  theme_b_border()

plot13 <- ggplot() +
  geom_point(data = all_soil, aes(x = fld_capacity, y = ave_no3_leach), alpha=0.2, stroke=0) +
  theme_b_border()

plot14 <- ggplot() +
  geom_point(data = all_soil, aes(x = wilt_pt, y = ave_no3_leach), alpha=0.2, stroke=0) +
  theme_b_border()

grid.arrange(plot1, plot2, plot3, plot4, plot5, plot6, plot7, plot8, plot9, plot10, plot11, plot12, plot13, plot14, ncol=2)

```
```{r all_soil_vol, cache=TRUE , fig.width=9, fig.height=17, fig.cap="Figure 11: Average (2012-2015) ammonia volatilization as a function of soil parameters used in the DNDC model."}
all_soil <- tbl(db_con, "no3_soil_sample") %>%
  as.data.frame()

plot1 <- ggplot() +
  geom_point(data = all_soil, aes(x = ave_no3_leach, y = ave_nh3_vol), alpha=0.2, stroke=0) +
  theme_b_border() 

plot2 <- ggplot() +
  geom_point(data = all_soil, aes(x = bulk_dens, y = ave_nh3_vol), alpha=0.2, stroke=0) +
  theme_b_border()

plot3 <- ggplot() +
  geom_point(data = all_soil, aes(x = ph , y = ave_nh3_vol), alpha=0.2, stroke=0) +
  theme_b_border()

plot4 <- ggplot() +
  geom_point(data = all_soil, aes(x = wthirdbar , y = ave_nh3_vol), alpha=0.2, stroke=0) +
  theme_b_border()

plot5 <- ggplot() +
  geom_point(data = all_soil, aes(x = wfifteenbar, y = ave_nh3_vol), alpha=0.2, stroke=0) +
  theme_b_border()

plot6 <- ggplot() +
  geom_point(data = all_soil, aes(x = awc, y = ave_nh3_vol), alpha=0.2, stroke=0) +
  theme_b_border()

plot7 <- ggplot() +
  geom_point(data = all_soil, aes(x = clay_frac, y = ave_nh3_vol), alpha=0.2, stroke=0) +
  theme_b_border()

plot8 <- ggplot() +
  geom_point(data = all_soil, aes(x = sand_frac, y = ave_nh3_vol), alpha=0.2, stroke=0) +
  theme_b_border()

plot9 <- ggplot() +
  geom_point(data = all_soil, aes(x = ksat, y = ave_nh3_vol), alpha=0.2, stroke=0) +
  theme_b_border()

plot10 <- ggplot() +
  geom_point(data = all_soil, aes(x = om, y = ave_nh3_vol), alpha=0.2, stroke=0) +
  theme_b_border()

plot11 <- ggplot() +
  geom_point(data = all_soil, aes(x = soc, y = ave_nh3_vol), alpha=0.2, stroke=0) +
  theme_b_border()

plot12 <- ggplot() +
  geom_point(data = all_soil, aes(x = porosity, y = ave_nh3_vol), alpha=0.2, stroke=0) +
  theme_b_border()

plot13 <- ggplot() +
  geom_point(data = all_soil, aes(x = fld_capacity, y = ave_nh3_vol), alpha=0.2, stroke=0) +
  theme_b_border()

plot14 <- ggplot() +
  geom_point(data = all_soil, aes(x = wilt_pt, y = ave_nh3_vol), alpha=0.2, stroke=0) +
  theme_b_border()

grid.arrange(plot1, plot2, plot3, plot4, plot5, plot6, plot7, plot8, plot9, plot10, plot11, plot12, plot13, plot14, ncol=2)

```

## 7. Comparing soil properties of low leaching and adjacent normally leaching soils in west Iowa

```{r data_radar, include = FALSE, cache=TRUE, fig.width=11, fig.height=9, fig.cap="Figure 12: Soil parameters, nitrate leaching and ammonia volatilization (values are normalized and range between 0 and 1 for all variables), for six map units manually selected from Woodbury county. Three map units show very low leaching, the other three show very high leaching values."}

soils <- tbl(db_con, "05_woodbury_soils_contrast") %>%
   as.data.frame()

soils %>%
  select(mukey, bulk_dens, ph, awc, clay_frac,sand_frac, ksat, om, soc, porosity, fld_capacity, wilt_pt, avg_leach_mukey, avg_vol_mukey, csr2_nrcs) %>%
  mutate(leach_cat = ifelse(avg_leach_mukey < 0.1, 0.1, 0.2)) %>%  # the categories are selected arbitrarily, but need to be numeric and < 1
  mutate_if(is.character, as.numeric) %>%
  mutate_each(funs(rescale), -mukey, -leach_cat) -> soils_radar

soils_radar %>%
  filter(leach_cat == 0.1) %>%
  select(-leach_cat) -> soils_low_leach

soils_radar %>%
  filter(leach_cat == 0.2) %>%
  select(-leach_cat) -> soils_high_leach

plot1 <- ggradar(soils_low_leach, plot.extent.x.sf = 2, plot.extent.y.sf = 1.2, axis.label.size = 5,
                 legend.text.size = 5, grid.label.size = 5) 

  
plot2 <- ggradar(soils_high_leach, plot.extent.x.sf = 2, plot.extent.y.sf = 1.2, axis.label.size = 5,
                 legend.text.size = 5, grid.label.size = 5) 

grid.arrange(plot1, plot2, ncol = 1)
```

```{r data_radar_2, cache=TRUE, fig.width=11, fig.height=9, fig.cap="Figure 12: Soil parameters as weighted averages for soils in Woodbury, Plymouth and Lyon County, leaching < 0.1 kg/ha and soils leaching > 20 kg/ha adjacent the low leaching soils. Values are normalized relative to the range of values for the three counties."}

soils <- tbl(db_con, "05_mukeys_select") %>%
   as.data.frame()

weighted.mean <- funs("weighted.mean", weighted.mean(.,muha))
wtd.var <- funs("wtd.var", wtd.var(.,muha))
fs <- c(weighted.mean, wtd.var)

soils %>%
  select(mukey, muha, bulk_dens, ph, awc, clay_frac,sand_frac, ksat, om, soc, porosity, fld_capacity, wilt_pt, ave_no3_leach, ave_nh3_vol, leach_category) %>%
  group_by(leach_category) %>%
  summarize_each(funs_(fs), -mukey, -muha) -> soil_stats_abs  # calculate weighted stats



soils %>%
  select(mukey, muha, bulk_dens, ph, awc, clay_frac,sand_frac, ksat, om, soc, porosity, fld_capacity, wilt_pt, ave_no3_leach, ave_nh3_vol, leach_category) %>%
  mutate_each(funs(rescale), -mukey, -muha, -leach_category) %>%  # normalize data
  group_by(leach_category) %>%
  summarize_each(funs_(fs), -mukey, -muha) -> soil_stats_norm  # calculate weighted stats

soil_contrast <- soil_stats_norm[1:2,1:12]

ggradar(soil_contrast, plot.extent.x.sf = 2, plot.extent.y.sf = 1.2, axis.label.size = 5,
                 legend.text.size = 5, grid.label.size = 5, axis.labels = c("bulk dens.", "pH", "AWC", "clay frac.", "sand frac.", "Ksat", "OM", "SOC", "porosity", "field cap.", "wilt pt."))
  
```


```{r barplot_abs, fig.cap = "Figure 13: Nitrate leaching, ammonium volatilization, and soil parameters as weighted averages for soils in Woodbury, Plymouth and Lyon County, leaching < 0.1 kg/ha (low) and soils leaching > 20 kg/ha adjacent the low leaching soils (norm)."}
soil_stats_abs[1:2,] %>%
  mutate(bulk_dens_wtd.stdv = sqrt(bulk_dens_wtd.var), ph_wtd.stdv = sqrt(ph_wtd.var), awc_wtd.stdv = sqrt(awc_wtd.var), clay_frac_wtd.stdv  = sqrt(clay_frac_wtd.var), sand_frac_wtd.stdv = sqrt(sand_frac_wtd.var), ksat_wtd.stdv = sqrt(ksat_wtd.var), om_wtd.stdv = sqrt(om_wtd.var), soc_wtd.stdv = sqrt(soc_wtd.var), porosity_wtd.stdv = sqrt(porosity_wtd.var), fld_capacity_wtd.stdv = sqrt(porosity_wtd.var), wilt_pt_wtd.stdv = sqrt(wilt_pt_wtd.var), ave_no3_leach_wtd.stdv = sqrt(ave_no3_leach_wtd.var), ave_nh3_vol_wtd.stdv = sqrt(ave_nh3_vol_wtd.var)) -> soil_stats_abs

soil_stats_abs[,1:14] %>%
  rename(bulk_dens = bulk_dens_weighted.mean, ph = ph_weighted.mean, awc = awc_weighted.mean, clay_frac = clay_frac_weighted.mean, sand_frac = sand_frac_weighted.mean, ksat = ksat_weighted.mean,om = om_weighted.mean, soc = soc_weighted.mean, porosity = porosity_weighted.mean, fld_capacity = fld_capacity_weighted.mean, wilt_pt = wilt_pt_weighted.mean, ave_no3_leach = ave_no3_leach_weighted.mean, ave_nh3_vol = ave_nh3_vol_weighted.mean) %>%
  gather(bulk_dens, ph, awc, clay_frac, sand_frac, ksat, om, soc, porosity, fld_capacity, wilt_pt, ave_no3_leach, ave_nh3_vol, key = property, value = means) -> soil_abs_means
soil_abs_means$id <- seq_along(soil_abs_means$property)

soil_stats_abs[,c(1,28:40)] %>%
  rename(bulk_dens = bulk_dens_wtd.stdv, ph = ph_wtd.stdv, awc = awc_wtd.stdv, clay_frac = clay_frac_wtd.stdv, sand_frac = sand_frac_wtd.stdv, ksat = ksat_wtd.stdv, om = om_wtd.stdv, soc = soc_wtd.stdv, porosity = porosity_wtd.stdv, fld_capacity = fld_capacity_wtd.stdv, wilt_pt = wilt_pt_wtd.stdv, ave_no3_leach = ave_no3_leach_wtd.stdv, ave_nh3_vol = ave_nh3_vol_wtd.stdv) %>%
  gather(bulk_dens, ph, awc, clay_frac, sand_frac, ksat, om, soc, porosity, fld_capacity, wilt_pt, ave_no3_leach, ave_nh3_vol, key = property, value = sd)  -> soil_abs_sd
soil_abs_sd$id <- seq_along(soil_abs_sd$property)

soil_abs_means %>%
  left_join(soil_abs_sd[,3:4], by = "id") -> soil_stats_abs_aggr

ggplot(soil_stats_abs_aggr, aes(x = property, y = means, fill = leach_category)) +
  geom_bar(position = position_dodge(.9), color = "black", stat="identity") +
  geom_errorbar(position=position_dodge(.9), width=.25, aes(ymin=means, ymax=means+sd)) +
  theme_b_border() +
  theme(axis.text.x  = element_text(angle=90, vjust=0.5, size=12))
```



```{r barplot_norm, fig.cap = "Figure 14: Nitrate leaching, ammonium volatilization, and soil parameters as weighted averages for soils in Woodbury, Plymouth and Lyon County, leaching < 0.1 kg/ha (low) and soils leaching > 20 kg/ha adjacent the low leaching soils (norm). Values are normalized relative to the range of values for the three counties."}
soil_stats_norm[1:2,] %>%
  mutate(bulk_dens_wtd.stdv = sqrt(bulk_dens_wtd.var), ph_wtd.stdv = sqrt(ph_wtd.var), awc_wtd.stdv = sqrt(awc_wtd.var), clay_frac_wtd.stdv  = sqrt(clay_frac_wtd.var), sand_frac_wtd.stdv = sqrt(sand_frac_wtd.var), ksat_wtd.stdv = sqrt(ksat_wtd.var), om_wtd.stdv = sqrt(om_wtd.var), soc_wtd.stdv = sqrt(soc_wtd.var), porosity_wtd.stdv = sqrt(porosity_wtd.var), fld_capacity_wtd.stdv = sqrt(porosity_wtd.var), wilt_pt_wtd.stdv = sqrt(wilt_pt_wtd.var), ave_no3_leach_wtd.stdv = sqrt(ave_no3_leach_wtd.var), ave_nh3_vol_wtd.stdv = sqrt(ave_nh3_vol_wtd.var)) -> soil_stats_norm

soil_stats_norm[,1:14] %>%
  rename(bulk_dens = bulk_dens_weighted.mean, ph = ph_weighted.mean, awc = awc_weighted.mean, clay_frac = clay_frac_weighted.mean, sand_frac = sand_frac_weighted.mean, ksat = ksat_weighted.mean,om = om_weighted.mean, soc = soc_weighted.mean, porosity = porosity_weighted.mean, fld_capacity = fld_capacity_weighted.mean, wilt_pt = wilt_pt_weighted.mean, ave_no3_leach = ave_no3_leach_weighted.mean, ave_nh3_vol = ave_nh3_vol_weighted.mean) %>%
  gather(bulk_dens, ph, awc, clay_frac, sand_frac, ksat, om, soc, porosity, fld_capacity, wilt_pt, ave_no3_leach, ave_nh3_vol, key = property, value = means) -> soil_means
soil_means$id <- seq_along(soil_means$property)

soil_stats_norm[,c(1,28:40)] %>%
  rename(bulk_dens = bulk_dens_wtd.stdv, ph = ph_wtd.stdv, awc = awc_wtd.stdv, clay_frac = clay_frac_wtd.stdv, sand_frac = sand_frac_wtd.stdv, ksat = ksat_wtd.stdv, om = om_wtd.stdv, soc = soc_wtd.stdv, porosity = porosity_wtd.stdv, fld_capacity = fld_capacity_wtd.stdv, wilt_pt = wilt_pt_wtd.stdv, ave_no3_leach = ave_no3_leach_wtd.stdv, ave_nh3_vol = ave_nh3_vol_wtd.stdv) %>%
  gather(bulk_dens, ph, awc, clay_frac, sand_frac, ksat, om, soc, porosity, fld_capacity, wilt_pt, ave_no3_leach, ave_nh3_vol, key = property, value = sd)  -> soil_sd
soil_sd$id <- seq_along(soil_sd$property)

soil_means %>%
  left_join(soil_sd[,3:4], by = "id") -> soil_stats_aggr

ggplot(soil_stats_aggr, aes(x = property, y = means, fill = leach_category)) +
  geom_bar(position = position_dodge(.9), color = "black", stat="identity") +
  geom_errorbar(position=position_dodge(.9), width=.25, aes(ymin=means, ymax=means+sd)) +
  theme_b_border() +
  theme(axis.text.x  = element_text(angle=90, vjust=0.5, size=12))
```


```{r map_unit_examples_quintiles, include = FALSE, cache=TRUE, fig.width=9, fig.height=4, fig.cap="Figure 14: Soil parameters, nitrate leaching and ammonia volatilization (values are normalized and range between 0 and 1 for all variables), for five map units manually selected based on their average nitrate leaching value (near the minimum, 25. percentlie, 50. percentile, 75. percentile, and maximum). nitrate leaching and ammonia volatilization are area weighted averages across all subfield polygons in the map unit. All other variables are constant within each given map unit."}

ex_soils <- tbl(db_con, "05_iowa_soils_contrast") %>%
   as.data.frame()

ex_soils %>%
  select(mukey, bulk_dens, ph, awc, clay_frac,sand_frac, ksat, om, soc, porosity, fld_capacity, wilt_pt, avg_leach_mukey, avg_vol_mukey, iacornsr) %>%
  arrange(avg_leach_mukey) %>%
  mutate_if(is.character, as.numeric) %>%
  mutate_each(funs(rescale), -mukey) %>%
  gather(bulk_dens, ph, awc, clay_frac, sand_frac, ksat, om, soc, porosity, fld_capacity, wilt_pt, avg_leach_mukey, avg_vol_mukey, iacornsr, key = property, value = norm_value)  -> soils_multi
soils_multi$mukey <- factor(soils_multi$mukey, levels = c("411231", "410443", "406511", "408688", "403497"))

labels <- c('411231' = "minimum", '410443' = "25. percentile", '406511'= "50. percentile", '408688'= "75. percentile", '403497' = "maximum")


ggplot(soils_multi, aes(x=property, y = norm_value)) +
  geom_bar(position = "dodge", stat = "identity") +
  coord_flip() +
  facet_wrap(~mukey, ncol = 5, labeller = as_labeller(labels))

```

## 8. Effect of CSR2

```{r leach_csr2, fig.width=11, fig.height=4, fig.cap ="Figure 15: Nitrate leaching, ammonium volatilization and nitrous oxide flux plotted against CSR2."}
leach_csr2 <- tbl(db_con, "05_leaching_csr2") %>%
  as.data.frame() %>%
  mutate_if(is.character, as.numeric)

plot1 <- ggplot() +
  geom_point(data = leach_csr2, aes(x = iacornsr, y = avg_leach_mukey), alpha=0.2, stroke=0) +
  theme_b_border() 

plot2 <- ggplot() +
  geom_point(data = leach_csr2, aes(x = iacornsr, y = avg_vol_mukey), alpha=0.2, stroke=0) +
  theme_b_border() 

plot3 <- ggplot() +
  geom_point(data = leach_csr2, aes(x = iacornsr, y = avg_flux_mukey), alpha=0.2, stroke=0) +
  theme_b_border() 

grid.arrange(plot1, plot2, plot3, ncol = 3)
```

We could not detect and effect of the integrated soil quality index CSR2 on leaching or volatilization.

## 9. Daily changes in soil parameters that influence NH~3~ volatilization

Soil pH is not changing throughout the year. Fertilization happens once a year on DOY 101 (April 10) with anhydrous NH3. The below graphs compare two soil areas (mukeys) representing a low-leaching and a high-leaching soil that are adjacent to each other.

### Daily model outputs 2012

```{r daily_outputs_2012}

library(grid)

hi_vol_daily_2012 <- read.csv("./tables/high_nh3_vol_410333/DailyOut_2012_410333.csv") %>%
  mutate(vol = "hi")
lo_vol_daily_2012 <- read.csv("./tables/low_nh3_vol_410319/DailyOut_2012_410319.csv") %>%
  mutate(vol = "lo")

plot1 <- hi_vol_daily_2012 %>%
  bind_rows(lo_vol_daily_2012) %>%
  select(day, vol, soil_ph) %>%
ggplot() +
  geom_line(aes(x = day, y = soil_ph, group = vol, color = vol))

plot2 <- hi_vol_daily_2012 %>%
  bind_rows(lo_vol_daily_2012) %>%
  select(day, vol, wfps) %>%
ggplot() +
  geom_line(aes(x = day, y = wfps, group = vol, color = vol))

plot3 <- hi_vol_daily_2012 %>%
  bind_rows(lo_vol_daily_2012) %>%
  select(day, vol, precip) %>%
ggplot() +
  geom_line(aes(x = day, y = precip, group = vol, color = vol))

plot4 <- hi_vol_daily_2012 %>%
  bind_rows(lo_vol_daily_2012) %>%
  select(day, vol, soil_temp) %>%
ggplot() +
  geom_line(aes(x = day, y = soil_temp, group = vol, color = vol))

plot5 <- hi_vol_daily_2012 %>%
  bind_rows(lo_vol_daily_2012) %>%
  select(day, vol, nh3_vol) %>%
ggplot() +
  geom_line(aes(x = day, y = nh3_vol, group = vol, color = vol))

plot6 <- hi_vol_daily_2012 %>%
  bind_rows(lo_vol_daily_2012) %>%
  select(day, vol, no3_leach) %>%
ggplot() +
  geom_line(aes(x = day, y = no3_leach, group = vol, color = vol))

plot7 <- hi_vol_daily_2012 %>%
  bind_rows(lo_vol_daily_2012) %>%
  select(day, vol, h2o_leach) %>%
ggplot() +
  geom_line(aes(x = day, y = h2o_leach, group = vol, color = vol))

plot8 <- hi_vol_daily_2012 %>%
  bind_rows(lo_vol_daily_2012) %>%
  select(day, vol, soil_nh3) %>%
ggplot() +
  geom_line(aes(x = day, y = soil_nh3, group = vol, color = vol))

plot9 <- hi_vol_daily_2012 %>%
  bind_rows(lo_vol_daily_2012) %>%
  select(day, vol, n2o_flux) %>%
ggplot() +
  geom_line(aes(x = day, y = n2o_flux, group = vol, color = vol))


grid.newpage()
grid.draw(cbind(rbind(ggplotGrob(plot1), ggplotGrob(plot2), ggplotGrob(plot3), size = "last"), rbind(ggplotGrob(plot4), ggplotGrob(plot5), ggplotGrob(plot6), size = "last"), rbind(ggplotGrob(plot7), ggplotGrob(plot8), ggplotGrob(plot9), size = "last") ))
```

### Daily model outputs 2013

```{r daily_outputs_2013}


hi_vol_daily_2013 <- read.csv("./tables/high_nh3_vol_410333/DailyOut_2013_410333.csv") %>%
  mutate(vol = "hi")
lo_vol_daily_2013 <- read.csv("./tables/low_nh3_vol_410319/DailyOut_2013_410319.csv") %>%
  mutate(vol = "lo")

plot1 <- hi_vol_daily_2013 %>%
  bind_rows(lo_vol_daily_2013) %>%
  select(day, vol, soil_ph) %>%
ggplot() +
  geom_line(aes(x = day, y = soil_ph, group = vol, color = vol))

plot2 <- hi_vol_daily_2013 %>%
  bind_rows(lo_vol_daily_2013) %>%
  select(day, vol, wfps) %>%
ggplot() +
  geom_line(aes(x = day, y = wfps, group = vol, color = vol))

plot3 <- hi_vol_daily_2013 %>%
  bind_rows(lo_vol_daily_2013) %>%
  select(day, vol, precip) %>%
ggplot() +
  geom_line(aes(x = day, y = precip, group = vol, color = vol))

plot4 <- hi_vol_daily_2013 %>%
  bind_rows(lo_vol_daily_2013) %>%
  select(day, vol, soil_temp) %>%
ggplot() +
  geom_line(aes(x = day, y = soil_temp, group = vol, color = vol))

plot5 <- hi_vol_daily_2013 %>%
  bind_rows(lo_vol_daily_2013) %>%
  select(day, vol, nh3_vol) %>%
ggplot() +
  geom_line(aes(x = day, y = nh3_vol, group = vol, color = vol))

plot6 <- hi_vol_daily_2013 %>%
  bind_rows(lo_vol_daily_2013) %>%
  select(day, vol, no3_leach) %>%
ggplot() +
  geom_line(aes(x = day, y = no3_leach, group = vol, color = vol))

plot7 <- hi_vol_daily_2013 %>%
  bind_rows(lo_vol_daily_2013) %>%
  select(day, vol, h2o_leach) %>%
ggplot() +
  geom_line(aes(x = day, y = h2o_leach, group = vol, color = vol))

plot8 <- hi_vol_daily_2013 %>%
  bind_rows(lo_vol_daily_2013) %>%
  select(day, vol, soil_nh3) %>%
ggplot() +
  geom_line(aes(x = day, y = soil_nh3, group = vol, color = vol))

plot9 <- hi_vol_daily_2012 %>%
  bind_rows(lo_vol_daily_2012) %>%
  select(day, vol, n2o_flux) %>%
ggplot() +
  geom_line(aes(x = day, y = n2o_flux, group = vol, color = vol))


grid.newpage()
grid.draw(cbind(rbind(ggplotGrob(plot1), ggplotGrob(plot2), ggplotGrob(plot3), size = "last"), rbind(ggplotGrob(plot4), ggplotGrob(plot5), ggplotGrob(plot6), size = "last"), rbind(ggplotGrob(plot7), ggplotGrob(plot8), ggplotGrob(plot9), size = "last") ))
```

### Daily model outputs 2014

```{r daily_outputs_2014}


hi_vol_daily_2014 <- read.csv("./tables/high_nh3_vol_410333/DailyOut_2014_410333.csv") %>%
  mutate(vol = "hi")
lo_vol_daily_2014 <- read.csv("./tables/low_nh3_vol_410319/DailyOut_2014_410319.csv") %>%
  mutate(vol = "lo")


plot1 <- hi_vol_daily_2014 %>%
  bind_rows(lo_vol_daily_2014) %>%
  select(day, vol, soil_ph) %>%
ggplot() +
  geom_line(aes(x = day, y = soil_ph, group = vol, color = vol))

plot2 <- hi_vol_daily_2014 %>%
  bind_rows(lo_vol_daily_2014) %>%
  select(day, vol, wfps) %>%
ggplot() +
  geom_line(aes(x = day, y = wfps, group = vol, color = vol))

plot3 <- hi_vol_daily_2014 %>%
  bind_rows(lo_vol_daily_2014) %>%
  select(day, vol, precip) %>%
ggplot() +
  geom_line(aes(x = day, y = precip, group = vol, color = vol))

plot4 <- hi_vol_daily_2014 %>%
  bind_rows(lo_vol_daily_2014) %>%
  select(day, vol, soil_temp) %>%
ggplot() +
  geom_line(aes(x = day, y = soil_temp, group = vol, color = vol))

plot5 <- hi_vol_daily_2014 %>%
  bind_rows(lo_vol_daily_2014) %>%
  select(day, vol, nh3_vol) %>%
ggplot() +
  geom_line(aes(x = day, y = nh3_vol, group = vol, color = vol))

plot6 <- hi_vol_daily_2014 %>%
  bind_rows(lo_vol_daily_2014) %>%
  select(day, vol, no3_leach) %>%
ggplot() +
  geom_line(aes(x = day, y = no3_leach, group = vol, color = vol))

plot7 <- hi_vol_daily_2014 %>%
  bind_rows(lo_vol_daily_2014) %>%
  select(day, vol, h2o_leach) %>%
ggplot() +
  geom_line(aes(x = day, y = h2o_leach, group = vol, color = vol))

plot8 <- hi_vol_daily_2014 %>%
  bind_rows(lo_vol_daily_2014) %>%
  select(day, vol, soil_nh3) %>%
ggplot() +
  geom_line(aes(x = day, y = soil_nh3, group = vol, color = vol))


plot9 <- hi_vol_daily_2014 %>%
  bind_rows(lo_vol_daily_2014) %>%
  select(day, vol, n2o_flux) %>%
ggplot() +
  geom_line(aes(x = day, y = n2o_flux, group = vol, color = vol))


grid.newpage()
grid.draw(cbind(rbind(ggplotGrob(plot1), ggplotGrob(plot2), ggplotGrob(plot3), size = "last"), rbind(ggplotGrob(plot4), ggplotGrob(plot5), ggplotGrob(plot6), size = "last"), rbind(ggplotGrob(plot7), ggplotGrob(plot8), ggplotGrob(plot9), size = "last") ))
```


### Daily model outputs 2015

```{r daily_outputs_2015}


hi_vol_daily_2015 <- read.csv("./tables/high_nh3_vol_410333/DailyOut_2015_410333.csv") %>%
  mutate(vol = "hi")
lo_vol_daily_2015 <- read.csv("./tables/low_nh3_vol_410319/DailyOut_2015_410319.csv") %>%
  mutate(vol = "lo")

plot1 <- hi_vol_daily_2015 %>%
  bind_rows(lo_vol_daily_2015) %>%
  select(day, vol, soil_ph) %>%
ggplot() +
  geom_line(aes(x = day, y = soil_ph, group = vol, color = vol))

plot2 <- hi_vol_daily_2015 %>%
  bind_rows(lo_vol_daily_2015) %>%
  select(day, vol, wfps) %>%
ggplot() +
  geom_line(aes(x = day, y = wfps, group = vol, color = vol))

plot3 <- hi_vol_daily_2015 %>%
  bind_rows(lo_vol_daily_2015) %>%
  select(day, vol, precip) %>%
ggplot() +
  geom_line(aes(x = day, y = precip, group = vol, color = vol))

plot4 <- hi_vol_daily_2015 %>%
  bind_rows(lo_vol_daily_2015) %>%
  select(day, vol, soil_temp) %>%
ggplot() +
  geom_line(aes(x = day, y = soil_temp, group = vol, color = vol))

plot5 <- hi_vol_daily_2015 %>%
  bind_rows(lo_vol_daily_2015) %>%
  select(day, vol, nh3_vol) %>%
ggplot() +
  geom_line(aes(x = day, y = nh3_vol, group = vol, color = vol))

plot6 <- hi_vol_daily_2015 %>%
  bind_rows(lo_vol_daily_2015) %>%
  select(day, vol, no3_leach) %>%
ggplot() +
  geom_line(aes(x = day, y = no3_leach, group = vol, color = vol))

plot7 <- hi_vol_daily_2015 %>%
  bind_rows(lo_vol_daily_2015) %>%
  select(day, vol, h2o_leach) %>%
ggplot() +
  geom_line(aes(x = day, y = h2o_leach, group = vol, color = vol))

plot8 <- hi_vol_daily_2015 %>%
  bind_rows(lo_vol_daily_2015) %>%
  select(day, vol, soil_nh3) %>%
ggplot() +
  geom_line(aes(x = day, y = soil_nh3, group = vol, color = vol))

plot9 <- hi_vol_daily_2015 %>%
  bind_rows(lo_vol_daily_2015) %>%
  select(day, vol, n2o_flux) %>%
ggplot() +
  geom_line(aes(x = day, y = n2o_flux, group = vol, color = vol))


grid.newpage()
grid.draw(cbind(rbind(ggplotGrob(plot1), ggplotGrob(plot2), ggplotGrob(plot3), size = "last"), rbind(ggplotGrob(plot4), ggplotGrob(plot5), ggplotGrob(plot6), size = "last"), rbind(ggplotGrob(plot7), ggplotGrob(plot8), ggplotGrob(plot9), size = "last") ))
```

```{r shut, message=FALSE, include=FALSE}
 rm(list='db_con'); gc() 
```
