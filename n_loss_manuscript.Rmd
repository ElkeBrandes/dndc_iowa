---
title: Addressing farm economy, water quality, and bioenergy feedstock production by sub-field switchgrass integration on unprofitable cropland
author: "Elke Brandes"
date: "Friday, January 20, 2017"
output:
  word_document: default

bibliography: nutrient_bibliography.bib
---
```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning = FALSE)

```

## Abstract


Progress on reducing nutrient leaching from Iowa cropland has been slow due to conflicts between short-term profitability and long-term land stewardship. Besides mitigating nitrate leaching from cropland, perennial biomass crops such as switchgrass improve short- and long-term farm level profitability and help meeting national bioenergy targets.

To explore the potential of a socially compatible switchgrass integration into Iowa's agricultural landscape, we combined two subfield-scale data sets: (i) a profitability analysis and (ii) nitrate leaching rates estimated with the DeNitrification-DeComposition (DNDC) model. We based the management change decision from row crops to switchgrass on status-quo (2012-2015) profitability and N leaching rates, creating a matrix of possible threshold combinations. For each scenario resulting from these combinations we calculated state-wide % area in switchgrass, biomass production, and relative N leaching reduction.

Switchgrass yields had a negligible effect on N leaching reduction within the range of reasonable conversion areas (<20% of cropland). Converting all subfield areas losing > US$ 150 ha^-1^ yr^1^ and leaching > 60 kg N ha^-1^ yr^-1^ to switchgrass ("tweak-scenario") would result in 14% N leaching reduction for Iowa. We found that the counties of highest status-quo N leaching don't line up with those of highest reduction potential. E.g., within the impaired Upper Racoon River Watershed, the tweak-scenario resulted in 11.2% of row cropland converted to switchgrass and an N leaching reduction of 8%. Most subfield areas converted to switchgrass displayed high N leaching reduction (> 50%), but the high productivity of most farmland in this watershed resulted in a relatively small conversion area and therefore a low mean N leaching reduction. 

Our analysis disaggregates previous approaches of county- or watershed-scale N balance down to a finer resolution and takes into account the biogeochemical processes driving N loss in agroecosystems. Even though approximated, our analysis can be turned into a farm-level decision making tool to identify non-linear responses of N leaching reduction to perennial integration.

- In a three way comparison we analyse the impact of cropland conversion to a dedicated biomass crop on nutrient loss improvement
- We modelled the leachable N fraction for agricultural lands in the state of Iowa
- using high-resolution spatial data to test ecosystem service outcomes of a socio-economic approach of perennial biomass crop integration

## Introduction

### Harnessing economic interests for switchgrass integration

- pooled under the term precision conservation, efforts have been made recently to develop landscape designs that meet agricultural needs while optimizing environmental risk mitigation by targeted placement of conservation management practices [@mcconnell2011precision]

- this approach can potentially be adapted to target perennial crops for sustainable cellulosic bioenergy production [@chaubey2016precision]

- due to their multiple benefits on water and soil quality, perennial biomass crops have been considered suitable for conservation purposes while providing feedstock for a growing bioeconomy [@tilman2009beneficial; @langholtz2016billion]

- in practice, socio-economic barriers prevent the implementation of urgently needed conservation management [@james2010profitability]

- thus, a trade off exists between economic and environmental desires and needs to be addressed when assessing the feasibility of sustainable bioenergy feedstock production

- however, there are indications of synergies between economic and environmental risk mitigation: within a single corn field, @ssegane2015multifunctional showed that areas of low crop yield coincided with high NO~3~^-^ leaching due to low soil fertility related to high water infiltration.

### Water quality as the ecosystem service of interest

- nitrate, the nitrogen species that is readily available to crops, is also subject to leaching through the root zone and drainage tiles into surface waters

- non-point nutrient pollution from industrialized agriculture in the Mississippi River Basin has been exacerbating the hypoxic zone in the Gulf of Mexico [@turner2003linking]

- over half of the nitrogen delivered to the Gulf of Mexico from the Mississippi River Basin originate from cropland cultivated with maize and soybeans [@alexander2008differences]

- @schilling2000relationship showed a strong relationship between percent land area in row crop and nitrate-N concentration in watersheds in Iowa. Their study suggests a 0.1 mg l^-1^ reduction of nitrate N in the surface water with every percent reduction of row crop area in the above watershed

- as a quantitative goal to mitigate these water quality issues, the Nutrient reduction task force stipulated that a 30% reduction in the nitrogen load is needed to shrink the hypoxic zone to under 5000 km^2^ [@river2001action]

- in Iowa: 41% N reduction proposed by INRS (cite Iowa Nutrient Reduction Strategy)

The Iowa Nutrient Reduction Strategy recommends a wide range of nitrogen reduction practices including perennial crops, but does not account for the spatial heterogeneity within Major Land Resource Areas.

- Perennial crops have shown to reduce N leaching drastically compared to maize [@smith2013reduced; @randall1997nitrate] (alfalfa and CRP))

- however, large uncertainties exist about the extent and strategic location of perennials in the agricultural landscape that would be effective to reach such goal

- @vanloocke2016din found that replacing maize currently grown for bioethanol with cellulosic biomass crops in the Atchafalaya and Mississippi River Basin could reduce dissolved inorganic nitrogen (DIN) export to the Gulf of Mexico by 15 to 20%. They suggest that integration of perennial grasses targeted to areas of low row crop productivity and high leaching rates could further increase surface water quality.

- not only environmental considerations play a role in strategic placement of perennial crops, but also economic constraints. Areas of high environmental risk are assumed to overlap with areas of high economic risk - targeting those areas may provide opportunities to combine financial risk mitigation with conservation management.

- therefore we argue that targeted replacement of row crops with the highly productive and locally adapted switchgrass variety "Liberty" could contribute to a reduction of N loss in Iowa

- as an example for an impaired watershed, the North Racoon River Watershed, where counties are sued by the Des Moines Water Works for not complying with water quality regulations (CITE), is in focus in this paper to shed light on potential mitigation effords and their effectiveness 

### Nitrogen mass balance

- state wide nutrient budget analyses showed a balance between N inputs and outputs, but strong effects of crop type (continuous maize or maize-soybean rotation) and fertilization rate exist [@libra2004nitrogen].

- as part of a nutrient budget for Iowa, NO~3~^-^ was estimated from fertilizer inputs [@christianson2012nitrogen]. There approach did not take into account weather and soil related variability.

- in order to estimate the potential of DIN loss reduction by switchgrass integration in a spatial resolution relevant for decision makers, we apply a mechanistic model that accounts for weather and soil condition dependent processes of the nitrogen cycle.

### Goals of this study:

- here, we are presenting a novel approach to precision conservation and perennial integration: Placing switchgrass (a high yielding variety of a native grass showcasing favourable ecologic and economic properties) on crop land that is least socially desirable to grow row crops, simulating different opimization scenarios:
    + minimum (tweak) scenario: mitigating profit and DIN loss
    + achieving a biomass production threshold from dedicated bioenergy crops *(how much? Using figure 3 to identify possible threshold combinations)*
    + *anything else?*

Goals: 

1. Identifying areas in Iowa with highest potential for switchgrass integration that is compatible with socio-economic constraints
2. Quantify the extent of DIN (dissolved inorganic nitrogen) loss reduction by managing cropland areas that are at highest economic and environmental risk in switchgrass

3. Exploring one of many opportunities to improve management of subfield areas that are not profitable with high-input row crop management

## Methods

Using publicly available data, we identified subfield cropland areas of low profitability. We estimated nitrate leaching with the processed-based DeNitrifiction-DeComposition model (DNDC) for a baseline (cropland in maize and soybean in 2012-2015) and three switchgrass scenarios of varying biomass yields. We tested the sensitivity of different model outcomes for Iowa (% area in switchgrass, total biomass production, and relative N leaching reduction) for the management change decision points for N leaching and profitability.

- subfield profitability analysis as described in detail in Brandes et al 2016
- updated to the time frame 2012-2015 (four years)
- only including fields that were in maize and/or soybean in all four years
- using publicly available data to calculate profitability
- model nitrogen mass balance in the agroecosystem with DNDC

### DNDC model description

- process-based biogeochemistry model for agricultural systems
- structured into 6 submodels
- temporal resolution: day
- data used: *to be completed with information from Gabe*
    + climate data
    + soil data
    + land use and management
    + crop parameters
    + model was not calibrated for NH~3~ and NO~3~^-^: Relative changes with switchgrass integration were calculated, rather than absolute DIN loss values *should I show total values for Iowa at all?*
- *describe relevant model processes*
- scenarios: status quo (continuous maize or maize-soybean rotation), switchgrass with three yield assumptions (high, medium, low)
- model evaluation?

- focus on model outputs for dissolved inorganic nitrogen (DIN)
- to avoid artefacts resulting from the model mechanisms, we do not distinguish between N leaving the soil in the form of NO~3~^-^ leaching and NH~3~^+^ volatilitzation, by making the following assumptions/simplifications:
    + N is properly applied in form of anhydrous ammonia or N solution (the most commonly used forms of N fertilizer by Iowa farmers [@ifrlp2014]
    + the present study is not taking into account manure application
    + volatilization can be neglected if assuming proper N fertilizer application and not taking into account manure application [@jaynes2008sustaining]
    + *alternatively: assuming 1.9% of N applied as fertilizer is lost by Nh~3~ volatilization (average of reported rates in studies reviewed by @christianson2012nitrogen) and deduct these rates from the sum of modelled NO~3~^-^ leaching and NH~3~^+^ volatilization*

- management decisions: switchgrass integration on a sliding threshold scale of profitability and N loss
- one example scenario selected: profit of < -150 US$/ha, DIN loss of > 60 kg N/ha, swg yield: 10,000 kg/ha
- at that conversion scale (approx. 10% of cropland converted to switchgrass), switchgrass yields have a very small effect on N loss reduction outcomes
- calculate N loss changes per subfield area and aggregated to the county level / selected watershed of public interest
- *other scenarions? (see comments above)*

## Results

- *what weather data is used for the DNDC simulations? Should we show weather data and the annual response in N loss?*

- Mean profitability shows spatial heterogeneity accross Iowa, with highest total area losing > US$ 150 ha^-1^ in west central Iowa and highest relative area in the west central and south part of the state (Figure 1)

- Surface plots and contour plots show the resulting area in switchgrass for Iowa, with varying combined thresholds of profitability and N loss (including cropland below a cut-off profitability and above a cut-off N loss) (Figure 2, 3)

- selected criteria for conversion to switchgrass: mean profitability < US$ -150 ha^-1^, N loss > 60 kg ha^-1^
- *this could be presented as the minimum or "tweak" scenario. I could add other scenarios, e.g. that aim at a biomass number*

- at a threshold of US\$ -150 ha^-1^ profitability and 60 kg ha^-1^ N loss, approx. 10 % of current row cropland would be converted to switchgrass, a shift of the profitability threshold to US\$ 0 ha^-1^ would result in 23 % (Figure 3)

- State-wide mean annual N loss (status quo, 2012-2015) amounted to 0.57 million metric tonnes. On the state-wide average, converting all areas with profitability below US$ -150 ha^-1^ and with N losses of > 60 kg ha^-1^ to switchgrass would result in a 13.5, 14.3, and 14.7 % reduction of N loss for the low, medium, and high yielding scenario (Table 1) *should I show absolute numbers at all?*

- the spatial pattern of N loss in Iowa shows highest N losses in the counties on the Des Moines Lobe and in the north east of the state (Figure 4)

- according to the model presented here, highest N loss reduction with the switchgrass integration scenario can be achieved in the western counties along the Missouri and some of the central and eastern counties (Figure 5). The counties of highest N losses in the status quo don't line up with those of highest reduction potential.

- the subfield resolution map of N loss reduction (Figure 6) illustrates the spatial heterogeneity of the environmental outcomes of the biomass crop integration. 

- Strong "county effects" seem to drive the highest reduction values (Figure 6(c)). Some counties with very high conversion areas (Figure 1) and therefore high potential N loss reduction (Figure 4, 5), e.g., Monona, Carroll, and Hamilton County, both show a low yield/cash rent ratio (data not shown).

- zooming in on a select impaired watershed in Iowa: Pattern of switchgrass fields vary, some regions, whole fields are converted, in other, subfield areas are patchy and more fragmented (Figure 6(a),(b)). In the North Racoon River Watershed, an areas of high row crop percentage, the conversion scenario (converting cropland that loses > US$ 150 and > 60 kg N ha^-1^ to switchgrass) would result in 11.2 % of row crops converted to switchgrass and an N loss reduction of 8 %. Most subfield areas converted to switchgrass display N loss reduction of over 50%, but the relative small conversion area (due to relative high profitability in this watershed) produces a low mean N loss reduction.


```{r packages}
library('RPostgreSQL') # PostgreSQL database connection
library("ggplot2") # for the figures
library("maps") # to plot maps, contains country/state/county outlines
library("gridGraphics") # needed for the function unit in ggplot
library("tidyverse") # to make tidy tables, includes dplyr needed for PostgreSQL database connection
library('knitr') # to use kable() function

library(rgdal) # to read in shape files
library(ggmap)
library(scales)
library(RColorBrewer)
library("sp") # to use merge with a spatial data frame

library("tmap")

library(png) # to read png files
library(grid) # to display png files
library("plot3D") # for surface plot

library('matrixStats')

```

```{r connect_dplyr}

# with dplyr:
pw <- "xxx" # enter password here

isuag_db <- src_postgres(dbname = 'isuag',
                           host = 'isu-ag-db.agsolver.com',
                           port = 5432,
                           user = 'isuag',
                           password = pw)

```

```{r, connect_rpostgres}

# With RPostgreSQL:
drv <- dbDriver("PostgreSQL") # loads the PostgreSQL driver
con <- dbConnect(drv, dbname = "isuag",  # creates a connection to the postgres database
                 host = "isu-ag-db.agsolver.com", port = 5432,
                 user = "isuag", password = pw)
# note that "con" will be used later in each connection to the database
```

```{r theme, cache=TRUE}
# I am using a modified theme for ggplot that has a black border and white background:
theme_b_border <- function (base_size = 12, base_family = "") 
{
  theme_grey(base_size = base_size, base_family = base_family) %+replace% 
    theme(
      axis.text = element_text(size = rel(0.8), margin = margin(r=10)), #margin 
      axis.ticks = element_line(colour = "black"),
      axis.ticks.length = unit(0.15, "cm"),
      legend.key = element_rect(colour = NA), panel.background = element_rect(fill = "white", 
      colour = NA), panel.border = element_rect(fill = NA, 
      colour = "black"), panel.grid.major = element_line(colour = NA, 
      size = 0.2), panel.grid.minor = element_line(colour = NA, 
      size = 0.5), strip.background = element_rect(fill = "grey80", 
      colour = "grey50", size = 0.2))
}

# I am using a modified filled contour plot function for the figure that shows switchgrass area as a function of cut off values:

filled.contour3 <-
  function (x = seq(0, 1, length.out = nrow(z)),
            y = seq(0, 1, length.out = ncol(z)), z, xlim = range(x, finite = TRUE), 
            ylim = range(y, finite = TRUE), zlim = range(z, finite = TRUE), 
            levels = pretty(zlim, nlevels), nlevels = 20, color.palette = cm.colors, 
            col = color.palette(length(levels) - 1), plot.title, plot.axes, 
            key.title, key.axes, asp = NA, xaxs = "i", yaxs = "i", las = 1, 
            axes = TRUE, frame.plot = axes,mar, ...) 
{
  # modification by Ian Taylor of the filled.contour function
  # to remove the key and facilitate overplotting with contour()
  # further modified by Carey McGilliard and Bridget Ferris
  # to allow multiple plots on one page

  if (missing(z)) {
    if (!missing(x)) {
      if (is.list(x)) {
        z <- x$z
        y <- x$y
        x <- x$x
      }
      else {
        z <- x
        x <- seq.int(0, 1, length.out = nrow(z))
      }
    }
    else stop("no 'z' matrix specified")
  }
  else if (is.list(x)) {
    y <- x$y
    x <- x$x
  }
  if (any(diff(x) <= 0) || any(diff(y) <= 0)) 
    stop("increasing 'x' and 'y' values expected")
 # mar.orig <- (par.orig <- par(c("mar", "las", "mfrow")))$mar
 # on.exit(par(par.orig))
 # w <- (3 + mar.orig[2]) * par("csi") * 2.54
 # par(las = las)
 # mar <- mar.orig
 plot.new()
 # par(mar=mar)
  plot.window(xlim, ylim, "", xaxs = xaxs, yaxs = yaxs, asp = asp)
  if (!is.matrix(z) || nrow(z) <= 1 || ncol(z) <= 1) 
    stop("no proper 'z' matrix specified")
  if (!is.double(z)) 
    storage.mode(z) <- "double"
    # modified from the original code: changed from .Internal(filledcontour(...)) to:
  .filled.contour(as.double(x), as.double(y), z, as.double(levels), 
                          col = col)
  if (missing(plot.axes)) {
    if (axes) {
      title(main = "", xlab = "", ylab = "")
      Axis(x, side = 1)
      Axis(y, side = 2)
    }
  }
  else plot.axes
  if (frame.plot) 
    box()
  if (missing(plot.title)) 
    title(...)
  else plot.title
  invisible()
}
```



```{r profit_spatial, cache=TRUE, include= FALSE}
counties <- readOGR(dsn="shapefiles/county.shp",layer="county")
names(counties)[9] <- "fips" 

profit_county <- tbl(isuag_db, "07_swg_area_counties_po") %>%
  as.data.frame() 

 for (i in 1:length(profit_county$fips)) {
   profit_county$fips[i] <- sub("IA", "19", profit_county$fips[i])
    }

counties@data <- left_join(counties@data, profit_county, by = "fips")
counties_df <- fortify(counties)
counties$id <- row.names(counties) 
counties_profit_df <- left_join(counties_df, counties@data)

# add a spatial data frame with the county centroids, to be used to plot the total leaching N per county:
centroids <- getSpPPolygonsLabptSlots(counties) %>%
  as.data.frame() 

centroids$id <- as.character(0:98)

# join the total N leaching data to the centroids 
counties_profit_df <- left_join(counties_profit_df, centroids)

# create a theme without axes:
ditch_the_axes <- theme(
  axis.text = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank()
  )
```

```{r figure_profit, fig.height=3.5, fig.width=8,  fig.cap="Figure 1: Areas below a mean 2012-2015 profitability of US$ -150 ha^-1^ per county. Purple shades indicate the relative area, orange circles show the absolute size of the area per county."}
ggplot() +
  geom_polygon(data = counties_profit_df, aes(long, lat, group = group, fill=area_in_swg_perc), color = "white") +
  geom_point(data = counties_profit_df, aes(V1, V2, size = area_in_swg), color = "orange") +
  labs(size = expression(Total~area~below~-150~"US$"~ha^{-1}~(ha))) +
  coord_equal() +
  ditch_the_axes +
  labs(fill = expression(Relative~area~below~-150~"US$"~ha^{-1}~("%"))) +
  scale_fill_gradient(low = "white", high="dark blue", guide = "colourbar") 
```

```{r swg_areas_two_thresholds, cache=TRUE}
# In this chunk, the areas in switchgrass are calculated for all possible combinations of 
# profitability and N loss cut offs.

# swg_areas <- vector(mode="numeric", length=0)
profit_cutoffs_16 <- c(-800, -700, -600, -500, -400, -300, -200, -100, 0, 100, 200, 300, 400, 500, 600, 700)
n_loss_cutoffs_16 <- c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 110, 120, 130, 140, 150)

# make a cartesian product of the two vectors first:
# function (from https://www.r-bloggers.com/nested-loops-with-mapply/)
CartProduct = function(vector_1, vector_2)
{
 
  if (length(dim(vector_2)) != 0 )
  {
    warning("New vector has more than one dimension.")
    return (NULL)
  }
 
  if (length(dim(vector_1)) == 0)
  {
    CurrentRows = length(vector_1)
    vector_1 = as.matrix(vector_1, nrow = CurrentRows, ncol = 1)
  } else {
    CurrentRows = nrow(vector_1)
  }
 
  var1 = replicate(length(vector_2), vector_1, simplify=F)
  var1 = do.call("rbind", var1)
 
  var2 = rep(vector_2, CurrentRows)
  var2 = matrix(var2[order(var2)], nrow = length(var2), ncol = 1)
 
  CartProduct = cbind(var1, var2)
  return (CartProduct)
}

comb <- CartProduct(profit_cutoffs_16, n_loss_cutoffs_16)

# write a function that uses each of the combinations, using the matrix returned from the function CartProduct:
area_select <- function(cutoff_1, cutoff_2)
{ query <- paste("SELECT SUM(clumuha) FROM \"05_dndc_clumu_cgsb_swg_n_loss\" WHERE mean_profit_ha < ", as.character(cutoff_1), "AND ave_n_loss_ha_cgsb > ", as.character(cutoff_2))
    sum_area <- tbl(isuag_db, sql(query)) %>%
      as.data.frame()
    sum_area <- sum_area[1,1]
    return(sum_area)
}

# apply the function to each value in the matrix
swg_areas <- mapply(area_select, comb[,1], comb[,2])


# combine the cut off values with the area in switchgrass in a data frame
swg_areas <- data.frame(profit = comb[,1],
                        n_loss = comb[,2],
                        swg_areas)

```

```{r n_loss_function, cache=TRUE}

# write a function that uses each of the cutt off combinations and calculates the total N loss in this scenario:
n_loss_select <- function(cutoff_1, cutoff_2)
{query <- paste("SELECT (sum((CASE WHEN mean_profit_ha <" , as.character(cutoff_1), " AND ave_n_loss_ha_cgsb > ",  as.character(cutoff_2), " THEN ave_n_loss_ha_swg_7500  ELSE ave_n_loss_ha_cgsb END) * clumuha)) / 1000 FROM \"05_dndc_clumu_cgsb_swg_n_loss\" ")
    sum_N_loss <- tbl(isuag_db, sql(query)) %>%
      as.data.frame()
    sum_N_loss <- sum_N_loss[1,1]
    return(sum_N_loss)
}

# this is the SQL query that selects for each polygon the value of cgsb or swg, depending on its cgsb N loss and profit value, and sums all values up 
# to get a Iowa wide N loss value (absolute), that can then substracted from the baseline N loss.
# (sum((CASE WHEN mean_profit_ha < -500 AND ave_n_loss_ha_cgsb > 60 THEN ave_n_loss_ha_swg_7500  ELSE ave_n_loss_ha_cgsb END) * clumuha)) / 1000 

```
```{r n_loss_two_thresholds, cache=TRUE}

# apply the function to each value in the matrix
tot_n_loss <- mapply(n_loss_select, comb[,1], comb[,2])

# combine the cut off values with the area in switchgrass in a data frame
swg_n_loss <- data.frame(profit = comb[,1],
                        n_loss = comb[,2],
                        tot_n_loss)


```


```{r}

```

```{r area_surfaceplot, fig.height=9, fig.width=10,  fig.cap="Figure 2: Area to convert to switchgrass under a range of combinations of N loss and profitability thresholds. N loss thresholds (in kg N ha^-1^) indicate the value above which the area would be converted to switchgrass and profitability thresholds (in US$ ha^-1^) indicate the value below which the area would be converted to switchgrass."}

x <- profit_cutoffs_16
y <- n_loss_cutoffs_16

# create a matrix out of the z values (in Mha):
swg_matrix <- matrix(swg_areas[,3] * 1e-6
, nrow=16, ncol=16)
#calculate % of total cropland (9374363 ha)
tot_area <- 9.374363
swg_matrix_perc <- (swg_matrix/tot_area)*100
z <- swg_matrix_perc

# create figure with three plots 
plot.new()

#I am organizing where the plots appear on the page using the "plt" argument in "par()"

# top left plot:
par(new = "TRUE",              
    plt = c(0.05,0.45,0.55,0.9),   # using plt instead of mfcol (compare
                                  # coordinates in other plots)
    las = 1,                      # orientation of axis labels
    cex.axis = 1,                 # size of axis annotation
    tck = 0.02 )                  # major tick size and direction, < 0 means outside

persp3D(x, y, z, colvar = z, phi = 10, theta = -150, col = brewer.pal(8,"YlGn"), 
        border = 17, facets = TRUE, colkey = TRUE, resfac = 1, clab = "Switchgrass\narea (%)", 
        lighting = list(alpha = 1),
        xlab = "Profit threshold", ylab = "N loss threshold", zlab = "Swg area (%)",
ticktype = "detailed")


text3D(x=900,y=150, z=109, "(a)", cex = 1.5, font = 2, phi = 10, theta = -150, add= TRUE)


#calculate total biomass for Iowa for each scenario (10,000 kg/ha) in million Mg
swg_matrix_bm <- (swg_matrix * 10)
z_bm <- swg_matrix_bm

#Top right plot:
par(new = "TRUE",
    plt = c(0.55,0.95,0.55,0.9),  # defining window for second plot
    las = 1,
    cex.axis = 1)

persp3D(x, y, z_bm, colvar = z_bm, phi = 10, theta = -150, col = brewer.pal(8,"YlGn"), 
        border = 17, facets = TRUE, colkey = TRUE, resfac = 1, clab = "Biomass\nproduction \n(million metric tons)", 
        lighting = list(alpha = 1),
        xlab = "Profit threshold", ylab = "N loss threshold", zlab = "Biomass (million tons)",
        ticktype = "detailed")

text3D(x=900,y=150, z=102, "(b)", cex = 1.5, font = 2, phi = 10, theta = -150, add= TRUE)




# create matrix for z values from the data frame swg_n_loss (N loss in kg)
swg_matrix_nl <- matrix(swg_n_loss[,3], nrow = 16, ncol = 16)
#calculate N loss reduction compared to baseline
cgsb_n_loss <- 571905
swg_matrix_nlr <- (cgsb_n_loss - swg_matrix_nl) *100 / cgsb_n_loss
z_nlr <- swg_matrix_nlr

#Bottom left plot:
par(new = "TRUE",
    plt = c(0.05,0.45,0.05,0.4),
    las = 1,
    cex.axis = 1)

persp3D(x, y, z_nlr, colvar = z_nlr, phi = 10, theta = -150, col = brewer.pal(8,"YlGn"), 
        border = 17, facets = TRUE, colkey = TRUE, resfac = 1, clab = "N loss \nreduction (%)", 
        lighting = list(alpha = 1),
        xlab = "Profit threshold", ylab = "N loss threshold", zlab = "N loss reduction (%)",
ticktype = "detailed")

text3D(x=900,y=150, z=71, "(c)", cex = 1.5, font = 2, phi = 10, theta = -150, add= TRUE)





```

```{r area_contourplot, fig.height=7, fig.width=8, fig.cap="Figure 3: Surface plots (vertical projection of Figure 2) showing the resulting areas converted to switchgrass (in % of row cropland, (a)), switchgrass biomass production (in million metric tons, (b)), and total N loss reduction (in % of the baseline, (c)) with varying combinations of N loss and profitability threshold values. Isolines with numbers 10-70 show the threshold combinations with similar resulting values. The grey dashed lines show an example how to read the plot: If cropland losing > 60 kg N ha^-1^ and losing > US$ 150 ha^-1^ was considered for conversion to switchgrass, approx. 10% of cropland currently in rowcrop would be in switchgrass (a), approx. 10 million metric tons would be produced (b), and the N loss through leaching would be reduced by 14 % (c)."}


# multiple panel plot with the modified function filled.contour3()

plot.new()

#I am organizing where the plots appear on the page using the "plt" argument in "par()"

# top left plot:
par(new = "TRUE",              
    plt = c(0.1,0.45,0.60,0.95),   # using plt instead of mfcol (compare
                                  # coordinates in other plots)
    las = 1,                      # orientation of axis labels
    cex.axis = 1,                 # size of axis annotation
    tck = -0.02 )                  # major tick size and direction, < 0 means outside

mylevels <- c(seq(0,70,10),100)
filled.contour3(x, y, z, 
                col = brewer.pal(length(mylevels),"YlGn"), 
                levels=mylevels, 
                xlab="", 
                ylab=expression(N~loss~threshold~(kg~ha^{-1})),
                xlim = c(-400,700), ylim = c(0,120))
contour(x, y, z, 
        levels=mylevels, 
        add = TRUE, 
        xlim = c(-400,700), ylim = c(0,120))
abline(h = 60, col = "dark gray", lty = 2)
abline(v = -150, col = "dark gray", lty = 2)

# An annotation inside first plot
#The xpd=NA allows for writing outside the plot limits, but still using the the x and y axes to place the text
par(xpd = NA)
text(x=-300,y=110,"(a)",cex = 1.5,font = 2)


#Top right plot:
par(new = "TRUE",
    plt = c(0.55,0.9,0.60,0.95),  # defining window for second plot
    las = 1,
    cex.axis = 1)

filled.contour3(x, y, z_bm, 
                col = brewer.pal(length(mylevels),"YlGn"), 
                levels=mylevels, 
                xlab=expression(Profitability~threshold~("US$"~ha^{-1})), 
                ylab="",
                xlim = c(-400,700), ylim = c(0,120))
contour(x, y, z_bm, 
        levels=mylevels, 
        add = TRUE, 
        xlim = c(-400,700), ylim = c(0,120))
abline(h = 60, col = "dark gray", lty = 2)
abline(v = -150, col = "dark gray", lty = 2)

par(xpd = NA)
text(x=-300,y=110,"(b)",cex = 1.5,font = 2)


#Bottom left plot:
par(new = "TRUE",
    plt = c(0.1,0.45,0.15,0.5),
    las = 1,
    cex.axis = 1)

filled.contour3(x, y, z_nlr, 
                col = brewer.pal(length(mylevels),"YlGn"), 
                levels=mylevels, 
                xlab=expression(Profitability~threshold~("US$"~ha^{-1})), 
                ylab=expression(N~loss~threshold~(kg~ha^{-1})), 
                xlim = c(-400,700), ylim = c(0,120))
contour(x, y, z_nlr, 
        levels=mylevels, 
        add = TRUE, 
        xlim = c(-400,700), ylim = c(0,120))
abline(h = 60, col = "dark gray", lty = 2)
abline(v = -150, col = "dark gray", lty = 2)

par(xpd = NA)
text(x=-300,y=110,"(c)",cex = 1.5,font = 2)


```

```{r counties_attributes, cache=TRUE}
 counties_n_loss = tbl(isuag_db, "07_n_loss_counties") %>%
   as.data.frame()
 # change the data in the column named "FIPS", so that is contains the county identifiers in the same format as the spatial file:
 for (i in 1:length(counties_n_loss$fips)) {
   counties_n_loss$fips[i] <- sub("IA", "19", counties_n_loss$fips[i])
    }
 # make it a factor
  counties_n_loss$fips <- as.factor(counties_n_loss$fips)
```

```{r counties_spatial, cache=TRUE, include=FALSE, cache=TRUE}
counties <- readOGR(dsn="shapefiles/county.shp",layer="county")
names(counties)[9] <- "fips" # change to lower case so that we can join on this field later on

# join the attribute data with the spatial data, using a left join and the identifier "fips":
counties@data <- left_join(counties@data, counties_n_loss, by = "fips")
counties_df <- fortify(counties)
counties$id <- row.names(counties) # assign a column with the variable ID that is equal to the row names (=numbers), starting with 0.
```

```{r counties_centroids, warning=FALSE, message=FALSE, cache=TRUE} 
# add a spatial data frame with the county centroids, to be used to plot the total leaching N per county:
centroids <- getSpPPolygonsLabptSlots(counties) %>%
  as.data.frame() 
centroids$id <- as.character(0:98)
```

```{r data_n_loss_maps, cache=TRUE}
# set up the data frame 
counties_swg <- data.frame(id = rep(counties$id,3),
                         scenario = c(rep("swg_7500", length(counties$id)), rep("swg_10000", length(counties$id)), 
                                                                               rep("swg_12500", length(counties))),
                         tot_n_loss = c(counties$tot_ave_n_loss_7500, counties$tot_ave_n_loss_10000,
                                           counties$tot_ave_n_loss_12500),
                         ave_n_loss = c(counties$ave_n_loss_7500, counties$ave_n_loss_10000, counties$ave_n_loss_12500),
                         loss_red = c(counties$n_loss_change_7500, counties$n_loss_change_10000,
                                       counties$n_loss_change_12500))

counties_swg$scenario <- factor(counties_swg$scenario, levels = c("swg_7500", "swg_10000", "swg_12500"))
# join data frame with the data frame extracted out of the spatial data frame
counties_swg_df <- left_join(counties_df, counties_swg) %>%
  left_join(centroids)
```

```{r table_n_loss_reduction, cache=TRUE}
n_loss_tot <-tbl(isuag_db, "05_dndc_n_loss_sums_iowa_scenarios")  %>%
  as.data.frame()
n_loss_tot <-   data.frame(value = "total N loss", 
                           n_loss_tot)
names(n_loss_tot) <- c(" ", "Status Quo", "7500", "10000", "12500")

n_loss_red <- data.frame(value = "Reduction (%)", 
                         status_quo = 0,
                        "7500" = (n_loss_tot[1,2]-n_loss_tot[1,3])*100/n_loss_tot[1,2],
                        "10000" = (n_loss_tot[1,2]-n_loss_tot[1,4])*100/n_loss_tot[1,2],
                        "12500" = (n_loss_tot[1,2]-n_loss_tot[1,5])*100/n_loss_tot[1,2])
names(n_loss_red) <- c(" ", "Status Quo", "7500", "10000", "12500")

n_loss_table <- rbind(n_loss_tot[1,],n_loss_red[1,])

kable(n_loss_table, digits = 2, col.names=c(" ", "Status Quo","7500", "10000", "12500"), caption="Table 1: Annual N loss (Mg N) and N loss reduction (%) in Iowa modelled with DNDC under different switchgrass yield scenarios." )

```

```{r plot_n_loss_map, fig.width=4.5, fig.height=3, fig.cap = "Figure 4: County mean annual N loss (green shades) and county mean total annual N loss (yellow circles), averaged over 2012-2015 for the status quo cropland. "}

counties_swg_med_df <- filter(counties_swg_df, scenario == "swg_10000")

ggplot(counties_swg_med_df) +
  geom_polygon(aes(long, lat, group = group, fill=ave_n_loss), color = "white") +
  scale_fill_gradient(low = "white", high="#009E73", guide = "colourbar") +  
  labs(fill = expression(atop("Average N loss", paste("kg N ha"^{-1},")")))) +  
  geom_point(aes(V1, V2, size = tot_n_loss), color = "yellow") +
  labs(size = expression(Total~N~loss~(Mg~N))) +
  scale_size(range = c(0, 4)) +
  coord_equal() +
  ditch_the_axes 
```

```{r plot_n_loss_reduction_map, fig.width=4.5, fig.height=3, fig.cap= "Figure 5: Relative reduction in total N loss per county when switchgrass is grown on areas that loose > US$ 150 ha^-1^ and > 60 kg N ha^-1^ under medium  switchgrass yield assumption, as compared to the status quo in Figure 4."}
ggplot(counties_swg_med_df) +
  geom_polygon(aes(long, lat, group = group, fill=loss_red), color = "white") +
  scale_fill_gradient(low = "white", high="#0072B2", guide = "colourbar") +  
  coord_equal() +
  ditch_the_axes +
  labs(fill = expression(N~loss~reduction~("%"))) 
```


```{r subfield_n_red_iowa_zoom, fig.height=5, fig.width=5, fig.cap="Figure 6: Subfield-scale relative N loss reduction when switchgrass is grown on areas that loose > US$ 150 ha^-1^ and > 60 kg N ha^-1^. (a) The impaired North Racoon River Watershed spanning across Buena Vista, Pocahontas, Sac, and Calhoun County,   "}

include_graphics("imported_images/N_leaching_subfield_NR_Watershed.tif", dpi = 300)
```

## Discussion

- we assume that leached nitrate is exported from the fields by tile drainage *(compare with tile drainage nitrate concentrations of Gabe's modelled plots?)*

- atmospheric deposition of N is not considered by the model (? - check), but it is factored out when calculating N loss changes

- manure application is not considered in the model due to missing spatial data on manure application and type

- our results do not take into account denitrification in surface waters, so the sum is not equal to the DIN export to the Gulf of Mexico [@alexander2008differences]

- however, by estimating DIN loss on a field basis, we are accounting for the amount of dissolved inorganic nitrogen that is lost for the farmer

- *compare with North Racoon River watershed data in @schilling2000relationship: They showed N loads at the outlet of the watershed*

- *can I compare our results with N yields of watersheds, such as reported by @alexander2008differences? What is the total flux per state in table S4 (no unit, seems to be % of total flux into the Gulf, so how much is that???)*

- integration of switchgrass on 10% of cropland would have a stronger effect on N loss reduction compared to other conservation practices, such as crop rotation or conservation tillage [@wu2004decisions]

To reach the Iowa Nutrient Reduction Strategy's goal of 41% N leaching reduction, 40-50% of Iowa cropland would have to be converted to switchgrass. Our resuls indicate the need to combine multiple conservation practices and to adapt them to the biophysical and socio-economic conditions of each given region.

- the variability accross the state comes from the variability in candidate areas for conversion, and from the effective N loss reduction of each of these areas

- outlook: @qiu2015landscape showed that landscape composition is affecting water quality related ecosystem services to varying extent. Due to the large spatial area covered, our underlying data includes a realistic but approximated reflection of reality. However, applied to smaller management units and fed with more detailed and accurate data, our spatial results could be used as indicators to identify nonlinear (disproportionate) responses of N loss reduction to conversion of land to perennial grasses.
(--> find "sweet spots" where large improvements can be obtained by conversion of small land areas)

## Conclusions


- This study disaggregates previously published approaches of N balance estimated based on county data (e.g Libra et al 2004) down to a finer resolution and takes into account the biogeochemical processes driving DIN loss in agroecosystems

## Supplementary Information

```{r profit_distribution, fig.width=4.5, fig.height=3, fig.cap="Figure S1: Distribution of mean profitability 2012-2015. The vertical line marks the -150 US$ ha^-1^ cut off value used for the switchgrass integration below."}
profit = tbl(isuag_db, "01_profit_mean_2012_2015_aggregated") %>%
  as.data.frame()
profit$sum_ha <- profit$sum_ha * 1e-6  # convert to Mha

ggplot(profit, aes(profit_mean_ha_rounded, weight = sum_ha)) + 
  geom_histogram(binwidth=20, alpha = .5, position="identity") +
  theme_b_border() +
  labs(x=expression(Mean~profitability~2012-2015~("US$"~ha^{-1})),
       y=expression(Area~(Mha))) +
  scale_x_continuous() +
  scale_y_continuous() +
  geom_vline(aes(xintercept= -150, linetype= "dashed"),  show.legend = FALSE) 
```

```{sql, connection=con, cache=TRUE, include=FALSE}
SELECT setseed(0.5)
```

```{sql, connection=con, cache=TRUE}
CREATE TABLE "r_dndc_clumu_cgsb_swg_n_loss_sample" AS SELECT mean_profit_ha, ave_n_loss_ha_cgsb FROM "05_dndc_clumu_cgsb_swg_n_loss" ORDER BY random() LIMIT 10000
```
```{r data_sample_n_loss}
sample = tbl(isuag_db, "r_dndc_clumu_cgsb_swg_n_loss_sample") %>%
  as.data.frame(sample)
```

```{r scatterplot_n_loss, fig.width=4.5, fig.height=3, fig.cap="Figure S2: Scatterplot of a subsample (n=10,000) of profitability and corn/soy N loss data on subfield areas in Iowa. The red lines indicate possible cut off values, such as -150 US$ ha^-1^ for profitability (solid) and 60 kg N ha^-1^ for N loss (dashed)."}
ggplot() +
  geom_point(data = sample, aes(x = mean_profit_ha, y = ave_n_loss_ha_cgsb), alpha = .2, stroke=0) +
  theme_b_border() +
  labs(y=expression(Mean~N~loss~2006-2015~(kg~N~ha^{-1})),
       x=expression(Mean~profitability~2012-2015~("US$"~ha^{-1}))) +
  geom_vline(aes(xintercept= -150, linetype= "dashed", color = "red"),  show.legend = FALSE) +
  geom_hline(aes(yintercept= 60, linetype= "dotted", color = "red"),  show.legend = FALSE)
  
```

```{r fetch_distr, cache=TRUE}

cgsb_leach <-tbl(isuag_db, "06_cgsb_ave_n_loss_rounded_aggr")  %>%
  as.data.frame()
swg_low <-tbl(isuag_db, "06_swg_7500_ave_n_loss_rounded_aggr")  %>%
  as.data.frame()
swg_med <-tbl(isuag_db, "06_swg_10000_ave_n_loss_rounded_aggr")  %>%
  as.data.frame()
swg_hi <-tbl(isuag_db, "06_swg_12500_ave_n_loss_rounded_aggr")  %>%
  as.data.frame()
```
```{r data_list}
data_list <- list(cgsb_leach, swg_low, swg_med, swg_hi)

scenario <- c(rep("cgsb", sum(sapply(data_list[1],nrow))), rep("swg_low", sum(sapply(data_list[2],nrow))), rep("swg_med", sum(sapply(data_list[3],nrow))), rep("swg_hi", sum(sapply(data_list[4],nrow)))) %>%
factor(levels= c('cgsb', 'swg_low', 'swg_med', 'swg_hi')) # make it a factor so that it is plotted in the right order in the facets

leaching <- vector(mode="numeric", length=0)
 for (i in seq(data_list))
   leaching <- append(leaching, data_list[[i]][,1])
area <- vector(mode="numeric", length=0)
 for (i in seq(data_list))
   area <- append(area, data_list[[i]][,2])
   
leach <- data.frame(scenario, leaching, area = area*1e-6) # this factor to show Mha

# calculate weighted medians and means

median_cgsb <- weightedMedian(cgsb_leach[-1,1], w=cgsb_leach[-1,2])
median_swg_low <- weightedMedian(swg_low[,1], w=swg_low[,2])
median_swg_med <- weightedMedian(swg_med[,1], w=swg_med[,2])
median_swg_hi <- weightedMedian(swg_hi[,1], w=swg_hi[,2])
medians <- c(median_cgsb, median_swg_low, median_swg_med, median_swg_hi)
medians_df <- data.frame(crop = levels(leach$scenario),
                         median = medians)

mean_cgsb <- weightedMean(cgsb_leach[-1,1], w=cgsb_leach[-1,2])
mean_swg_low <- weightedMean(swg_low[,1], w=swg_low[,2])
mean_swg_med <- weightedMean(swg_med[,1], w=swg_med[,2])
mean_swg_hi <- weightedMean(swg_hi[,1], w=swg_hi[,2])
means <-c(mean_cgsb, mean_swg_low, mean_swg_med, mean_swg_hi)


```

```{r histograms, cache=TRUE, fig.height=4, fig.width=7, fig.cap="Figure S3: Distributions of N loss in Iowa. Values for switchgrass were averaged over the mananagement horizon of 10 years, including two establishment years."}
scenarios <- c('cgsb'= "Status Quo (corn/soybeans)", 'swg_low' = "Low yielding switchgrass", 'swg_med' = "Medium yielding switchgrass", 'swg_hi' = "High yielding switchgrass")

ggplot(leach, aes(leaching, weight = area)) + 
  geom_histogram(binwidth=2, alpha = .5, position="identity") +
  theme_b_border() +
  labs(x=expression(Mean~NO[3]^{"-"}~leaching~"+"~NH[3]~volatilization~2006-2015~(kg~N~ha^{-1})),
       y=expression(Area~(Mha))) +
  scale_x_continuous() +
  scale_y_continuous() +
  geom_vline(data = medians_df, aes(xintercept=median), color = "black") +
  theme(legend.position="bottom") +
  facet_wrap( ~ scenario, ncol=2, labeller = as_labeller(scenarios)) 
```

```{r swg_areas, cache=TRUE}
swg_areas <- vector(mode="numeric", length=0)
profit_cutoffs <- c(-500, -400, -300, -200, -150, -100, -50, 0, 50, 100, 150)
 for (i in 1:length(profit_cutoffs)) {
    query <- paste("SELECT SUM(clumuha) FROM \"05_dndc_clumu_cgsb_swg_n_loss\" WHERE mean_profit_ha < ", as.character(profit_cutoffs[i]), "AND ave_n_loss_ha_cgsb > 60")
    sum_area <- tbl(isuag_db, sql(query)) %>%
      as.data.frame()
    sum_area <- sum_area[1,1]
    swg_areas <- append(swg_areas, sum_area) 
  }
```

```{r no3_leaching_sums, cache=TRUE}
sum_n_loss <- tbl(isuag_db, "08_dndc_n_loss_sums_iowa_dispr_benefits") %>%
  as.data.frame() %>%
  gather(corn_soybeans, swg_7500_1, swg_7500_2, swg_7500_3, swg_7500_4, swg_7500_5, swg_7500_6, swg_7500_7, swg_7500_8, swg_7500_9, swg_7500_10, swg_7500_11, swg_10000_1, swg_10000_2, swg_10000_3, swg_10000_4, swg_10000_5, swg_10000_6, swg_10000_7, swg_10000_8, swg_10000_9, swg_10000_10, swg_10000_11, swg_12500_1, swg_12500_2, swg_12500_3, swg_12500_4, swg_12500_5, swg_12500_6, swg_12500_7, swg_12500_8, swg_12500_9, swg_12500_10, swg_12500_11, key = swg_scenarios, value=ave_n_loss)
```

```{r data_dispr_benefits}
swg_yield <- as.factor(c("NA",rep("7500",11), rep("10000",11),rep("12500",11)))
profit_cutoff <- c(NA, rep(profit_cutoffs,3))
swg_area <- c(0,rep(swg_areas,3))
swg_area_percent <- (swg_area/9374363)*100
N_loss <- sum_n_loss[,2]
N_reduction <- abs((N_loss - N_loss[1])/N_loss[1])*100

relation <- data.frame(swg_yield, profit_cutoff, swg_area_percent, N_reduction)
```


```{r relations, cache=TRUE, fig.width=4.5, fig.height=3,  fig.cap="Figure S4: N loss reduction as a function of area in switchgrass (a) and of the profitability threshold (b)."}

ggplot() +
  geom_point(data = relation, aes(x = swg_area_percent, y = N_reduction, color=swg_yield)) +
  theme_b_border() +
  labs(x=expression(Area~"in"~switchgrass~("%")),
       y=expression(N~loss~reduction~("%"~N))) +
  scale_x_continuous() +
  scale_y_continuous() +
  scale_color_discrete(name="Switchgrass\nYield (kg/ha)",  guide = FALSE) +
  annotate("text", x = 0, y = 40, label = "(a)", size = 5)

ggplot() +
  geom_point(data = relation, aes(x = profit_cutoff, y = N_reduction, color=swg_yield)) +
  theme_b_border() +
  labs(x=expression(Profitability~threshold~("US$"~ha^{-1})),
       y=expression(N~loss~reduction~("%"~N))) +
  scale_x_continuous(breaks=seq(from=-500, to=200, by= 100)) +
  scale_y_continuous() +
  scale_color_discrete(name="Switchgrass\nYield") +
  theme(legend.position=c(0.25,0.65))+
  annotate("text", x = -500, y = 40, label = "(b)", size = 5)
```
```{r shut, include=FALSE}
 rm(list='isuag_db'); gc() 
```