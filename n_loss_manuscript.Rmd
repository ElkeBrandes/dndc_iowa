---
title: Modelled N loss by NO~3~^-^ leaching and NH~3~ volatilization in Iowa from row
  cropped and switchgrass fields
author: "Elke Brandes"
date: "Monday, November 28, 2016"
output:
  word_document: default
#  html_document: default
bibliography: nutrient_bibliography.bib
---
```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning = FALSE, fig.width=4.5, fig.height=3)

```

## Abstract

- modelling the leachable N fraction for the state of Iowa in a bottom up approach
- using high-resolution spatial data to test ecosystem service outcomes of a socio-economic approach of perennial biomass crop integration

## Introduction

- pooled under the term precision conservation, efforts have been made recently to develop agricultural landscape designs that meet agricultural needs while optimizing the reduction of environmental risk by targeted placement of conservation management practices [@mcconnell2011precision]

- this approach can potentially be adapted to target perennial crops for sustainable cellulosic bioenergy production [@chaubey2016precision]

- due to their multiple benefits on water and soil quality, perennial biomass crops have been proven suitable for conservation purposes while providing feedstock for a growing bioeconomy

- in practice, socio-economic barriers prevent the implementation of urgently needed conservation management

- thus, a trade off exists between economic and environmental desires and needs to be addressed when assessing the feasibility of sustainable bioenergy feedstock production

- therefore, in this ananysis, we are targeting crop land that is least socially desirable to be in row crops

### Water quality as the ecosystem service in focus

- non-point nutrient pollution from industrialized agriculture in the Mississippi River Basin has been exacerbating the hypoxic zone in the Gulf of Mexico (cite)

- @vanloocke2016din found that replacing maize currently grown for bioethanol with cellulosic biomass crops could reduce dissolved inorganic nitrogen (DIN) export to the Gulf of Mexico by 15 to 20%. They suggest that integration of perennial grasses targeted to areas of low row crop productivity and high leaching rates could further increase surface water quality.

- Nutrient reduction task force requires a 30% - 55% reduction in N leaching from cropland to reduce it (cite)

- in Iowa: 41% (Iowa Nutrient Reduction Strategy)

- Perennial biomass grasses have shown to reduce N leaching drastically compared to maize (cite)

- therefore we argue that targeted replacement of row crops with the highly productive and locally adapted switchgrass variety "Liberty" could contribute to a reduction of N loss in Iowa

### Goal of this study:

1. Quantify the extent of DIN (dissolved inorganic nitrogen) reduction by managing cropland areas that are at highest economic and environmental risk in switchgrass
2. Identifying areas in Iowa with highest potential for swtichgrass integration that is compatible with socio-economic constraints
3. Exploring one of many opportunities to improve management of subfield areas that are not profitable with high-input row crop management

## Methods

- subfield profitability analysis as described in detail in Brandes et al 2016
- updated to the time frame 2012-2015 (four years)
- only including fields that were in maize and/or soybean in all four years
- using publicly available data to calculate profitability

- model nitrogen mass balance in the agroecosystem with DNDC
- data used:
- assumptions:
- scenarios: status quo, switchgrass with three yield assumptions
- model description and evaluation?

- identify thresholds to select subfield areas suitable for switchgrass integration: profit of < -150 US$/ha, DIN loss of > 60 kg N/ha
- calculate N loss changes per subfield area and aggregated to the county level

## Results

- *what weather data is used for the DNDC simulations? Should we show weather data and the annual response in N loss?*
- *Total N loss: Sum of NO~3~^-^ leaching and NH~3~^+^ volatilitzation - term/definition?*
- DIN leaching? (dissolved inorganic nitrogen) - includes NO~X~ and NH~3~ [@vanloocke2016din]

- Mean profitability shows spatial heterogeneity accross Iowa, with highest total area losing > US$ 150 ha^-1^ in west central Iowa and highest relative area in the west central and south part of the state (Figure 1)

- selected criteria for conversion to switchgrass: mean profitability < US$ -150 ha^-1^, N loss > 60 kg ha^-1^
- *should I change the profit threshold? What is the rationale of chosing -150 US$ and 60 kg N ha^-1^?*

- at a threshold of US$ -150 ha^-1^, 10 % of current row cropland would be converted to switchgrass, at a threshold of US\$ 0 ha^-1^ it would be 23 % (Figure 2)

- State-wide mean annual N loss (status quo, 2012-2015) amounted to 0.57 million metric tonnes. On the state-wide average, converting all areas with profitability below US$ -150 ha^-1^ and with N losses of > 60 kg ha^-1^ to switchgrass would result in a 13.5, 14.3, and 14.7 % reduction of N loss for the low, medium, and high yielding scenario (Table 1)

- the spatial pattern of N loss in Iowa shows highest N losses in the counties on the Des Moines Lobe and in the north east of the state (Figure 3)

- according to the model presented here, highest N loss reduction with the switchgrass integration scenario can be achieved in the western counties along the Missouri and some of the central and eastern counties (Figure 4). The counties of highest N losses in the status quo don't line up with those of highest reduction potential.

- the subfield resolution map of N loss reduction (Figure 5) illustrates the spatial heterogeneity of the environmental outcomes of the biomass crop integration. Strong "county effects" seem to drive the highest reduction values. Some counties with very high conversion areas (Figure 1) and therefore high potential N loss reduction (Figure 4, 5), e.g., Monona, Carroll, and Hamilton County, both show a low yield/cash rent ratio (data not shown).

- zooming in on select counties: Pattern of switchgrass fields vary, some regions, whole fields are converted, in other, subfield areas are patchy and more fragmented (Figure 6)


```{r packages}
library('RPostgreSQL') # PostgreSQL database connection
library("ggplot2") # for the figures
library("maps") # to plot maps, contains country/state/county outlines
library("gridGraphics") # needed for the function unit in ggplot
library("tidyverse") # to make tidy tables, includes dplyr needed for PostgreSQL database connection
library('knitr') # to use kable() function

library(rgdal) # to read in shape files
library(ggmap)
library(scales)
library(RColorBrewer)
library("sp") # to use merge with a spatial data frame

library("tmap")

library(png) # to read png files
library(grid) # to display png files


```

```{r connect_dplyr}

# with dplyr:
pw <- "5QUXJHTbxj" # enter password here

isuag_db <- src_postgres(dbname = 'isuag',
                           host = 'isu-ag-db.agsolver.com',
                           port = 5432,
                           user = 'isuag',
                           password = pw)

```

```{r, connect_rpostgres}

# With RPostgreSQL:
drv <- dbDriver("PostgreSQL") # loads the PostgreSQL driver
con <- dbConnect(drv, dbname = "isuag",  # creates a connection to the postgres database
                 host = "isu-ag-db.agsolver.com", port = 5432,
                 user = "isuag", password = pw)
# note that "con" will be used later in each connection to the database
```

```{r theme, cache=TRUE}
# I am using a modified theme for ggplot that has a black border and white background:
theme_b_border <- function (base_size = 12, base_family = "") 
{
  theme_grey(base_size = base_size, base_family = base_family) %+replace% 
    theme(
      axis.text = element_text(size = rel(0.8), margin = margin(r=10)), #margin 
      axis.ticks = element_line(colour = "black"),
      axis.ticks.length = unit(0.15, "cm"),
      legend.key = element_rect(colour = NA), panel.background = element_rect(fill = "white", 
      colour = NA), panel.border = element_rect(fill = NA, 
      colour = "black"), panel.grid.major = element_line(colour = NA, 
      size = 0.2), panel.grid.minor = element_line(colour = NA, 
      size = 0.5), strip.background = element_rect(fill = "grey80", 
      colour = "grey50", size = 0.2))
}
```

```{r profit_spatial, cache=TRUE, include= FALSE}
counties <- readOGR(dsn="Z:/ElkeBrandes/projects/01 subfield profit/data analysis/02 GIS/government_units/iowa_cnty/IA_cnty/county.shp",layer="county")
names(counties)[9] <- "fips" 

profit_county <- tbl(isuag_db, "07_swg_area_counties_po") %>%
  as.data.frame() 

 for (i in 1:length(profit_county$fips)) {
   profit_county$fips[i] <- sub("IA", "19", profit_county$fips[i])
    }

# profit_county$fips <- as.factor(profit_county$fips)
counties@data <- left_join(counties@data, profit_county, by = "fips")
counties_df <- fortify(counties)
counties$id <- row.names(counties) 
counties_profit_df <- left_join(counties_df, counties@data)

# add a spatial data frame with the county centroids, to be used to plot the total leaching N per county:
centroids <- getSpPPolygonsLabptSlots(counties) %>%
  as.data.frame() 

centroids$id <- as.character(0:98)

# join the total N leaching data to the centroids 
counties_profit_df <- left_join(counties_profit_df, centroids)

# create a theme without axes:
ditch_the_axes <- theme(
  axis.text = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank()
  )
```
```{r figure_profit, fig.height=4, fig.width=8,  fig.cap="Figure 1: Areas below a mean 2012-2015 profitability of US$ -150 ha^-1^ per county. Purple shades indicate the relative area, orange circles show the absolute size of the area per county."}
ggplot() +
  geom_polygon(data = counties_profit_df, aes(long, lat, group = group, fill=area_in_swg_perc), color = "white") +
  geom_point(data = counties_profit_df, aes(V1, V2, size = area_in_swg), color = "orange") +
  labs(size = expression(Total~area~below~-150~"US$"~ha^{-1}~(ha))) +
  coord_equal() +
  ditch_the_axes +
  labs(fill = expression(Relative~area~below~-150~"US$"~ha^{-1}~("%"))) +
  scale_fill_gradient(low = "white", high="dark blue", guide = "colourbar") 
```



```{r swg_areas, cache=TRUE}
swg_areas <- vector(mode="numeric", length=0)
profit_cutoffs <- c(-500, -400, -300, -200, -150, -100, -50, 0, 50, 100, 150)
 for (i in 1:length(profit_cutoffs)) {
    query <- paste("SELECT SUM(clumuha) FROM \"05_dndc_clumu_cgsb_swg_n_loss\" WHERE mean_profit_ha < ", as.character(profit_cutoffs[i]), "AND ave_n_loss_ha_cgsb > 60")
    sum_area <- tbl(isuag_db, sql(query)) %>%
      as.data.frame()
    sum_area <- sum_area[1,1]
    swg_areas <- append(swg_areas, sum_area) 
  }
```
```{r no3_leaching_sums, cache=TRUE}
sum_n_loss <- tbl(isuag_db, "08_dndc_n_loss_sums_iowa_dispr_benefits") %>%
  as.data.frame() %>%
  gather(corn_soybeans, swg_7500_1, swg_7500_2, swg_7500_3, swg_7500_4, swg_7500_5, swg_7500_6, swg_7500_7, swg_7500_8, swg_7500_9, swg_7500_10, swg_7500_11, swg_10000_1, swg_10000_2, swg_10000_3, swg_10000_4, swg_10000_5, swg_10000_6, swg_10000_7, swg_10000_8, swg_10000_9, swg_10000_10, swg_10000_11, swg_12500_1, swg_12500_2, swg_12500_3, swg_12500_4, swg_12500_5, swg_12500_6, swg_12500_7, swg_12500_8, swg_12500_9, swg_12500_10, swg_12500_11, key = swg_scenarios, value=ave_n_loss)
```
```{r data_dispr_benefits}
swg_yield <- as.factor(c("NA",rep("7500",11), rep("10000",11),rep("12500",11)))
profit_cutoff <- c(NA, rep(profit_cutoffs,3))
swg_area <- c(0,rep(swg_areas,3))
swg_area_percent <- (swg_area/9374363)*100
N_loss <- sum_n_loss[,2]
N_reduction <- abs((N_loss - N_loss[1])/N_loss[1])*100

relation <- data.frame(swg_yield, profit_cutoff, swg_area_percent, N_reduction)
```
```{r thresholds, warning=FALSE, fig.show="hold", fig.height= 3, fig.width=4.5, fig.cap="Figure 2: Relation between profitability threshold and the resulting area in switchgrass. The N loss threshold is kept constant at 60 kg ha^-1^."}
ggplot() +
  geom_point(data = relation, aes(x = profit_cutoff, y = swg_area_percent)) +
  theme_b_border() +
  labs(x=expression(Profitability~threshold~("US$"~ha^{-1})),
       y=expression(Area~"in"~switchgrass~("%"))) +
  scale_x_continuous(breaks=seq(from=-500, to=200, by= 100)) +
  scale_y_continuous(limits= c(0,65)) +
    geom_vline(aes(xintercept= -150, linetype= "dotted", color = "red"),  show.legend = FALSE)
```

```{r counties_attributes}
 counties_n_loss = tbl(isuag_db, "07_n_loss_counties") %>%
   as.data.frame()
 # change the data in the column named "FIPS", so that is contains the county identifiers in the same format as the spatial file:
 for (i in 1:length(counties_n_loss$fips)) {
   counties_n_loss$fips[i] <- sub("IA", "19", counties_n_loss$fips[i])
    }
 # make it a factor
  counties_n_loss$fips <- as.factor(counties_n_loss$fips)
```

```{r counties_spatial, cache=TRUE, include=FALSE}

counties <- readOGR(dsn="Z:/ElkeBrandes/projects/01 subfield profit/data analysis/02 GIS/government_units/iowa_cnty/IA_cnty/county.shp",layer="county")
names(counties)[9] <- "fips" # change to lower case so that we can join on this field later on

# join the attribute data with the spatial data, using a left join and the identifier "fips":
counties@data <- left_join(counties@data, counties_n_loss, by = "fips")
counties_df <- fortify(counties)
counties$id <- row.names(counties) # assign a column with the variable ID that is equal to the row names (=numbers), starting with 0.

```

```{r plot_baseline_map, warning=FALSE, message=FALSE} 

# create a theme without axes:
ditch_the_axes <- theme(
  axis.text = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank()
  )

# add a spatial data frame with the county centroids, to be used to plot the total leaching N per county:
centroids <- getSpPPolygonsLabptSlots(counties) %>%
  as.data.frame() 
centroids$id <- as.character(0:98)
```
```{r data_n_loss_maps}
# set up the data frame 
counties_swg <- data.frame(id = rep(counties$id,3),
                         scenario = c(rep("swg_7500", length(counties$id)), rep("swg_10000", length(counties$id)), 
                                                                               rep("swg_12500", length(counties))),
                         tot_n_loss = c(counties$tot_ave_n_loss_7500, counties$tot_ave_n_loss_10000,
                                           counties$tot_ave_n_loss_12500),
                         ave_n_loss = c(counties$ave_n_loss_7500, counties$ave_n_loss_10000, counties$ave_n_loss_12500),
                         loss_red = c(counties$n_loss_change_7500, counties$n_loss_change_10000,
                                       counties$n_loss_change_12500))

counties_swg$scenario <- factor(counties_swg$scenario, levels = c("swg_7500", "swg_10000", "swg_12500"))
# join data frame with the data frame extracted out of the spatial data frame
counties_swg_df <- left_join(counties_df, counties_swg) %>%
  left_join(centroids)
```

```{r total_leaching}
n_loss_tot <-tbl(isuag_db, "05_dndc_n_loss_sums_iowa_scenarios")  %>%
  as.data.frame()
n_loss_tot <-   data.frame(value = "total N loss", 
                           n_loss_tot)
names(n_loss_tot) <- c(" ", "Status Quo", "7500", "10000", "12500")

n_loss_red <- data.frame(value = "Reduction (%)", 
                         status_quo = 0,
                        "7500" = (n_loss_tot[1,2]-n_loss_tot[1,3])*100/n_loss_tot[1,2],
                        "10000" = (n_loss_tot[1,2]-n_loss_tot[1,4])*100/n_loss_tot[1,2],
                        "12500" = (n_loss_tot[1,2]-n_loss_tot[1,5])*100/n_loss_tot[1,2])
names(n_loss_red) <- c(" ", "Status Quo", "7500", "10000", "12500")

n_loss_table <- rbind(n_loss_tot[1,],n_loss_red[1,])

kable(n_loss_table, digits = 2, col.names=c(" ", "Status Quo","7500", "10000", "12500"), caption="Table 1: Annual N loss (Mg N) in Iowa modelled with DNDC under different switchgrass yield scenarios." )

```

```{r plot_n_loss_map, fig.cap = "Figure 3: County mean annual N loss (green shades) and county mean total annual N loss (yellow circles), averaged over 2012-2015 for the status quo cropland. "}

counties_swg_med_df <- filter(counties_swg_df, scenario == "swg_10000")

ggplot(counties_swg_med_df) +
  geom_polygon(aes(long, lat, group = group, fill=ave_n_loss), color = "white") +
  scale_fill_gradient(low = "white", high="#009E73", guide = "colourbar") +  
  labs(fill = expression(atop("Average N loss", paste("kg N ha"^{-1},")")))) +  
  geom_point(aes(V1, V2, size = tot_n_loss), color = "yellow") +
  labs(size = expression(Total~N~loss~(Mg~N))) +
  scale_size(range = c(0, 4)) +
  coord_equal() +
  ditch_the_axes 
```

```{r plot_n_loss_reduction_map, fig.cap= "Figure 4: Relative reduction in total N loss per county in the medium yield switchgrass integration scenario, as compared to the status quo in Figure 3."}
ggplot(counties_swg_med_df) +
  geom_polygon(aes(long, lat, group = group, fill=loss_red), color = "white") +
  scale_fill_gradient(low = "white", high="#0072B2", guide = "colourbar") +  
  coord_equal() +
  ditch_the_axes +
  labs(fill = expression(N~loss~reduction~("%"))) 
```


```{r subfield_n_red_iowa_zoom, fig.cap="Figure 5: Subfield-scale relative N loss reduction when switchgrass is grown on areas that lose > US$ 150 ha^-1^ and > 60 kg N ha^-1^. (a) The impaired North Racoon River Watershed spanning across Buena Vista, Pocahontas, Sac, and Calhoun County,   "}

include_graphics("Z:/ElkeBrandes/projects/02 nutrient reduction/results/N_leaching_subfield_NR_Watershed.tif")
```

## Discussion

- our results do not take into account denitrification in surface waters, so the sum is not equal to the DIN export to the Gulf of Mexico


## Supplementary Information

```{r profit_distribution, fig.cap="Figure S1: Distribution of mean profitability 2012-2015. The vertical line marks the -150 US$ ha^-1^ cut off value used for the switchgrass integration below."}
profit = tbl(isuag_db, "01_profit_mean_2012_2015_aggregated") %>%
  as.data.frame()
profit$sum_ha <- profit$sum_ha * 1e-6  # convert to Mha

ggplot(profit, aes(profit_mean_ha_rounded, weight = sum_ha)) + 
  geom_histogram(binwidth=20, alpha = .5, position="identity") +
  theme_b_border() +
  labs(x=expression(Mean~profitability~2012-2015~("US$"~ha^{-1})),
       y=expression(Area~(Mha))) +
  scale_x_continuous() +
  scale_y_continuous() +
  geom_vline(aes(xintercept= -150, linetype= "dashed"),  show.legend = FALSE) 
```

```{sql, connection=con, cache=TRUE, include=FALSE}
SELECT setseed(0.5)
```
```{sql, connection=con, cache=TRUE}
DROP TABLE IF EXISTS "r_dndc_clumu_cgsb_swg_n_loss_sample";
```
```{sql, connection=con, cache=TRUE}
CREATE TABLE "r_dndc_clumu_cgsb_swg_n_loss_sample" AS SELECT mean_profit_ha, ave_n_loss_ha_cgsb FROM "05_dndc_clumu_cgsb_swg_n_loss" ORDER BY random() LIMIT 10000
```
```{r data_sample_n_loss}
sample = tbl(isuag_db, "r_dndc_clumu_cgsb_swg_n_loss_sample") %>%
  as.data.frame(sample)
```

```{r scatterplot_n_loss, fig.cap="Figure S2: Scatterplot of a subsample (n=10,000) of profitability and corn/soy N loss data on subfield areas in Iowa. The red lines indicate possible cut off values, such as -150 US$ ha^-1^ for profitability (solid) and 60 kg N ha^-1^ for N loss (dashed)."}
ggplot() +
  geom_point(data = sample, aes(x = mean_profit_ha, y = ave_n_loss_ha_cgsb), alpha = .2, stroke=0) +
  theme_b_border() +
  labs(y=expression(Mean~N~loss~2006-2015~(kg~N~ha^{-1})),
       x=expression(Mean~profitability~2012-2015~("US$"~ha^{-1}))) +
  geom_vline(aes(xintercept= -150, linetype= "dashed", color = "red"),  show.legend = FALSE) +
  geom_hline(aes(yintercept= 60, linetype= "dotted", color = "red"),  show.legend = FALSE)
  
```

```{r fetch_distr, cache=TRUE}

cgsb_leach <-tbl(isuag_db, "06_cgsb_ave_n_loss_rounded_aggr")  %>%
  as.data.frame()
swg_low <-tbl(isuag_db, "06_swg_7500_ave_n_loss_rounded_aggr")  %>%
  as.data.frame()
swg_med <-tbl(isuag_db, "06_swg_10000_ave_n_loss_rounded_aggr")  %>%
  as.data.frame()
swg_hi <-tbl(isuag_db, "06_swg_12500_ave_n_loss_rounded_aggr")  %>%
  as.data.frame()
```
```{r data_list}
data_list <- list(cgsb_leach, swg_low, swg_med, swg_hi)

scenario <- c(rep("cgsb", sum(sapply(data_list[1],nrow))), rep("swg_low", sum(sapply(data_list[2],nrow))), rep("swg_med", sum(sapply(data_list[3],nrow))), rep("swg_hi", sum(sapply(data_list[4],nrow)))) %>%
factor(levels= c('cgsb', 'swg_low', 'swg_med', 'swg_hi')) # make it a factor so that it is plotted in the right order in the facets

leaching <- vector(mode="numeric", length=0)
 for (i in seq(data_list))
   leaching <- append(leaching, data_list[[i]][,1])
area <- vector(mode="numeric", length=0)
 for (i in seq(data_list))
   area <- append(area, data_list[[i]][,2])
   
leach <- data.frame(scenario, leaching, area = area*1e-6) # this factor to show Mha
```

```{r histograms, cache=TRUE, fig.height=4, fig.width=7, fig.cap="Figure S3: Distributions of N loss in Iowa. Values for switchgrass were averaged over the mananagement horizon of 10 years, including two establishment years."}
scenarios <- c('cgsb'= "Status Quo (corn/soybeans)", 'swg_low' = "Low yielding switchgrass", 'swg_med' = "Medium yielding switchgrass", 'swg_hi' = "High yielding switchgrass")

ggplot(leach, aes(leaching, weight = area)) + 
  geom_histogram(binwidth=2, alpha = .5, position="identity") +
  theme_b_border() +
  labs(x=expression(Mean~NO[3]^{"-"}~leaching~"+"~NH[3]~volatilization~2006-2015~(kg~N~ha^{-1})),
       y=expression(Area~(Mha))) +
  scale_x_continuous() +
  scale_y_continuous() +
  theme(legend.position="bottom") +
  facet_wrap( ~ scenario, ncol=2, labeller = as_labeller(scenarios)) 
```

```{r relations, cache=TRUE,  fig.cap="Figure S4: N loss reduction as a function of area in switchgrass (a) and of the profitability threshold (b)."}

ggplot() +
  geom_point(data = relation, aes(x = swg_area_percent, y = N_reduction, color=swg_yield)) +
  theme_b_border() +
  labs(x=expression(Area~"in"~switchgrass~("%")),
       y=expression(N~loss~reduction~("%"~N))) +
  scale_x_continuous() +
  scale_y_continuous() +
  scale_color_discrete(name="Switchgrass\nYield (kg/ha)",  guide = FALSE) +
  annotate("text", x = 0, y = 40, label = "(a)", size = 5)

ggplot() +
  geom_point(data = relation, aes(x = profit_cutoff, y = N_reduction, color=swg_yield)) +
  theme_b_border() +
  labs(x=expression(Profitability~threshold~("US$"~ha^{-1})),
       y=expression(N~loss~reduction~("%"~N))) +
  scale_x_continuous(breaks=seq(from=-500, to=200, by= 100)) +
  scale_y_continuous() +
  scale_color_discrete(name="Switchgrass\nYield") +
  theme(legend.position=c(0.25,0.65))+
  annotate("text", x = -500, y = 40, label = "(b)", size = 5)
```
```{r shut, include=FALSE}
 rm(list='isuag_db'); gc() 
```