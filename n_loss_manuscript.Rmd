---
title: Targeted subfield switchgrass integration could improve the farm economy, water quality, and bioenergy feedstock production
author: ""
date: ""
output:
  word_document:
    reference_docx: gcbb_styles_reference.docx
csl: global-change-biology.csl
bibliography: nutrient_bibliography.bib
geometry: margin=1in
---
```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, message=FALSE, warning = FALSE)
```

Targeted subfield switchgrass integration
```{r packages}


library('RPostgreSQL') # PostgreSQL database connection
library("ggplot2") # for the figures
library("maps") # to plot maps, contains country/state/county outlines
library("gridGraphics") # needed for the function unit in ggplot
library("tidyverse") # to make tidy tables, includes dplyr needed for PostgreSQL database connection
library('knitr') # to use kable() function

library(rgdal) # to read in shape files
library(ggmap)
library(scales)
library(RColorBrewer)
library("sp") # to use merge with a spatial data frame

library(png) # to read png files
library(grid) # to display png files
library("plot3D") # for surface plot

library('matrixStats')
library('gridExtra') # need to plot ggplots in a grid

library('foreign')
library("Hmisc") # to calculate weighted quantiles

```
## Authors

Elke Brandes^1^*, Gabe S McNunn^1,3^, Lisa A Schulte^2^, David J Muth^3^, Andy VanLoocke^1^, and Emily A Heaton^1^

^1^Department of Agronomy, Iowa State University, Ames, IA 50011, USA

^2^Department of Natural Resource Ecology and Management, Iowa State University, Ames, IA 50011, USA

^3^AgSolver, Inc., 2321 North Loop Drive, Suite 108, Ames, IA 50010, USA

*Corresponding author, E-mail: ebrandes@iastate.edu


## Keywords

Precision agriculture, precision conservation, DeNitrification-DeComposition (DNDC), nitrogen loss, hypoxia, eutrophication, ecosystem services, landscape analysis, Panicum virgatum, corn

Original Research Article



## Abstract

Progress on reducing nutrient loss from annual croplands has been hampered by perceived conflicts between short-term profitability and long-term stewardship, but these may be overcome through strategic integration of perennial crops. Perennial biomass crops like switchgrass can mitigate nitrate-nitrogen (NO~3~-N) leaching, address bioenergy feedstock targets, and - as a lower-cost management alternative to annual crops (i.e., corn, soybeans) - may also improve farm profitability. We analyzed publicly available environmental, agronomic, and economic data with two integrated models: a subfield agroecosystem management model, Landscape Environmental Assessment Framework (LEAF), and a process-based biogeochemical model, DeNitrification-DeComposition (DNDC). We constructed a factorial combination of profitability and NO~3~-N leaching thresholds and simulated targeted switchgrass integration in the agricultural state of Iowa, USA. For each combination, we modeled (i) corn/soybean area converted to switchgrass, (ii) switchgrass biomass production, and (iii) NO~3~-N leaching reduction. We spatially analyzed two scenarios: converting to switchgrass corn/soybean cropland losing > US\$ 100 ha^-1^ and leaching > 50 kg ha^-1^ ('conservative' scenario) or losing > US\$ 0 ha^-1^ and leaching > 20 kg ha^-1^ ('nutrient reduction' scenario). Compared to baseline, the 'conservative' scenario resulted in 12 % of cropland converted to switchgrass, which produced 11 million Mg of biomass and reduced leached NO~3~-N 18 % statewide. The 'nutrient reduction' scenario converted 37 % of cropland to switchgrass, producing 34 million Mg biomass and reducing leached NO~3~-N 38 % statewide. The opportunity to meet joint goals was greatest within watersheds with undulating topography and lower corn/soybean productivity. Our approach bridges the scales at which NO~3~-N loss and profitability are usually considered, and is informed by both mechanistic and empirical understanding. Though approximated, our analysis supports development of farm-level tools that can identify locations where both farm profitability and water quality improvement can be achieved through the strategic integration of perennial vegetation.

## Introduction


Downstream from major agricultural regions worldwide, eutrophication of marine coastal ecosystems has been exponentially increasing since industrially produced nitrogen fertilizer was introduced [@diaz2008spreading]. As a prominent example, nutrient pollution from cropland in the Mississippi River Basin has been exacerbating the ~ 15,000 km^2^ hypoxic zone in the Gulf of Mexico [@turner2003linking]. Over half of the nitrogen (N) delivered through this route originates from cropland cultivated with corn (*Zea mays* L.)  and soybeans (*Glycine max* (L.) Merr.) - the main crops grown in the US Midwest agricultural region. Efforts to decrease the hypoxic zone's 5 year average to under 5000 km^2^ were stipulated in a federal action plan [@river2008action]. When this goal was missed in 2015, it was moved to 2035 by the Hypoxia Task Force [-@htf2015report]. 

Iowa, a central agricultural state in the US Midwest Corn Belt, is the second largest contributor of eutrophying nutrients to the Gulf [@alexander2008differences] and plays a prominent role in nutrient reduction efforts. Agriculture is the most important industry in Iowa’s economy, commanding 85 % of land area to generate over 13 billion US\$ in outputs [@ers2017economic], and producing 10 % of U.S. corn exports at a value of 1.2 billion US$ in 2016 [@uscensus2016exports]. However, even highly productive cropland in Iowa has been unprofitable on average in recent years [@hart2015planting], throwing into sharp relief the often criticized practice of risking environmental quality for economic gain [@ucs2016case]. In addition to impacting aquatic life, nitrate-N (NO~3~-N) concentrations in drinking water pose a health threat to humans. In Iowa, the North Raccoon River Watershed gained scientific and public attention when the Des Moines Waterworks sued three of its counties under the federal Clean Water Act [@calt2017lawsuit; @epa2017cwa]. This watershed provides drinking water for the state's capital and is covered 80 % with corn and soybeans [@jones2011agricultural]. The lawsuit was ultimately dismissed, but set a precedent for arguing that tile drains carrying NO~3~-N-laden water constitute a “point source” of pollution where they empty into streams.  

To meet the Hypoxia Task Force goal, Iowa must reduce NO~3~-N in surface waters by 41 % [@inrs2013]. The strategy recommends a wide range of N conservation practices including converting annual cropland to perennial vegetation. In contrast to annual crops, perennial plants have more extensive root systems that intercept water and N for a larger portion of the year [e.g., @voigtl2012perennial]. Efforts have been made recently to develop landscape designs that meet agricultural needs while mitigating environmental risk through targeted placement of conservation management practices [@chaplin2016landscape; @mcconnell2011precision]. This precision conservation approach can potentially include perennial crops for sustainable cellulosic bioenergy production [@bonner2016development; @chaubey2016precision]. 

Because perennial cellulosic energy crops have multiple benefits to water and soil quality, they have been considered suitable for conservation purposes while providing feedstock for a growing bioeconomy [@tilman2009beneficial; @langholtz2016billion]. In fact, perennial crops such as giant miscanthus (*Miscanthus* x *giganteus* J.M.Greef & Deuter), switchgrass (*Panicum virgatum* L.), or diverse prairie species mixes reduced NO~3~-N more than 90% compared to corn-soybean rotations when planted on fertile soils  [@mcisaac2010miscanthus; @smith2013reduced; @daigh2015subsurface]. Switchgrass, a dominant species of native North American prairies, has been identified as a suitable bioenergy feedstock for the US bioeconomy [@mclaughlin2005development]. The recently registered variety "Liberty" has higher yields and better winter hardiness in the US Midwest than previously available varieties [@vogel2014registration]. The targeted replacement of corn/soybeans with "Liberty" switchgrass on low-performing cropland areas could help mitigate NO~3~-N loss in Iowa while also providing bioenergy feedstocks. 

Besides these field experiments, landscape-scale modeling studies to evaluate the environmental effects of integrated perennial bioenergy crops into US farmland have been conducted at the regional and national level. Currently the US diverts approximately 40 % of annual corn production to produce ethanol. @vanloocke2016din found that replacing 40 % of the land where corn is currently grown with cellulosic biomass crops in the Mississippi and Atchafalaya River Basin could reduce dissolved inorganic nitrogen (DIN) export to the Gulf of Mexico by 15 to 20 %. Simulating NO~3~-N leaching for scenarios in which 30 % of current corn fields are converted to second generation biofuel feedstocks, @davis2012impact found NO~3~-N leaching reduction of 15 to 22 % in the US Midwest region. Both studies provide high-level indications for water quality improvement, but were conducted on a scale too coarse to reflect farming units relevant for decision making. @vanloocke2016din suggest that integration of perennial grasses targeted to areas of low row crop productivity and high leaching rates could further increase surface water quality. However, this requires a modelling framework that includes spatial agronomic information and biochemistry processes at a finer resolution.

Despite their well-known environmental benefits, large tracts of perennial grasses were converted back to cropland in the past decade as farmers took advantage of record grain prices [@morefield2016grasslands; @lark2015cropland]. In practice, perceived socio-economic barriers prevent the implementation of urgently needed conservation management [@james2010profitability], but this perception may not always be accurate. For example, within a single corn field, @ssegane2015multifunctional showed that areas of low crop yield coincided with high NO~3~-N leaching due to low soil fertility related to high water infiltration. This and other research has highlighted the importance of within-field variability to management practices that balance economic and environmental performance [@muth2014profitability; @kyveryga2011late; @delgado2008advances]. @asbjornsen2014targeting suggested that strategically targeted placement of perennial crops or land cover can enhance ecological and socio-economic benefits from landscape disproportionate to the area they occupy. However, in contrast to the large-scale environmental modeling of perennial energy crops, studies on their strategic integration into annual crop land have focused on the local scale. There is a need to connect these scales to understand how precision conservation with perennial crops could affect environmental and economic performance of crop land. Fine resolution understanding is needed to enable on-farm decision making. Changes in on-farm decision making then need to be assessed at a larger geographic extent to understand their impacts on progress toward state nutrient reduction goals and federal biomass provisioning targets.  

Building on a recent profitability study that elucidated a path for an economically motivated management change on unprofitable subfield areas in Iowa [@brandes2016subfield], here we next investigate how the integration of a high yielding variety of a dedicated bioenergy crop, Liberty Switchgrass, can diversify the agricultural landscape and enhance ecosystem services in the highly simplified Iowa corn/soybean agroecosystem. We present a novel approach to precision conservation and perennial integration that places switchgrass on cropland that is the least profitable for growing row crops, using a three-way comparison:
   
- Baseline, in which we estimated the profitability and NO~3~-N leaching from  cropland in corn and/or soybeans between 2012 and 2015

- A 'conservative' scenario, in which we quantified the expected change in NO~3~-N leaching associated with converting the most unprofitable cropland to switchgrass; and,

- A 'nutrient reduction' scenario, in which we identified a spatial configuration that nearly achieves the Iowa N reduction goal (41 %) through dedicated biomass production.

Within these two alternative scenarios, we identify areas in Iowa where switchgrass integration will make the largest environmental impact and how much dedicated energy crop would be produced. We elucidate the extent and limitations of NO~3~-N leaching reduction that can be expected from using profitability constraints to motivate crop choice. We focus on the litigated Upper North Raccoon River Watershed as an example impaired watershed to assess potential mitigation efforts and their effectiveness. Our scenarios represent three points along a broad spectrum of possible schemes for the strategic integration of perennials in landscapes dominated by annual crops.

## Materials and Methods

### Methods summary

Using publicly available data, we combined a subfield profitability analysis with the Landscape Environmental Assessment Framework (LEAF) developed by @muth2013integrated to assess environmental impacts of land management (Fig. 1). LEAF integrates several data sources and environmental models into a scalable compute infrastructure that supports large numbers of simulations to be performed in parallel within a practical turn-around time. The DeNitrification-DeComposition model [DNDC; @li1992model] was integrated into LEAF to enable carbon (C) and N analysis across large spatial extents and soil texture variations. We calculated subfield level profitability by accounting input costs and revenues, and estimated NO~3~-N leaching with DNDC for all cropland that was continuously in corn and/or soybeans 2012-2015. This became our baseline, business as usual scenario. Then we calculated the same metrics using a cropping system of 10 years switchgrass of three different biomass yields. We tested the sensitivity of three model outcomes for Iowa (% area in switchgrass, total biomass production, and relative NO~3~-N leaching reduction) to management change motivated by both NO~3~-N leaching and profitability thresholds. The only management change we considered was crop choice between corn/soybean or switchgrass. We did not assess changes expected from other alternative crops, nor from changes in rate, timing, or amount of N fertilizer.

```{r framework_figure, fig.cap="Figure 1: Schematic overview of the computational framework used to produce subfield profitability and biogeochemistry maps for Iowa. The left column of boxes describe the spatial resolution of input data. The column to the right lists the input data for the profitability calculation (green boxes), the DNDC model (blue boxes), and data used for both analyses (black box). The boxes framed with the dash-dotted line include data and processes within the Landscape Environmental Assessment Framework [@muth2013integrated]. The boxes on the right illustrate the output maps for two analyses. See @brandes2016subfield for detailed profitability calculation methods."}
include_graphics("imported_images/fig1.tif", dpi = 300)
```


### Spatial data

We included all Iowa cropland that was in continuous corn or soybeans between 2012 and 2015. Subfield units were created by intersecting the latest available common land use (CLU) boundaries [@usda2008clu] with the National Soil Survey map unit delineations [@nrcs2016soil]. Crop cover for each year was identified for each CLU polygon from the respective cropland data layer (CDL) rasters of 30 m resolution [@nass2016cdl] as described in @gelder2008automated. With this approach we generated ~3.6 million unique potential management units defined by their soil characteristics, field association, and sequence of crop rotation. 

### Economic analysis of corn/soybeans

We performed a profitability analysis on a subfield resolution following the methods in @brandes2016subfield. Briefly, we estimated the profitability of each subfield polygon, defined by field boundaries (CLU) and soil characteristics (Soil Survey), taking into account crop rotation (corn following corn, corn following soybeans, and soybeans following corn), the respective crop production costs, cash rents, yields, and grain prices for each year.
We derived potential crop yields from the Corn Suitability Rating (CSR2), an index specific to Iowa that integrates a number of soil characteristics and an expert judgement correction factor  [@burras2015csr2], using a linear function [@sassman2015ispaid]. To include spatial and temporal yield variability, we scaled the potential yields to county averages reported by the National Agricultural Statistics Service [@nass2016stats]. To estimate field-scale cash rents, we scaled county averages reported in annual surveys performed by Iowa State University Extension and Outreach [@plastina2016rents] to CSR2 (subfield scale) and then calculated field averages [see details in @brandes2016subfield].

### DNDC model description

DNDC is a process-based, field-scale biogeochemistry model for agricultural systems that estimates the N and C mass balances at a daily time step. Processes are simulated in the six sub-models: soil climate, plant growth, decomposition, denitrification, nitrification, and fermentation. The main inputs driving the model are climate, soil, vegetation, and management practices (table 1). An overview of the model is described in @tonitto2010application. DNDC had been previously parameterized and calibrated for switchgrass using yield data from a field site at Urbana, Illinois [@gopalakrishnan2012modeling] and evaluated against leaching data on a row crop field in Iowa [@li2006modeling]. To estimate NO~3~-N leaching at a spatial resolution relevant for decision makers, we applied the DNDC model at a subfield level across Iowa. The ~3.6 million subfield units contained 112,000 unique crop rotation-soil combinations in the baseline scenario. Each combination generated a unique model output for the four years. For the switchgrass modeling, subfield units were only distinguished by soil characteristics, resulting in 30,000 unique model outputs. We performed four model runs for Iowa cropland. We used the corn/soybean yields estimated for the economic analysis as described in @brandes2016subfield as input data, while modeled yields served as a check. To focus on water quality, we extracted the model results for NO~3~-N leaching and ammonia volatilization, an output closely connected to leaching through the pH-dependent balance between soil-water dissolved ammonium and gaseous ammonia, and the microbial process of nitrification. The first run modeled the baseline scenario in Iowa and included all fields consecutively managed for corn and/or soybeans between 2012 and 2015. This data set referred to the same spatial layer as the profitability analysis described above. The following three runs modeled the nutrient mass balance for switchgrass on the same area for 10 years (2006-2015) and included a sensitivity analysis assuming low (7,500 kg ha^-1^), medium (10,000 kg ha^-1^), and high (12,500 kg ha^-1^) switchgrass yields. 

Model inputs included climate data from Daymet [@thornton2016daymet] on a 1 km resolution aggregated to the county-level by using each county's centroid's data point; soil characteristics (texture, pH, clay/sand fraction, initial soil organic carbon, porosity, and bulk density) of the top 10 cm from the National Soil Survey Geographic Database [SSURGO, @nrcs2016soil]; and crop management practices adapted from common practices in Iowa for row crops and from recommendations for switchgrass (Table 1). Crop parameters are listed in Table 2. Specific model outputs include soil organic carbon (SOC) change, NO~3~-N leaching, and trace gas emissions such as carbon dioxide, methane, ammonia, nitric oxide, nitrous oxide, and dinitrogen.

```{r management_table}
manage <- read.table("./tables/crop_management.txt", header = TRUE, sep = "\t", fill = TRUE)[,1:4]

manage$N_kg_ha <- as.character(manage$N_kg_ha)
manage$N_kg_ha[is.na(manage$N_kg_ha)] <- " " 
  


kable(manage, digits = 2, col.names=c("Cropping System", "N applied (kg ha^-1^)","Date", "Activity"), align = c('l', 'c', 'l', 'l'), caption="Table 1: Crop management data used in the DNDC model." )

```

```{r parameter_table}
para <- read.table("./tables/crop_parameters.txt", header = TRUE, sep = "\t", fill = TRUE)[,1:4]


kable(para, digits = 2, col.names=c(" ", "Corn", "Soybeans", "Switchgrass"), align = c('l', 'l', 'l', 'l'), caption="Table 2: Crop and environmental data and parameters used in the DNDC model.")

```


### Statewide switchgrass integration threshold combinations
In the management decision framework presented in this study, subfield areas with the lowest profit and highest NO~3~-N leaching in the baseline scenario were targeted for switchgrass integration. We constructed a factorial combination of profitability and NO~3~-N leaching thresholds, covering the range of 2012-2015 mean profitability (US\$ -800 ha^-1^ to US\$ 700 ha^-1^, by steps of US\$ 100 ha^-1^) as well as the range of 2012-2015 mean NO~3~-N leaching (0 - 150 kg ha^-1^, by steps of 10 kg ha^-1^), resulting in 256 (16 x 16) distinct combinations. To visualize the statewide outcomes for each threshold combination, we displayed them as a surface in a two-dimensional decision matrix of the two factors (Fig. 6). Since the statewide model outcomes showed a low sensitivity to switchgrass yield (Fig. S5), we created the decision matrix and performed further analysis only with the medium switchgrass yield of 10,000 kg ha^-1^. We examined the statewide model outcomes for (i) relative cropland area converted to switchgrass, (ii) biomass production from switchgrass, and (iii) relative NO~3~-N leaching reduction, as a function of both profitability and NO~3~-N leaching threshold decision points.  

### Scenario selection from threshold combinations
From the possible combinations of profitability and NO~3~-N leaching levels that could be used as decision-making thresholds for changing from grain to switchgrass, we selected two cases to analyze in further detail. We designated all cropland that lost more than US$ 100 ha^-1^ y^-1^ on average over the four years considered as highly unprofitable land. The 'conservative' scenario converted all of that highly unprofitable land (profitability of < US\$ -100 ha^-1^) that also had NO~3~-N leaching of > 50 kg N ha^-1^ to switchgrass. These thresholds are below the median value of statewide profitability and above the median leached NO~3~-N. The intent in the 'conservative' scenario was to convert only land of high economic and environmental risk under the corn/soybean status quo that therefore offered substantial opportunity for economic and environmental improvement. To identify spatially aggregated areas with high potential for water quality improvement we compared 'conservative scenario' results to the baseline on a county resolution. By contrast, the intent with the 'nutrient reduction' scenario was to reach a substantial portion of the NO~3~-N leaching reduction goal (41 %) set in the Iowa Nutrient Reduction Strategy to meet Hypoxia Task Force targets. To do so, we assessed conversion of all unprofitable corn/soybean cropland (profitability < US\$ 0 ha^-1^) that also leached > 20 kg ha^-1^ to switchgrass. We also studied the impaired upper part of the North Raccoon River Watershed that was recently the subject of lawsuits to assess the impact of targeted perennial integration to improve water quality overall in Iowa.

## Results

### Profitability and NO~3~-N leached: baseline scenario

Mean profitability in 2012-2015 ranged from US\$ -478 ha^-1^ to US\$ 385 ha^-1^ on 95 % of cropland (disregarding the lowest and highest 2.5 %, respectively) with a median of US$ 53 ha^-1^. Twenty-three percent of cropland lost > US\$ 100 ha^-1^ on average (Fig. 2a). Aggregating these areas of highly unprofitable cropland to the county level revealed spatial heterogeneity in its relative and absolute extent across Iowa. The counties with the most highly unprofitable land were in west and central Iowa. Those with the highest relative areas (i.e., the proportion of the county’s total corn/soybean cropland that was unprofitable) were in the west, central, and south part of the state (Fig. 3). NO~3~-N leached ranged from 13 to 114 kg N ha^-1^, when disregarding the 2.5 % of lowest and highest leaching cropland, respectively, with a median of 41 kg N ha^-1^ (Fig. 2b). ). Thirty-seven percent of considered cropland leached > 50 kg N ha-1, on average. The spatial pattern of NO~3~-N leached in Iowa shows highest leaching in the counties on the Des Moines Lobe Landform (Fig. S7) and in the north east of the state (Fig. 4). The relationship between mean profitability and mean NO~3~-N leaching is characterized by an increased variability in leached NO~3~-N with decreasing profitability (Fig. 5).





```{r connect_dplyr}

# with dplyr:
pw <- "angst-vrpFhB" # enter password here
HeatonAgsolver_db <- src_postgres(dbname = 'AgSolver',
                           host = 'heatonagsolver.cv5vlzyvdngx.us-east-1.rds.amazonaws.com',
                           port = 5432,
                           user = 'heatonlab',
                           password = pw)
```

```{r, connect_rpostgres}

# With RPostgreSQL:
drv <- dbDriver("PostgreSQL") # loads the PostgreSQL driver
con <- dbConnect(drv, dbname = "AgSolver",  # creates a connection to the postgres database
                 host = "heatonagsolver.cv5vlzyvdngx.us-east-1.rds.amazonaws.com", port = 5432,
                 user = "heatonlab", password = pw)
# note that "con" will be used later in each connection to the database
```

```{r theme}
# I am using a modified theme for ggplot adjusted to GCBB requirements
# black border and white background
# tick marks inwards
# ...


theme_b_border <- function (base_size = 12, base_family = "") 
{
  theme_grey(base_size = base_size, base_family = base_family) %+replace% 
    theme(
      axis.text = element_text(size = rel(0.8), margin = margin(r=10)), #margin 
      axis.ticks = element_line(colour = "black"),
      axis.ticks.length = unit(0.15, "cm"),
      legend.key = element_rect(colour = NA), panel.background = element_rect(fill = "white", 
      colour = NA), panel.border = element_rect(fill = NA, 
      colour = "black"), panel.grid.major = element_line(colour = NA, 
      size = 0.2), panel.grid.minor = element_line(colour = NA, 
      size = 0.5), strip.background = element_rect(fill = "grey80", 
      colour = "grey50", size = 0.2))
}

theme_gcbb <- function (base_size = 12, base_family = "") 
{
  theme_grey(base_size = base_size, base_family = base_family) %+replace% 
    theme(
      # axis.title.x = element_text(margin = margin(r = 10)),
      # axis.title.y = element_text(margin = margin(r = 10)),      
      axis.text = element_text(size = rel(0.8)),  
      axis.text.x = element_text(margin=unit(c(0.3,0.3,0.3,0.3), "cm")),
      axis.text.y = element_text(margin=unit(c(0.3,0.3,0.3,0.3), "cm")),
      axis.ticks = element_line(colour = "black"),
      axis.ticks.length = unit(-0.15, "cm"),
      legend.key = element_rect(colour = NA), 
      panel.background = element_rect(fill = "white", colour = NA), 
      panel.border = element_rect(fill = NA, colour = "black", size = 0.5), 
      panel.grid.major = element_line(colour = NA, size = 0.2), 
      panel.grid.minor = element_line(colour = NA, size = 0.5), 
      strip.background = element_rect(fill = "grey80", colour = "black"), 
      strip.text = element_text(size=rel(0.8)))
}

# I am using a modified filled contour plot function for the figure that shows switchgrass area as a function of cut off values:

filled.contour3 <-
  function (x = seq(0, 1, length.out = nrow(z)),
            y = seq(0, 1, length.out = ncol(z)), z, xlim = range(x, finite = TRUE), 
            ylim = range(y, finite = TRUE), zlim = range(z, finite = TRUE), 
            levels = pretty(zlim, nlevels), nlevels = 20, color.palette = cm.colors, 
            col = color.palette(length(levels) - 1), plot.title, plot.axes, 
            key.title, key.axes, asp = NA, xaxs = "i", yaxs = "i", las = 1, 
            axes = TRUE, frame.plot = axes,mar, ...) 
{
  # modification by Ian Taylor of the filled.contour function
  # to remove the key and facilitate overplotting with contour()
  # further modified by Carey McGilliard and Bridget Ferris
  # to allow multiple plots on one page

  if (missing(z)) {
    if (!missing(x)) {
      if (is.list(x)) {
        z <- x$z
        y <- x$y
        x <- x$x
      }
      else {
        z <- x
        x <- seq.int(0, 1, length.out = nrow(z))
      }
    }
    else stop("no 'z' matrix specified")
  }
  else if (is.list(x)) {
    y <- x$y
    x <- x$x
  }
  if (any(diff(x) <= 0) || any(diff(y) <= 0)) 
    stop("increasing 'x' and 'y' values expected")
 # mar.orig <- (par.orig <- par(c("mar", "las", "mfrow")))$mar
 # on.exit(par(par.orig))
 # w <- (3 + mar.orig[2]) * par("csi") * 2.54
 # par(las = las)
 # mar <- mar.orig
 plot.new()
 # par(mar=mar)
  plot.window(xlim, ylim, "", xaxs = xaxs, yaxs = yaxs, asp = asp)
  if (!is.matrix(z) || nrow(z) <= 1 || ncol(z) <= 1) 
    stop("no proper 'z' matrix specified")
  if (!is.double(z)) 
    storage.mode(z) <- "double"
    # modified from the original code: changed from .Internal(filledcontour(...)) to:
  .filled.contour(as.double(x), as.double(y), z, as.double(levels), 
                          col = col)
  if (missing(plot.axes)) {
    if (axes) {
      title(main = "", xlab = "", ylab = "")
      Axis(x, side = 1)
      Axis(y, side = 2)
    }
  }
  else plot.axes
  if (frame.plot) 
    box()
  if (missing(plot.title)) 
    title(...)
  else plot.title
  invisible()
}
```



```{r profit_distribution, fig.width=8, fig.height=3, fig.cap="Figure 2: Baseline distributions of mean profitability (a) and mean NO~3~-N leaching (b) on Iowa cropland in corn and soybean production between 2012 and 2015. The blue shaded boxes include the areas below the US$ -100 ha^-1^ profitability threshold (a) and above the 50 kg ha^-1^ leaching threshold (b) used in the 'conservative' scenario. The dashed lines mark the lowest and highest 2.5 % of values. The dotted lines mark the medians. "}

# data for profit distribution:
profit = tbl(HeatonAgsolver_db, "profit_mean_2012_2015_aggregated") %>%
  as.data.frame()
profit$area_Mha <- profit$area_ha * 1e-6  # convert to Mha

# statistics:
percentiles <- Hmisc::wtd.quantile(profit[-1,1], weights = profit[-1,2], probs = c(.025, .975), na.rm = TRUE, normwt=TRUE)
median_cgsb_profit <- weightedMedian(profit[-1,1], w=profit[-1,2])



# plot profit distribution:
plot_profit <- ggplot(data = profit, aes(profit_ha_rounded, weight = area_Mha)) +
  geom_histogram(binwidth=20, alpha = .5, position="identity") +
  annotate("rect", xmin=-Inf, xmax = -100, ymin = 0, ymax = Inf, alpha= 0.3, fill = "blue") +
  theme_gcbb() +
  labs(x=expression(Mean~profitability~("US$"~ha^{-1}~yr^{-1})),
       y=expression(Area~(Mha))) +
  scale_x_continuous(lim = c(-1000,1000)) +
  scale_y_continuous() +
  annotate("text", x = -970, y = .4, label = "(a)", size = 5) +
  geom_vline(aes(xintercept= -100), linetype= "solid", show.legend = FALSE) +
  geom_vline(aes(xintercept = percentiles[1]), linetype = "dashed", show.legend = FALSE) +
  geom_vline(aes(xintercept = percentiles[2]), linetype = "dashed", show.legend = FALSE) +
  geom_vline(aes(xintercept = median_cgsb_profit), linetype = "dotted", show.legend = FALSE) 


# data for leaching distribution:
cgsb_no3_leach <-tbl(HeatonAgsolver_db, "06_cgsb_ave_no3_leach_rounded_aggr")  %>%
  as.data.frame()
cgsb_no3_leach$area_Mha <- cgsb_no3_leach$area_ha * 1e-6  # convert to Mha

# stats:
percentiles_leach <- Hmisc::wtd.quantile(cgsb_no3_leach[-1,1], weights = cgsb_no3_leach[-1,2], probs = c(.025, .975), na.rm = TRUE, normwt=TRUE)
median_cgsb_leach <- weightedMedian(cgsb_no3_leach[-1,1], w=cgsb_no3_leach[-1,2])

# plot leaching distribution:
plot_leach <- ggplot(cgsb_no3_leach, aes(ave_no3_leach_cgsb_round, weight = area_Mha)) +
  geom_histogram(binwidth=2, alpha = .5, position="identity") +
  annotate("rect", xmin = 50, xmax = Inf, ymin = 0, ymax = Inf, alpha= 0.3, fill = "blue") +
  theme_gcbb() +
  labs(x=expression(Mean~NO[3]-N~leaching~(kg~N~ha^{-1}~yr^{-1})),
       y=expression(Area~(Mha))) +
  scale_x_continuous(lim = c(-1,200)) +
  scale_y_continuous() +
  annotate("text", x = 3.5, y = .52, label = "(b)", size = 5) +
  geom_vline(aes(xintercept= 50), linetype= "solid", show.legend = FALSE) +
  geom_vline(aes(xintercept = percentiles_leach[1]), linetype = "dashed", show.legend = FALSE) +
  geom_vline(aes(xintercept = percentiles_leach[2]), linetype = "dashed", show.legend = FALSE) +
  geom_vline(aes(xintercept = median_cgsb_leach), linetype = "dotted", show.legend = FALSE)  

png('fig2.tiff', width = 169, height = 80, units = "mm", res = 300)

grid.arrange(plot_profit, plot_leach, ncol=2)

dev.off() 
```


```{r profit_spatial, include= FALSE}
counties <- readOGR(dsn="shapefiles/county.shp",layer="county")
names(counties)[9] <- "fips" 

profit_county <- tbl(HeatonAgsolver_db, "07_unprofit_counties") %>%
  as.data.frame() 

 for (i in 1:length(profit_county$fips)) {
   profit_county$fips[i] <- sub("IA", "19", profit_county$fips[i])
    }

counties@data <- left_join(counties@data, profit_county, by = "fips")
counties_df <- fortify(counties)
counties$id <- row.names(counties) 
counties_profit_df <- left_join(counties_df, counties@data)

# add a spatial data frame with the county centroids, to be used to plot the total leaching N per county:
centroids <- getSpPPolygonsLabptSlots(counties) %>%
  as.data.frame() 

centroids$id <- as.character(0:98)

# join the total N leaching data to the centroids 
counties_profit_df <- left_join(counties_profit_df, centroids)

# create a theme without axes and without border:
ditch_the_axes <- theme(
  axis.text = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.border = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank()
  )

# create a theme without axes but with border (for facet plots):
ditch_the_axes_with_border <- theme(
  axis.text = element_blank(),
  axis.line = element_blank(),
  axis.ticks = element_blank(),
  panel.grid = element_blank(),
  axis.title = element_blank()
  )
```

```{r figure_profit, fig.height=4, fig.width=9,  fig.cap="Figure 3: Area of corn and soybean cropland in Iowa with a mean 2012-2015 profitability of < US$ -100 ha^-1^ per county in the baseline scenario. Cardinal circles show the absolute amount of land, gold shades indicate the relative area  per county."}
ggplot() +
  geom_polygon(data = counties_profit_df, aes(long, lat, group = group, fill=area_in_swg_perc), color = "grey") +
  geom_point(data = counties_profit_df, aes(V1, V2, size = area_in_swg), color = "#C8102E") +
  labs(size = expression(Total~area~losing~"US$"~">100"~ha^{-1}~yr^{-1})) +
  coord_equal() +
  theme_gcbb() +
  ditch_the_axes +
  labs(fill = expression(Relative~area~losing~"US$"~">100"~ha^{-1}~yr^{-1}~("%"))) +
  scale_fill_gradient(low = "white", high="#F1BE48", guide = "colourbar") 
```

```{r counties_attributes}
 counties_no3_leach = tbl(HeatonAgsolver_db, "07_dndc_counties") %>%
   as.data.frame()
 # change the data in the column named "FIPS", so that is contains the county identifiers in the same format as the spatial file:
 for (i in 1:length(counties_no3_leach$fips)) {
   counties_no3_leach$fips[i] <- sub("IA", "19", counties_no3_leach$fips[i])
    }
 # make it a factor
  counties_no3_leach$fips <- as.factor(counties_no3_leach$fips)
```

```{r counties_spatial, include=FALSE, cache=TRUE}
counties <- readOGR(dsn="shapefiles/county.shp",layer="county")
names(counties)[9] <- "fips" # change to lower case so that we can join on this field later on

# join the attribute data with the spatial data, using a left join and the identifier "fips":
counties@data <- left_join(counties@data, counties_no3_leach, by = "fips")
counties_df <- fortify(counties) # this creates the data frame but loses the previously joined data
counties$id <- row.names(counties) # assign a column with the variable ID that is equal to the row names (=numbers), starting with 0.

```

```{r counties_centroids, warning=FALSE, message=FALSE, cache=TRUE} 
# add a spatial data frame with the county centroids, to be used to plot the total leaching N per county:
centroids <- getSpPPolygonsLabptSlots(counties) %>%
  as.data.frame() 
centroids$id <- as.character(0:98)
```

```{r data_n_loss_maps}
# set up the data frame 
counties_swg <- data.frame(id = rep(counties$id,3),
                         scenario = factor(c(rep(1, length(counties$id)), rep(2, length(counties$id)), 
                                                                               rep(3, length(counties$id))), levels = c(1,2,3), labels = c("baseline", "conservative", "nutrient reduction")),
                         tot_no3_leach = c(counties$tot_no3_leach_cgsb, counties$tot_no3_leach_10000_1,
                                           counties$tot_no3_leach_10000_2),
                         ave_no3_leach = c(counties$ave_no3_leach_cgsb, counties$ave_no3_leach_10000_1, counties$ave_no3_leach_10000_2),
                         no3_leach_red = c(rep(0,length(counties$id)), counties$no3_leach_change_10000_1,
                                       counties$no3_leach_change_10000_2))

# join data frame with the data frame extracted out of the spatial data frame
counties_swg_df <- left_join(counties_df, counties_swg, by = "id") %>%
  left_join(centroids)
```

```{r plot_n_loss_map, cache = TRUE, fig.width=8, fig.height=4, fig.cap = "Figure 4: Total (yellow circles) and mean (green shades) NO~3~-N leached annually from corn and soybean cropland in Iowa by county, averaged over 2012-2015, in the baseline scenario."}

counties_baseline_df <- filter(counties_swg_df, scenario == "baseline")

ggplot(counties_baseline_df) +
  geom_polygon(aes(long, lat, group = group, fill=ave_no3_leach), color = "grey") +
  scale_fill_gradient(low = "white", high="dark green", guide = "colourbar") +  
  labs(fill = expression(atop(Mean~annual~NO[3]-N, paste("leached (kg N ha"^{-1}~yr^{-1},")")))) +  
  geom_point(aes(V1, V2, size = tot_no3_leach), color = "yellow") +
  labs(size = expression(Total~leached~NO[3]-N~(Mg~N~yr^{-1}))) +
  scale_size(range = c(0, 6)) +
  coord_equal() +
  theme_gcbb() +
  ditch_the_axes 
```

```{sql, connection=con, cache=TRUE, include=FALSE}
SELECT setseed(0.5)
```

```{sql, connection=con}
CREATE TABLE "r_dndc_clumu_cgsb_swg_sample" AS SELECT mean_profit_ha, ave_no3_leach_ha_cgsb FROM "05_dndc_clumu_cgsb_swg" ORDER BY random() LIMIT 10000
```
```{r data_sample_n_loss}
sample_leach <- tbl(HeatonAgsolver_db, "r_dndc_clumu_cgsb_swg_sample") %>%
  as.data.frame(sample)
```

```{r scatterplot_no3_leach, fig.width=4.5, fig.height=3, fig.cap="Figure 5: Scatterplot of a subsample (n=10,000) of subfield areas, showing profitability and NO~3~-N leached in the baseline scenario (mean values for corn and soybean fields 2012-2015) in Iowa. The red lines and shaded areas indicate the threshold values for the 'conservative' scenario (solid lines and deep red shade: < US$ -100 ha^-1^ profitability and > 50 kg N ha^-1^ NO~3~-N leached) and for the 'nutrient reduction' scenario (dashed lines and light red shade: < US$ 0 ha^-1^ profitability and > 20 kg N ha^-1^ NO~3~-N leached)."}
ggplot() +
  geom_rect(aes(xmin = -Inf, xmax = -100, ymin = 50, ymax = Inf), fill = "red", alpha= 0.3) +
  geom_rect(aes(xmin = -Inf, xmax = 0, ymin = 20, ymax = Inf), fill = "red", alpha= 0.2) +
  geom_point(data = sample_leach, aes(x = mean_profit_ha, y = ave_no3_leach_ha_cgsb), alpha = .2, stroke=0) +
  theme_gcbb() +
  labs(y=expression(NO[3]^{"-"}~leaching~(kg~N~ha^{-1}~yr^{-1})),
       x=expression(Profitability~("US$"~ha^{-1}~yr^{-1}))) +
  geom_vline(xintercept= -100, linetype= "solid", color = "red",  show.legend = FALSE) +
  geom_hline(yintercept= 50, linetype= "solid", color = "red",  show.legend = FALSE) +
    geom_vline(xintercept= 0, linetype= "dashed", color = "red",  show.legend = FALSE) +
  geom_hline(yintercept= 20, linetype= "dashed", color = "red",  show.legend = FALSE) 

  
```

### Profitability, NO~3~-N loss, and biomass provisioning: switchgrass integration scenarios vs. baseline

Baseline analysis indicated that, on average, 12 % of total Iowa corn/soybean cropland met our constraints for the 'conservative' scenario; that is, it annually lost > US\$ 100 and concomitantly leached > 50 kg N per hectare. This cropland was converted to switchgrass in the 'conservative' scenario. In total, statewide mean annual NO~3~-N leached from cropland in corn/soybeans between 2012 and 2015 amounted to 0.45 million Mg N lost. On average, converting all those areas losing > US\$ 100 ha^-1^ and leaching > 50 kg N ha^-1^  to switchgrass would reduce statewide NO~3~-N leaching by 17.6, 18.4, and 18.8 % at assumed low, medium, and high switchgrass yields, respectively (Table 3). Because of the low sensitivity of model outcomes to switchgrass yield (Table 3, Fig. S6), we conducted further analysis on the medium yield data set only.




```{r table_no3_leach_reduction}
no3_leach_tot <-tbl(HeatonAgsolver_db, "05_dndc_no3_leach_sums_iowa_scenarios")  %>%
  as.data.frame()
no3_leach_tot_base <- no3_leach_tot[,1]
no3_leach_tot_cons <- round(c(no3_leach_tot[,2], no3_leach_tot[,3], no3_leach_tot[,4]),0)
no3_leach_tot_nutred <- round(c(no3_leach_tot[,5], no3_leach_tot[,6],no3_leach_tot[,7]),0)
no3_red_cons <- round((no3_leach_tot_base - no3_leach_tot_cons)*100 / no3_leach_tot_base, 1)
no3_red_nutred <- round((no3_leach_tot_base - no3_leach_tot_nutred)*100 / no3_leach_tot_base, 1)

no3_table <- data.frame(swg_yield = c(7500, 10000, 12500),
                          no3_leach_tot_cons, no3_red_cons, no3_leach_tot_nutred, no3_red_nutred)


kable(no3_table, digits = 1, format.args = list(big.mark = ','), col.names=c("Switchgrass yield (Mg ha^-1^)", "'Conservative' abs. leaching (Mg)", "'Conservative' rel. leaching red. (%)", "'Nutrient reduction' abs. leaching (Mg)", "'Nutrient reduction' rel. leaching red. (%)"), caption="Table 3: Average annual NO~3~-N leached (in Mg N) and NO~3~-N leaching reduction with switchgrass integration relative to the baseline (%) in Iowa as modelled with DNDC. Results are shown for the 'conservative' and 'nutrient reduction' scenario under three different switchgrass yield assumptions. statewide mean annual NO~3~-N leached from cropland in corn/soybeans was 0.45 million Mg N.")

```

We found that moving the decision thresholds toward higher profitability and lower leaching values (i.e., targeting increasingly better cropland for conversion to switchgrass) resulted in successively more area in switchgrass, more switchgrass biomass produced, and less NO~3~-N leached statewide (Fig. 6, S4). The contour plots (Fig. S4) serve as a tool to look up a model outcome value visualized as the "elevation" for the corresponding threshold for profitability and NO~3~-N leaching. At the medium assumed yield for switchgrass, the 'conservative' scenario resulted in 11.3 million Mg of switchgrass biomass produced and an 18.4 % reduction in NO~3~-N leached annually. The 'nutrient reduction' scenario, which converted cropland of mean profitability < US\$ 0 ha^-1^ and NO~3~-N leaching > 20 kg ha^-1^, resulted in 36.6 % of cropland converted to switchgrass, producing 34.3 million Mg biomass, and reducing NO~3~-N leaching by 38.1 % over the baseline (dashed and solid lines in Fig. S4, all scenario results in Tables S1-S3). Even though the 'nutrient reduction' scenario does not provide the 41 % reduction required in the Nutrient Reduction Strategy, we used it for subsequent analysis because reaching 41 % would require conversion of profitable corn/soybean cropland to switchgrass (Fig. S4), and violate the profit-driven tenet of our approach. 


```{r swg_areas_two_thresholds_prepare, cache=TRUE}
# In this chunk, the areas in switchgrass are calculated for all possible combinations of 
# profitability and N loss cut offs.

# swg_areas <- vector(mode="numeric", length=0)
profit_cutoffs_16 <- c(-800, -700, -600, -500, -400, -300, -200, -100, 0, 100, 200, 300, 400, 500, 600, 700)
n_loss_cutoffs_16 <- c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100, 110, 120, 130, 140, 150)

# make a cartesian product of the two vectors first:
# function (from https://www.r-bloggers.com/nested-loops-with-mapply/)
CartProduct = function(vector_1, vector_2)
{
 
  if (length(dim(vector_2)) != 0 )
  {
    warning("New vector has more than one dimension.")
    return (NULL)
  }
 
  if (length(dim(vector_1)) == 0)
  {
    CurrentRows = length(vector_1)
    vector_1 = as.matrix(vector_1, nrow = CurrentRows, ncol = 1)
  } else {
    CurrentRows = nrow(vector_1)
  }
 
  var1 = replicate(length(vector_2), vector_1, simplify=F)
  var1 = do.call("rbind", var1)
 
  var2 = rep(vector_2, CurrentRows)
  var2 = matrix(var2[order(var2)], nrow = length(var2), ncol = 1)
 
  CartProduct = cbind(var1, var2)
  return (CartProduct)
}

comb <- CartProduct(profit_cutoffs_16, n_loss_cutoffs_16)

# write a function that uses each of the combinations, using the matrix returned from the function CartProduct:
area_select <- function(cutoff_1, cutoff_2)
{ query <- paste("SELECT SUM(clumuha) FROM \"05_dndc_clumu_cgsb_swg\" WHERE mean_profit_ha < ", as.character(cutoff_1), "AND ave_no3_leach_ha_cgsb > ", as.character(cutoff_2))
    sum_area <- tbl(HeatonAgsolver_db, sql(query)) %>%
      as.data.frame()
    sum_area <- sum_area[1,1]
    return(sum_area)
}
```

```{r swg_areas_two_thresholds, cache=TRUE}
# apply the function to each value in the matrix
swg_areas <- mapply(area_select, comb[,1], comb[,2])


# combine the cut off values with the area in switchgrass in a data frame
swg_areas <- data.frame(profit_cut = comb[,1],
                        no3_leach_cut = comb[,2],
                        swg_areas) 

```

```{r no3_leach_function, cache=TRUE}

# write a function that uses each of the cut off combinations and calculates the total NO3 leaching in this scenario:
no3_leach_select <- function(cutoff_1, cutoff_2)
{query <- paste("SELECT (sum((CASE WHEN mean_profit_ha <" , as.character(cutoff_1), " AND ave_no3_leach_ha_cgsb > ",  as.character(cutoff_2), " THEN ave_no3_leach_ha_swg_10000  ELSE ave_no3_leach_ha_cgsb END) * clumuha)) / 1000 FROM \"05_dndc_clumu_cgsb_swg\" ")
    sum_no3_leach <- tbl(HeatonAgsolver_db, sql(query)) %>%
      as.data.frame()
    sum_no3_leach <- sum_no3_leach[1,1]
    return(sum_no3_leach)
}

# this is the SQL query that selects for each polygon the value of cgsb or swg, depending on its cgsb NO3 leaching and profit value, 
# and sums all values up 
# to get a Iowa wide NO3 leaching value (absolute), that can then substracted from the baseline NO3 leaching.

```

```{r no3_leach_two_thresholds, cache=TRUE}

# apply the function to each value in the matrix
tot_no3_leach <- mapply(no3_leach_select, comb[,1], comb[,2])

# combine the cut off values with the area in switchgrass in a data frame
swg_no3_leach <- data.frame(profit_cut = comb[,1],
                        no3_leach_cut = comb[,2],
                        tot_no3_leach) 


```


```{r area_surfaceplot, cache = TRUE, fig.height=9, fig.width=10,  fig.cap="Figure 6: statewide aggregated model outputs for (a) area converted to switchgrass, (b) biomass production, assuming a 10,000 kg ha^-1^ switchgrass yield, and (c) NO~3~-N leaching reduction, as a function of profitability and N management decisions. Each corner in the surface grid represents an output value under a given combination of NO~3~-N leaching threshold (the value in kg N ha^-1^ above which the area would be converted to switchgrass) and profitability threshold (the value in US$ ha^-1^ below which the area would be converted to switchgrass)."}

x <- profit_cutoffs_16 
y <- n_loss_cutoffs_16

# create a matrix out of the z values (in Mha):
swg_matrix <- matrix(swg_areas[,3] * 1e-6
, nrow=16, ncol=16)
#calculate % of total cropland (9373430 ha), the total ha number comes from the SQL database qurey:
# select sum(clumuha) from "05_dndc_clumu_cgsb_swg" where ave_no3_leach_ha_cgsb is not null;
# so it is the area of cropland where leaching was estimated with DNDC.
tot_area <- 9.373430
swg_matrix_perc <- (swg_matrix/tot_area)*100
z <- swg_matrix_perc

# create figure with three plots 
plot.new()

#I am organizing where the plots appear on the page using the "plt" argument in "par()"

# top left plot:
par(new = "TRUE",              
    plt = c(0.05,0.45,0.55,0.9),   # using plt instead of mfcol (compare
                                  # coordinates in other plots)
    las = 1,                      # orientation of axis labels
    cex.axis = 1,                 # size of axis annotation
    tck = 0.02 )                  # major tick size and direction, < 0 means outside

persp3D(x, y, z, colvar = z, phi = 10, theta = -150, col = brewer.pal(8,"YlGn"), 
        border = 17, facets = TRUE, colkey = TRUE, resfac = 1, clab = expression(Switchgrass~area~("%")), 
        lighting = list(alpha = 1),
        xlab = "Profit threshold", ylab = "N loss threshold", zlab = "Switchgrass area (%)",
ticktype = "detailed")


text3D(x=900,y=150, z=107, "(a)", cex = 1.2, font = 2, phi = 10, theta = -150, add= TRUE)


#calculate total biomass for Iowa for each scenario (10,000 kg/ha) in million Mg
swg_matrix_bm <- (swg_matrix * 10)
z_bm <- swg_matrix_bm

#Top right plot:
par(new = "TRUE",
    plt = c(0.55,0.95,0.55,0.9),  # defining window for second plot
    las = 1,
    cex.axis = 1)

persp3D(x, y, z_bm, colvar = z_bm, phi = 10, theta = -150, col = brewer.pal(8,"YlOrBr"), 
        border = 17, facets = TRUE, colkey = TRUE, resfac = 1, clab = expression(Biomass~(million~Mg)), 
        lighting = list(alpha = 1),
        xlab = "Profit threshold", ylab = "N loss threshold", zlab = "Switchgrass biomass (million Mg)",
        ticktype = "detailed")

text3D(x=900,y=150, z=100, "(b)", cex = 1.2, font = 2, phi = 10, theta = -150, add= TRUE)




# create matrix for z values from the data frame swg_no3_leach (N leaching loss in kg)
swg_matrix_nl <- matrix(swg_no3_leach[,3], nrow = 16, ncol = 16)
#calculate N loss reduction compared to baseline
no3_leach_tot <-tbl(HeatonAgsolver_db, "05_dndc_no3_leach_sums_iowa_scenarios")  %>%
  as.data.frame()
cgsb_no3_leach <- no3_leach_tot[1,1]
swg_matrix_nlr <- (cgsb_no3_leach - swg_matrix_nl) *100 / cgsb_no3_leach
z_nlr <- swg_matrix_nlr

#Bottom left plot:
par(new = "TRUE",
    plt = c(0.05,0.45,0.05,0.4),
    las = 1,
    cex.axis = 1)

persp3D(x, y, z_nlr, colvar = z_nlr, phi = 10, theta = -150, col = brewer.pal(8,"YlGnBu"), 
        border = 17, facets = TRUE, colkey = TRUE, resfac = 1, clab =expression(NO[3]-N~leaching~reduction~("%")), 
        lighting = list(alpha = 1),
        xlab = "Profit threshold", ylab = "N loss threshold", zlab = "N loss reduction (%)",
ticktype = "detailed")

text3D(x=900,y=150, z=89, "(c)", cex = 1.2, font = 2, phi = 10, theta = -150, add= TRUE)

```



### Statewide N balance

At the statewide level, switchgrass integration reduced both N input and outputs compared to the baseline. The difference in N additions with switchgrass integration scenarios is mainly attributed a lower fertilization rates for switchgrass compared to corn/soybeans (Fig. 7). Amongst the output N components, largest decreases are apparent in NO~3~-N leaching and runoff. In all scenarios, N output exceeded inputs, leading to an overall decrease in soil N.

```{r n_balance_figure, fig.height=4, fig.width=7, fig.cap="Figure 7: Nitrogen balance of the baseline, 'conservative', and 'nutrient reduction' scenarios. Values are averaged over the modeled time period (4 years for corn/soybean and 10 years for switchgrass). Numbers above each set of N inputs and outputs indicate the overall N balance in kg N ha^-1^." }

n_state_cgsb <-tbl(HeatonAgsolver_db, "09_cgsb_state_ntable")  %>%
  as.data.frame() %>%
  mutate(avg_denitr = avg_n2o_flux + avg_n2_flux + avg_no_flux) %>%
  select(c(1:3,5,6,12,10,11)) %>%
  gather(n_comp, n_kg_ha) %>%
  mutate(scenario = 2)
n_state_cgsb$n_comp <- factor(n_state_cgsb$n_comp, levels = c("avg_atmos_n_input", "avg_fert_n_input", "avg_n_fixation", "avg_denitr",          "avg_grain_removal", "avg_nh3_vol",       "avg_no3_leach", "avg_runoff_son"))
n_state_cgsb$in_out <- c(rep("in",3),rep("out",5))
balance_n_state_cgsb <- n_state_cgsb$n_kg_ha[1]+n_state_cgsb$n_kg_ha[2]+n_state_cgsb$n_kg_ha[3]-n_state_cgsb$n_kg_ha[4]-n_state_cgsb$n_kg_ha[5]-n_state_cgsb$n_kg_ha[6]-n_state_cgsb$n_kg_ha[7]-n_state_cgsb$n_kg_ha[8]
                                                                                                                                            
n_state_cons <-tbl(HeatonAgsolver_db, "09_cons_state_ntable")  %>%
  as.data.frame() %>%
  mutate(avg_denitr = avg_n2o_flux + avg_n2_flux + avg_no_flux) %>%
  select(c(1:3,5,6,12,10,11)) %>%
  gather(n_comp, n_kg_ha) %>%
  mutate(scenario = 4) 
n_state_cons$n_comp <- factor(n_state_cons$n_comp, levels = c("avg_atmos_n_input", "avg_fert_n_input", "avg_n_fixation", "avg_denitr",          "avg_grain_removal", "avg_nh3_vol",       "avg_no3_leach", "avg_runoff_son"))
n_state_cons$in_out <- c(rep("in",3),rep("out",5))
balance_n_state_cons <- n_state_cons$n_kg_ha[1]+n_state_cons$n_kg_ha[2]+n_state_cons$n_kg_ha[3]-n_state_cons$n_kg_ha[4]-n_state_cons$n_kg_ha[5]-n_state_cons$n_kg_ha[6]-n_state_cons$n_kg_ha[7]-n_state_cons$n_kg_ha[8]


n_state_nutr <-tbl(HeatonAgsolver_db, "09_nutr_state_ntable")  %>%
  as.data.frame() %>%
  mutate(avg_denitr = avg_n2o_flux + avg_n2_flux + avg_no_flux) %>%
  select(c(1:3,5,6,12,10,11)) %>%
  gather(n_comp, n_kg_ha) %>%
  mutate(scenario = 6) 
n_state_nutr$n_comp <- factor(n_state_nutr$n_comp, levels = c("avg_atmos_n_input", "avg_fert_n_input", "avg_n_fixation", "avg_denitr",          "avg_grain_removal", "avg_nh3_vol",       "avg_no3_leach", "avg_runoff_son"))
n_state_nutr$in_out <- c(rep("in",3),rep("out",5))
balance_n_state_nutr <- n_state_nutr$n_kg_ha[1]+n_state_nutr$n_kg_ha[2]+n_state_nutr$n_kg_ha[3]-n_state_nutr$n_kg_ha[4]-n_state_nutr$n_kg_ha[5]-n_state_nutr$n_kg_ha[6]-n_state_nutr$n_kg_ha[7]-n_state_nutr$n_kg_ha[8]

# combine both scenario tables, then
# create two new tables, one contains the "in" values, the other the "out" values:
n_state <- bind_rows(n_state_cgsb, n_state_cons, n_state_nutr) %>%
  filter(in_out == "in")-> n_state_in
n_state <- bind_rows(n_state_cgsb, n_state_cons, n_state_nutr) %>%
  filter(in_out == "out") -> n_state_out

cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#000000")


ggplot(mapping=aes(x=scenario)) +
theme_gcbb() +
geom_bar(data = n_state_in, aes(x=scenario-0.8, y=n_kg_ha, fill = n_comp), width=0.8, stat="identity") +
geom_bar(data = n_state_out, aes(x=scenario, y=n_kg_ha, fill = n_comp), width=0.8,  stat="identity") +
scale_fill_manual(values=cbPalette) +
scale_y_continuous(name = expression(Nitrogen~(kg~N~ha^{"-1"}))) +
scale_x_continuous(name = " ", breaks = c(1.6,3.6,5.6), labels = c("Baseline", "'Conservative'", "'Nutrient reduction'"), limits = c(0.25, 7)) +
scale_fill_manual(name="",  values=cbPalette,
                         breaks=c("avg_atmos_n_input", "avg_fert_n_input", "avg_n_fixation", "avg_denitr", "avg_grain_removal", "avg_nh3_vol",       "avg_no3_leach", "avg_runoff_son"),
                         labels=c("Atm. deposition", "Fertilizer", "N fixation", "Denitrification", "Removal with harvest", "Ammonium volatilization", "Nitrate leaching", "Nitrate runoff")) +
annotate("text", x = 1.2, y = -5, label = "in", size = 3) +
annotate("text", x = 2, y = -5, label = "out", size = 3) +
annotate("text", x = 3.2, y = -5, label = "in", size = 3) +
annotate("text", x = 4, y = -5, label = "out", size = 3) +
annotate("text", x = 5.2, y = -5, label = "in", size = 3) +
annotate("text", x = 6, y = -5, label = "out", size = 3) +
annotate("text", x = 1.6, y = 200, label = balance_n_state_cgsb, size = 3) +
annotate("text", x = 3.6, y = 200, label = balance_n_state_cons, size = 3) +
annotate("text", x = 5.6, y = 200, label = balance_n_state_nutr, size = 3) 
```



### Spatial distributions of NO~3~-N leaching reduction

Our results suggest that highest NO~3~-N leaching reduction under the 'conservative' and 'nutrient reduction' switchgrass integration scenario can be achieved in a wide distribution of counties, with the least reduction occurring in the northwest portion of the state (Fig. 8). The counties of highest NO~3~-N leaching in the baseline scenario do not necessarily line up with those of highest reduction potential with switchgrass integration. 



```{r plot_n_loss_reduction_map, fig.width=8, fig.height=4, fig.cap= "Figure 8: Relative reduction in NO~3~-N leached per county over baseline (Fig. 4) when switchgrass is grown on (a) corn/soybean areas loosing > US$ 100 ha^-1^ and leaching > 50 kg N ha^-1^ ('conservative' scenario), and (b) corn/soybean areas losing > US\\$ 0 ha^-1^ and leaching > 20 kg N ha^-1^ ('nutrient reduction' scenario). Switchgrass yield assumed as medium (10,000 kg ha^-1^)."}
counties_red_swg_df <- filter(counties_swg_df, scenario %in% c("conservative", "nutrient reduction"))

scenarios <- c('conservative'= "(a) 'conservative' scenario",'nutrient reduction'= "(b) 'nutrient reduction' scenario")

ggplot(counties_red_swg_df) +
  theme_gcbb() +
  ditch_the_axes_with_border +
  geom_polygon(aes(long, lat, group = group, fill=no3_leach_red), color = "grey") +
  scale_fill_gradient(low = "white", high="#0072B2", guide = "colourbar") +  
  coord_equal() +
  labs(fill = expression(NO[3]-N~leaching~reduction~("%"))) +
  facet_wrap(~scenario, ncol = 2, labeller = as_labeller(scenarios))

```

The subfield resolution maps of NO~3~-N leaching reduction (Fig. 9) illustrate the spatial heterogeneity of environmental outcomes under the biomass crop integration scenarios. In the 'conservative' scenario, the areas in switchgrass are not evenly distributed across Iowa but clustered along the Raccoon, Upper South Skunk, and Cedar Watersheds (Fig. 9a). The 'nutrient reduction' scenario would convert much more cropland to switchgrass, but some regions in the north west and south east would not see significant management changes (Fig. 9b).

Focusing on the Upper North Raccoon River Watershed as an example of an impaired watershed reveals a varying pattern of switchgrass fields (Fig. 9c,d). In some parts of the watershed, whole fields are converted while in others, subfield areas are patchy and more fragmented. In the selected portion of this watershed, in which 80 % of land is in corn/soybeans, the 'conservative' scenario would result in 14.3 % of considered cropland converted to switchgrass with a concomitant NO~3~-N leaching reduction of 11.3 % (Fig. 9c). Most subfield areas converted to switchgrass display NO~3~-N leaching reduction of over 50 % compared to baseline, but the small conversion area (due to relatively high corn/soybean profitability in this watershed) results in a low overall mean NO~3~-N leaching reduction. The 'nutrient reduction' scenario would result in 39.7 % of considered cropland converted to switchgrass and reduce NO~3~-N leached by 31.4 % (Fig. 9d).

```{r subfield_n_red_iowa_zoom, cache = TRUE, fig.height=5, fig.width=5, fig.cap="Figure 9: Subfield-scale NO~3~-N leaching reduction relative to the baseline scenario in Iowa (a, b) and in the Upper North Raccoon River Watershed, spanning across Buena Vista, Pocahontas, Sac, and Calhoun County (c, d). (a) and (c) show the 'conservative' scenario where switchgrass is grown on areas that lose > US$ 100 ha^-1^ and leach > 50 kg N ha^-1^. (b) and (d) show the 'nutrient reduction' scenario where switchgrass is grown on unprofitable areas that leach > 20 kg N ha^-1^."}

include_graphics("imported_images/fig9.tif", dpi = 300)

# I have calculated the swg areas and leaching reduction values in the NRRWS in the python script 
# SubfieldDNDC06_clip_features_watershed.py
```

## Discussion

Our results indicate a substantial opportunity to reduce NO~3~-N leaching through the targeted replacement of annual crops with a high-yielding perennial crop on portions of fields that are consistently underperforming, both in terms of corn/soybean yield and profitability. We found that placing the most economically and environmentally unfavorable 12 % of considered cropland into switchgrass would result in a slightly disproportionate water quality improvement for Iowa (i.e., 18.4 % reduction in NO~3~-N leaching). However, this management practice alone is insufficient to reach the Iowa Nutrient Reduction Strategy's goal of 41 % reduction in NO~3~-N loading to surface waters, unless much larger portions of cropland were to be converted.

According to our model, integration of switchgrass on 12 % of considered cropland would have a stronger effect on leached NO~3~-N than other crop management practices, such as changing from continuous corn to a corn-soybean crop rotation [up to 4.5 % reduction, @wu2004decisions] or moving fall fertilization to the spring [6 % reduction, @inrs2013]. Similarly, while cover crops are an oft-promoted practice, their nutrient reduction efficiency is variable, highly dependent on winter climate, and often accompanied by corn yield reductions [@dabney2010using]. Applying less fertilizer can reduce NO~3~-N leaching [@jaynes2001nitrate], but also lead to unintended consequences including reduced yields and profit. Further, @poffenbarger2017maximum have recently shown that N additions below the agronomic optimum rate can cause long term losses in SOC in corn/soybean systems. Recognition that NO~3~-N leaching is not the consequence of excess fertilization alone, but rather caused by a combination of cropping system and farming practices, e.g., drainage, tillage, crop selection [@jaynes2001nitrate], provides rationale for management changes using a precision conservation approach that allows and may even enhance row crop production on appropriate farmland while reducing economic and environmental risk on unsuitable areas.

We found here that reaching the Iowa Nutrient Reduction Strategy's goal of 41 % NO~3~-N leaching reduction through switchgrass integration alone would require conversion of over 40 % of corn/soybean cropland, an amount that is likely socially untenable. Our results reinforce the need to combine multiple conservation practices and to adapt them to local biophysical and socio-economic conditions for optimal performance. The statewide variability in leaching reduction potential we observed was driven by (i) the extent of land converted to switchgrass based on farm-level financial considerations (i.e., threshold of tolerable profit loss) and decisions related to land stewardship (i.e., tolerable NO~3~-N loss); and (ii) spatial variability in DNDC model inputs (soil characteristics and baseline crop yields). Using socio-economic drivers to identify conservation opportunities is an approach supported by a recent survey among farmers in Iowa [@arbuckle2015frlp] in which a majority of farmers were willing to improve conservation management to reach the Iowa Nutrient Reduction Strategy's goals, but large uncertainties existed about the economic risks associated with a management change. Our results indicate win-win opportunities exist, but a full economic assessment will be needed to enable policy that can exploit precision conservation with economic gain. 

Our focus on the Upper North Raccoon River Watershed highlights an increasingly common nutrient leaching issue: eutrophication-induced threats to drinking water [e.g., @npr2014lake]. This watershed provides municipal drinking water for over 500,000 Iowa residents and its area is dominated by intensively managed annual crops. The state capital's utility, the Des Moines Water Works, recently filed a lawsuit against drainage districts of three upstream counties in the watershed, claiming the need for regulation of tile drainage discharge as a "point source" of NO~3~-N pollution under The Clean Water Act of 1977. The lawsuit was dismissed by the Iowa Supreme Court, but the topic remains highly controversial in terms of responsibilities and regulatory requirements to protect public health.

Our predictions for reductions in NO~3~-N leaching are consistent with field measurements and other modeling studies. As part of a high level nutrient budget for Iowa, @christianson2012nitrogen estimated NO~3~-N leaching from fertilizer inputs as 36 and 24 kg N ha^-1^ for continuous corn and corn after soybeans, respectively. Their approach did not take into account weather and soil related variability, but their results lie within our modeled distribution (Fig. 2b). Our statewide averages for N inputs is in the same range, while N outputs are slightly higher in our approach (Fig. 7). The negative N balance in both the baseline and switchgrass integration scenarios could be due to the static fertilization rate and potential inaccuracies in parametrization of the DNDC model. The total annual average NO~3~-N leaching per county we observed (Fig. 4) is comparable with values for corn cropland in Iowa modeled by @davis2012impact, who found most counties in the northern half of the state losing more than 3,200 Mg N.

In comparison to a corn-corn-soybean rotation, miscanthus, switchgrass, and prairie reduced NO~3~-N leaching at 50 cm soil depth by more than 90 % in the fourth year of an experiment on deep loess soils in Illinois [@smith2013reduced]. @mcisaac2010miscanthus showed a 97 % reduction in NO~3~-N leaching at 50 cm soil depth in established miscanthus and switchgrass plots compared to corn-soybean rotation on similar soils.  @daigh2015subsurface showed that fertilized, reconstructed prairie lost 89-99 % less NO~3~-N to tile drainage water compared to corn/soybean on fertile soils in central Iowa. These reduction rates are at the high end of our modeled NO~3~-N leaching reduction distributions (Fig. S5). The wider distributions expanding to lower reduction rates across Iowa are realistic, since our results are averaged over a 10 year growing horizon for switchgrass, and span over a variety of soil characteristics and weather conditions. The annual variability in NO~3~-N leaching due to weather conditions has been observed elsewhere [@sprague2011nitrate]. @hatfield2009nitrate found that annual NO~3~-N leaching variations are related to precipitation of the first five months of a year. Projected increases in extreme rain events associated with climate change [@easterling2000observed] are likely to exacerbate nutrient loss through leaching and erosion, reinforcing the need for conservation practices that address multiple environmental risks. The integration of perennial vegetation meets this need by enhancing nutrient uptake and erosion control, while delivering additional ecosystem services such as carbon sequestration, soil production, and biodiversity. 

Our spatial results can be used as indicators to identify nonlinear (disproportionate) responses of NO~3~-N leaching reduction to conversion of land to perennial grasses in order to find "sweet spots" where large improvements can be obtained by conversion of relatively small portions of cropland [@qiu2015landscape]. It also highlights regions where high baseline NO~3~-N leaching does not align with high leaching reduction potential. This indicates that including socio-economic thresholds concomitantly with environmental ones produces different targets for subfield intervention than would have been identified with an economic or biophysical model alone.  Applied to smaller management units and fed with more detailed and accurate inputs such as yield monitor data, our approach provides a multi-criteria decision making tool for farmers.

While our methodological setup is novel, coupling empirical and process-based data to bridge inference scales, it has limitations. Our approach cannot yet estimate total NO~3~-N fluxes leaving Iowa's geographic area through surface waters. DNDC models leaching at a soil depth of 50 cm and does not account for further reduction in NO~3~-N concentration observed in tile drainage water [@smith2013reduced] and surface waters due to benthic denitrification [@donner2008corn]. However, previous efforts that include benthic denitrification suggest that changes in NO~3~-N leaching through subsurface drainage is proportional to total N loads at the watershed and basin scale [@donner2008corn; @vanloocke2016din]. DNDC does not account for lateral water flow that is caused by topography and for possible NO~3~-N uptake by roots growing below 50 cm. The latter is likely to occur especially in perennial cropping systems, suggesting that our leaching results for switchgrass are overestimated. We are not assuming variable rate fertilization, so on some cropland our fertilizer might be over- or underestimated. Also, we do not include manure application due to missing spatial data on amounts and type. However, our approach serves to compare different cropping systems and management on a subfield resolution. The framework of cropland area selection and scenario-based land management simulation combines two modeling approaches with assumptions limited by publicly available data. For both the economic estimation and the biogeochemistry model, management practices and crop budgets were assumed to be equal across the state, and only varying with crop rotation [for details on the limitations of the profitability analysis see also @brandes2016subfield]. A preliminary analysis showed that yields of the new switchgrass variety Liberty, chosen as cropping alternative to corn and soybeans due to its high yield potential and cold tolerance, did not linearly respond to cropland quality in multilocation trials (Jeff Volenec, personal communication; data not shown). Because a sensitivity analysis revealed weak response of the model outcomes to yield variations (Fig. S6), we posit that switchgrass yield is not an important factor on a landscape scale when only fractions of existing cropland are converted to perennial vegetation. This argument has to be re-evaluated when better switchgrass yield data become available. 

This analysis disaggregates previously published approaches to N balance estimation based on county or watershed data down to a finer resolution and takes into account the biogeochemical processes driving NO~3~-N loss in agroecosystems. The inclusion of perennial crops is particularly promising due to potential synergies between multiple ecosystem functions besides water quality, such as carbon sequestration and erosion control, especially with regards to increasing threats to agricultural systems associated with global change. NO~3~-N leaching reductions by perennial integration are consistently high relative to the affected land area. The requirement to sacrifice only the under-performing fraction of farmland to perennials might compensate for the long-term commitment associated with perennial crops. We present two scenarios to reflect possible future developments: The 'conservative' scenario maintains the current focus on grain production in Iowa although slightly offset by the conversion of the least productive 12 % of cropland to switchgrass; the 'nutrient reduction' scenario outlines a more transformational future with demand structures and policies supporting bioenergy feedstock production and a more profound land use conversion in the Midwest Corn Belt.


## Acknowledgements

This project was funded by the Iowa State University Department of Agronomy Anonymous Endowment, the Iowa Nutrient Research Center, and the USDA National Institute of Food and Agriculture, Hatch project 221195.
The authors thank Marshall McDaniel for his valuable expert input in discussions about soil nitrogen processes.

## References

## Supporting Information

Figures S1 - S7: 

Graphics that support the understanding of the results displayed in the main manuscript, such as variability of modelled NO~3~-N leaching results with climate, distributions of different N compounds, contour plots showing the statewide results under different threshold combinations, and a map showing Major Landform Regions of Iowa.

Tables S1 - S3:

A table displaying the data underlying Fig. 6 of the main manuscript.

## Supporting Information

```{r weather_data, cache = TRUE, include = FALSE}

# make a list of files and their paths that I want to load, using regular expressions to filter according to a pattern
wth <- list.files(path = "./weather", pattern = "IA[[:digit:]][[:digit:]][[:digit:]]_201[2345].wth", full.names = TRUE) 

# make a vector from wth that only includes the fips and year
fips <- list.files(path = "./weather", pattern = "IA[[:digit:]][[:digit:]][[:digit:]]_201[2345].wth")
# split the file name to get the fips and create a matrix with two columns (there must be a way to extract only the fips but I don't know it)
fips <- unlist(strsplit(fips, "_")) %>%
matrix(ncol = 2, byrow = TRUE)
# create vector to use for the final data frame
fips <- fips[,1]

# create a year vector to use for the final data frame
year <- rep(c("2012", "2013", "2014", "2015"), length(fips)/4)

# add a header for the files   
header <- c("doy", "temp_max", "temp_min", "precip" )

# read in the files as a list of data frames and then combine them into one data frame
weather <- lapply(wth, read.table, skip = 1, col.names = header) %>%
  bind_rows() %>%
  mutate(fips = rep(fips, each = 365 )) %>%
  mutate(year = rep(year, each = 365))


# using dplyr, I can now aggregate the data to county, year, etc.
weather %>%
  group_by(fips, year) %>%
  summarise(precip = sum(precip)*10, temp_max = mean(temp_max), temp_min = mean(temp_min)) -> annual_weather

# extracting the relevant data from the postgreSQL database
query_annual <- "SELECT fips, ave_no3_leach12_cgsb, ave_no3_leach13_cgsb, ave_no3_leach14_cgsb, ave_no3_leach15_cgsb FROM \"07_dndc_counties\" "
  
annual_leach <- tbl(HeatonAgsolver_db, sql(query_annual)) %>%
      as.data.frame() %>%
      rename("2012" = ave_no3_leach12_cgsb, "2013" = ave_no3_leach13_cgsb, "2014" = ave_no3_leach14_cgsb, "2015" = ave_no3_leach15_cgsb) %>%
      gather(year, avg_leach, `2012`, `2013`, `2014`, `2015`)  %>% # gather the table to get the variable "no3 leaching" into one column (use back ticks for years)
      left_join(annual_weather, by = c("fips", "year")) -> leach_weather

leach_weather$year <- as.factor(leach_weather$year)

# fit linear models

precip_mod <- lm(avg_leach ~ precip, data = leach_weather)
summary(precip_mod)




```

```{r plot_leach_precip, fig.width=9, fig.height=8, fig.cap="Figure S1: Annual NO~3~-N leaching and annual precipitation per county. Each dot represents a county in Iowa, USA in a given year."}

# colorblind friendly palette
cbPalette <- c("#000000", "#E69F00", "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")


plot1 <- ggplot(leach_weather) +
  geom_point(aes(x = precip, y = avg_leach, color = year, shape = year)) +
  #geom_text(data=subset(leach_weather, fips == "IA193"), # to label only the values where fips = IA193
  #          aes(precip, avg_leach, label=fips)) +
  theme_gcbb() +
  theme(legend.justification=c(0.02,0.98), legend.position=c(0.02,0.98)) +
  labs(x=expression(Annual~precipitation~(mm)),
       y=expression(Annual~NO[3]-N~leaching~(kg~N~ha^{-1}))) +
  scale_x_continuous() +
  scale_y_continuous() +
  scale_colour_manual(name="Year", values=cbPalette) +
  scale_shape_discrete(name="Year") +
  geom_abline(linetype= "dashed", slope = 0.049887, intercept = -0.547691)

plot2 <- ggplot(leach_weather) +
  geom_point(aes(x = temp_min, y = avg_leach, col = year, shape = year)) +
  #geom_text(data=subset(leach_weather, fips == "IA193"), # to label only the values where fips = IA193
  #          aes(temp_min, avg_leach, label=fips)) +
  theme_gcbb() +
  labs(x=expression(paste("Minimum temperature (",degree, "C)")),
       y=expression(Annual~NO[3]-N~leaching~(kg~N~ha^{-1}))) +
  scale_x_continuous() +
  scale_y_continuous() +
  scale_colour_manual(name="Year", values=cbPalette, guide = FALSE) +
  scale_shape_discrete(name="Year", guide = FALSE)

plot3 <- ggplot(leach_weather) +
  geom_point(aes(x = temp_max, y = avg_leach, col = year, shape = year)) +
  #geom_text(data=subset(leach_weather, fips == "IA193"), # to label only the values where fips = IA193
  #          aes(temp_max, avg_leach, label=fips)) +
  theme_gcbb() +
  labs(x=expression(paste("Maximum temperature (",degree, "C)")),
       y=expression(Annual~NO[3]-N~leaching~(kg~N~ha^{-1}))) +
  scale_x_continuous() +
  scale_y_continuous() +
#  scale_color_discrete(name="Year") +
  scale_colour_manual(name="Year", values=cbPalette, guide = FALSE) +
  scale_shape_discrete(name="Year", guide = FALSE)

grid.arrange(plot2, plot3, plot1, ncol = 2)

```

```{r subfield_n_loss_maps, fig.height=5.981, fig.width=4.592, fig.cap="Figure S2: Subfield-scale NO~3~-N leaching (a) and ammonia (NH~3~)-N volatilization on annual cropland in Iowa, USA. Values are annual rates averaged over the years 2012-2015."}

include_graphics("imported_images/figS2.tif", dpi = 300)

```


```{r fetch_distr, cache=TRUE}

cgsb_n_loss <-tbl(HeatonAgsolver_db, "06_cgsb_ave_n_loss_rounded_aggr")  %>% 
  as.data.frame()
cgsb_no3_leach <-tbl(HeatonAgsolver_db, "06_cgsb_ave_no3_leach_rounded_aggr")  %>%
  as.data.frame()
cgsb_nh3_vol <-tbl(HeatonAgsolver_db, "06_cgsb_ave_nh3_vol_rounded_aggr")  %>%
  as.data.frame()
swg_low <-tbl(HeatonAgsolver_db, "06_swg_7500_ave_no3_leach_rounded_aggr")  %>%
  as.data.frame()
swg_med <-tbl(HeatonAgsolver_db, "06_swg_10000_ave_no3_leach_rounded_aggr")  %>%
  as.data.frame()
swg_hi <-tbl(HeatonAgsolver_db, "06_swg_12500_ave_no3_leach_rounded_aggr")  %>%
  as.data.frame()
```

```{r data_list}
data_list <- list(cgsb_n_loss, cgsb_no3_leach, cgsb_nh3_vol, swg_low, swg_med, swg_hi)

scenario <- c(rep("cgsb_n_loss", sum(sapply(data_list[1],nrow))), 
              rep("cgsb_no3_leach", sum(sapply(data_list[2],nrow))),
              rep("cgsb_nh3_vol", sum(sapply(data_list[3],nrow))), 
              rep("swg_low", sum(sapply(data_list[4],nrow))), 
              rep("swg_med", sum(sapply(data_list[5],nrow))), 
              rep("swg_hi", sum(sapply(data_list[6],nrow)))) %>%
factor(levels= c('cgsb_n_loss', 'cgsb_no3_leach', 'cgsb_nh3_vol', 'swg_low', 'swg_med', 'swg_hi')) # make it a factor so that it is plotted in the right order in the facets


leaching <- vector(mode="numeric", length=0)
 for (i in seq(data_list))
   leaching <- append(leaching, data_list[[i]][,1])
area <- vector(mode="numeric", length=0)
 for (i in seq(data_list))
   area <- append(area, data_list[[i]][,2])
   
leach <- data.frame(scenario, leaching, area = area*1e-6) # this factor to show Mha

# calculate weighted medians and means

 median_cgsb_loss <- weightedMedian(cgsb_n_loss[-1,1], w=cgsb_n_loss[-1,2])
 median_cgsb_leach <- weightedMedian(cgsb_no3_leach[-1,1], w=cgsb_no3_leach[-1,2])
 median_cgsb_nh3_vol <- weightedMedian(cgsb_nh3_vol[-1,1], w=cgsb_nh3_vol[-1,2])
 median_swg_low <- weightedMedian(swg_low[,1], w=swg_low[,2])
 median_swg_med <- weightedMedian(swg_med[,1], w=swg_med[,2])
 median_swg_hi <- weightedMedian(swg_hi[,1], w=swg_hi[,2])
 medians <- c(median_cgsb_loss, median_cgsb_leach, median_cgsb_nh3_vol, median_swg_low, median_swg_med, median_swg_hi)
 medians_df <- data.frame(scenario = levels(leach$scenario),
                         median = medians)
 
 quant <- wtd.quantile(cgsb_no3_leach[-1,1], weight = cgsb_no3_leach[-1,2]) # calculates 0, .25, .5, .75, 1 (quintiles)
 
 
 
 mean_cgsb_loss <- weightedMean(cgsb_n_loss[-1,1], w=cgsb_n_loss[-1,2])
 mean_cgsb_leach <- weightedMean(cgsb_no3_leach[-1,1], w=cgsb_no3_leach[-1,2])
 mean_cgsb_nh3_vol <- weightedMean(cgsb_nh3_vol[-1,1], w=cgsb_nh3_vol[-1,2])
 mean_swg_low <- weightedMean(swg_low[,1], w=swg_low[,2])
 mean_swg_med <- weightedMean(swg_med[,1], w=swg_med[,2])
 mean_swg_hi <- weightedMean(swg_hi[,1], w=swg_hi[,2])
 means <-c(mean_cgsb_loss, mean_cgsb_leach, mean_cgsb_nh3_vol, mean_swg_low, mean_swg_med, mean_swg_hi)

 


```

```{r histograms, cache=FALSE, fig.height=4, fig.width=7, fig.cap="Figure S3: (a) Baseline sum of NO~3~-N leaching and ammonium volatilization, (b) baseline NO~3~-N leaching, (c) baseline ammonium volatilization, and (d-f) NO~3~-N leaching for switchgrass assuming three different yields, modelled with DNDC on a subfield resolution for Iowa, USA. Average values for 2012-2015 (baseline) and 2006-2015 (switchgrass) are shown. Dashed vertical lines show the medians."}

scenarios <- c('cgsb_n_loss'= "(a) N loss (corn/soybeans)",'cgsb_no3_leach'= "(b) NO3 leach. (corn/soybeans)", 'cgsb_nh3_vol'= "(c) NH3 vol. (corn/soybeans)",'swg_low' = "(d) Low yielding switchgrass", 'swg_med' = "(e) Medium yielding switchgrass", 'swg_hi' = "(f) High yielding switchgrass")

ggplot(leach, aes(leaching, weight = area)) + 
  geom_histogram(binwidth=2, alpha = .5, position="identity") +
  theme_gcbb() +
  labs(x=expression(Mean~nitrogen~loss~(kg~N~ha^{-1})),
       y=expression(Area~(Mha))) +
  scale_x_continuous(lim = c(-1,150)) +
  scale_y_continuous() +
  geom_vline(data = medians_df, aes(xintercept=median), color = "black", linetype = "dashed") +
  facet_wrap( ~ scenario, ncol=3, labeller = as_labeller(scenarios)) 
```

```{r area_contourplot, fig.height=7, fig.width=8, fig.cap="Figure S4: Contour plots (vertical projections of Figure 6) showing (a) the resulting areas converted to switchgrass (in % of row cropland), (b) total switchgrass biomass production (in million Mg), and (c) total NO~3~-N leaching reduction (in % of the baseline) as a function of NO~3~-N leaching and profitability threshold values of the baseline scenario. In each plot, isolines with numbers 10-70 show the threshold combinations with similar resulting values. The grey dashed lines show an example how to read the plot: If cropland losing > 50 kg N ha^-1^ and losing > US$ 100 ha^-1^ was considered for conversion to switchgrass ('conservative' scenario), a little over 10% of cropland currently in row crop would be in switchgrass (a), approx. 10 million Mg of biomass would be produced (b), and the N loss through leaching would be reduced by almost 20% (c). Similarly, the solid lines show the outcomes for the 'nutrient reduction' scenario."}



# multiple panel plot with the modified function filled.contour3()

plot.new() 

#I am organizing where the plots appear on the page using the "plt" argument in "par()"

# top left plot:
par(new = "TRUE",              
    plt = c(0.15,0.5,0.60,0.95),   # using plt instead of mfcol (compare
                                  # coordinates in other plots)
    las = 1,                      # orientation of axis labels
    cex.axis = 1,                 # size of axis annotation
    tck = -0.02 )                  # major tick size and direction, < 0 means outside

mylevels <- c(seq(0,70,10),100)
filled.contour3(x, y, z, 
                col = brewer.pal(length(mylevels),"YlGn"), 
                levels=mylevels, 
                xlab="", 
                ylab=expression(NO[3]^{"-"}~leaching~threshold~(kg~ha^{-1}~yr^{-1})),
                xlim = c(-400,700), ylim = c(0,120))
contour(x, y, z, 
        levels=mylevels, 
        add = TRUE, 
        xlim = c(-400,700), ylim = c(0,120))
par(xpd = FALSE) # restricts the lines to the plot region
abline(h = 50, col = "dark gray", lty = 2)
abline(v = -100, col = "dark gray", lty = 2)
abline(h = 20, col = "dark gray", lty = 1)
abline(v = 0, col = "dark gray", lty = 1)

# An annotation inside first plot
#The xpd=NA allows for writing outside the plot limits, but still using the the x and y axes to place the text
par(xpd = NA)
text(x=-360,y=107,expression((a)~Cropland~"in"~switchgrass),cex = 1,font = 2, adj = c(0,0))


#Top right plot:
par(new = "TRUE",
    plt = c(0.6,0.95,0.60,0.95),  # defining window for second plot
    las = 1,
    cex.axis = 1)

filled.contour3(x, y, z_bm, 
                col = brewer.pal(length(mylevels),"YlOrBr"), 
                levels=mylevels, 
                xlab=expression(Profitability~threshold~("US$"~ha^{-1}~yr^{-1})), 
                ylab="",
                xlim = c(-400,700), ylim = c(0,120))
contour(x, y, z_bm, 
        levels=mylevels, 
        add = TRUE, 
        xlim = c(-400,700), ylim = c(0,120))
par(xpd = FALSE) # restricts the lines to the plot region
abline(h = 50, col = "dark gray", lty = 2)
abline(v = -100, col = "dark gray", lty = 2)
abline(h = 20, col = "dark gray", lty = 1)
abline(v = 0, col = "dark gray", lty = 1)

par(xpd = NA)
text(x=-360,y=107,expression((b)~Biomass~produced),cex = 1,font = 2, adj = c(0,0))


#Bottom left plot:
par(new = "TRUE",
    plt = c(0.15,0.5,0.15,0.5),
    las = 1,
    cex.axis = 1)

filled.contour3(x, y, z_nlr, 
                col = brewer.pal(length(mylevels),"YlGnBu"), 
                levels=mylevels, 
                xlab=expression(Profitability~threshold~("US$"~ha^{-1}~yr^{-1})), 
                ylab=expression(NO[3]^{"-"}~leaching~threshold~(kg~ha^{-1}~yr^{-1})), 
                xlim = c(-400,700), ylim = c(0,120))
contour(x, y, z_nlr, 
        levels=mylevels, 
        add = TRUE, 
        xlim = c(-400,700), ylim = c(0,120))
par(xpd = FALSE) # restricts the lines to the plot region
abline(h = 50, col = "dark gray", lty = 2)
abline(v = -100, col = "dark gray", lty = 2)
abline(h = 20, col = "dark gray", lty = 1)
abline(v = 0, col = "dark gray", lty = 1)

par(xpd = NA)
text(x=-360,y=107,expression((c)~NO[3]-N~reduction),cex = 1,font = 2, adj = c(0,0))



```

```{r leach_red_distribution, fig.width=4.5, fig.height=3, fig.cap="Figure S5: Distribution of mean NO~3~-N leaching reduction (in percent of the baseline leaching) on areas that were converted to switchgrass. 'Conservative sceanrio': all croplands losing > US$ 100 ha^-1^ and leaching > 50 kg N ha^-1^ were converted to switchgrass. 'Nutrient reduction' scenario: all unprofitable croplands leaching > 20 kg N ha^-1^ were converted to switchgrass."}
tweak = tbl(HeatonAgsolver_db, "06_tweak_leach_red_aggr") %>%
  as.data.frame()
tweak$area_ha <- tweak$area_ha * 1e-6  # convert to Mha
tweak$leach_red <- abs(tweak$leach_red) # change from negative values

nutred = tbl(HeatonAgsolver_db, "06_nutred_leach_red_aggr") %>%
  as.data.frame()
nutred$area_ha <- nutred$area_ha * 1e-6  # convert to Mha
nutred$leach_red <- abs(nutred$leach_red) # change from negative values

scenario <- c(rep("tweak",length(tweak[,1])), rep("nutred", length(nutred[,1]))) %>%
  factor(levels=c("tweak", "nutred"))

leach_red <- data.frame(scenario,
                        area_ha = c(tweak$area_ha, nutred$area_ha),
                        leach_red = c(tweak$leach_red, nutred$leach_red))
# remove all areas where leach_red = 0
leach_red <- filter(leach_red, leach_red > 0)

scenarios <- c('nutred'= "'nutrient Reduction' scenario",'tweak'= "'conservative' scenario")

ggplot(leach_red, aes(leach_red, weight = area_ha)) + 
  geom_histogram(binwidth=2, alpha = .5, position="identity") +
  theme_gcbb() +
  labs(x=expression(Mean~NO[3]-N~leaching~reduction~("%")),
       y=expression(Area~(Mha))) +
  scale_x_continuous(limits = c(0,100)) +
  scale_y_continuous() +
  facet_wrap(~scenario, labeller = as_labeller(scenarios))

```


```{r swg_areas, cache=TRUE}
swg_areas_11 <- vector(mode="numeric", length=0)
profit_cutoffs <- c(-500, -400, -300, -200, -150, -100, -50, 0, 50, 100, 150)
 for (i in 1:length(profit_cutoffs)) {
    query <- paste("SELECT SUM(clumuha) FROM \"05_dndc_clumu_cgsb_swg\" WHERE mean_profit_ha < ", as.character(profit_cutoffs[i]), "AND ave_no3_leach_ha_cgsb > 50")
    sum_area <- tbl(HeatonAgsolver_db, sql(query)) %>%
      as.data.frame()
    sum_area <- sum_area[1,1]
    swg_areas_11 <- append(swg_areas_11, sum_area) 
  }
```

```{r query_leach_sums, cache=TRUE}

# query sum of leaching from the baseline (corn/beans) scenario
query_cgsb <- "SELECT(sum(ave_no3_leach_ha_cgsb * clumuha)) / 1000 FROM \"05_dndc_clumu_cgsb_swg\" "
leach_cgsb <- tbl(HeatonAgsolver_db, sql(query_cgsb)) %>%
      as.data.frame()
leach_cgsb <- leach_cgsb[1,1] 

# query sums of leaching from the low yield swg integration scenario, with constant leaching cut off and varying profit cut off
leach_sums_lo <- vector(mode="numeric", length = 0)
for (i in 1:length(profit_cutoffs)) {
  query <- paste("SELECT (sum((CASE WHEN mean_profit_ha <", as.character(profit_cutoffs[i]),"AND ave_no3_leach_ha_cgsb > 50 THEN ave_no3_leach_ha_swg_7500 ELSE ave_no3_leach_ha_cgsb END) * clumuha)) / 1000 FROM \"05_dndc_clumu_cgsb_swg\" ")
  leach_sum <- tbl(HeatonAgsolver_db, sql(query)) %>%
      as.data.frame()
  leach_sum <- leach_sum[1,1]
  leach_sums_lo <- append(leach_sums_lo, leach_sum)
}


# query sums of leaching from the med yield swg integration scenario, with constant leaching cut off and varying profit cut off
leach_sums_med <- vector(mode="numeric", length = 0)
for (i in 1:length(profit_cutoffs)) {
  query <- paste("SELECT (sum((CASE WHEN mean_profit_ha <", as.character(profit_cutoffs[i]),"AND ave_no3_leach_ha_cgsb > 50 THEN ave_no3_leach_ha_swg_10000 ELSE ave_no3_leach_ha_cgsb END) * clumuha)) / 1000 FROM \"05_dndc_clumu_cgsb_swg\" ")
  leach_sum <- tbl(HeatonAgsolver_db, sql(query)) %>%
      as.data.frame()
  leach_sum <- leach_sum[1,1]
  leach_sums_med <- append(leach_sums_med, leach_sum)
}


# query sums of leaching from the high yield swg integration scenario, with constant leaching cut off and varying profit cut off
leach_sums_hi <- vector(mode="numeric", length = 0)
for (i in 1:length(profit_cutoffs)) {
  query <- paste("SELECT (sum((CASE WHEN mean_profit_ha <", as.character(profit_cutoffs[i]),"AND ave_no3_leach_ha_cgsb > 50 THEN ave_no3_leach_ha_swg_12500 ELSE ave_no3_leach_ha_cgsb END) * clumuha)) / 1000 FROM \"05_dndc_clumu_cgsb_swg\" ")
  leach_sum <- tbl(HeatonAgsolver_db, sql(query)) %>%
      as.data.frame()
  leach_sum <- leach_sum[1,1]
  leach_sums_hi <- append(leach_sums_hi, leach_sum)
}

```


```{r data_dispr_benefits}
# organize the data in a data frame to be used in ggplot
swg_yield <- as.factor(c("baseline",rep("7500",11), rep("10000",11),rep("12500",11)))
profit_cutoff <- c(NA, rep(profit_cutoffs,3))
swg_area <- c(0,rep(swg_areas_11,3))
swg_area_percent <- (swg_area/9374363)*100
no3_leach <- c(leach_cgsb, leach_sums_lo, leach_sums_med, leach_sums_hi)
leach_red <- abs((no3_leach - no3_leach[1])/no3_leach[1])*100

relation <- data.frame(swg_yield, profit_cutoff, swg_area_percent, leach_red)
```


```{r relations, cache=TRUE,  fig.width=8, fig.height=3,  fig.cap="Figure S6: statewide NO~3~-N leaching reduction as a function of area in switchgrass (a) and of the profitability threshold (b). The threshold for NO~3~-N leaching is held constant at 50 kg N ha^-1^ (only areas losing > 50 kg N ha^-1^ through leaching are considered for conversion to switchgrass)."}

plot1 <- ggplot() +  
  geom_point(data = relation, aes(x = swg_area_percent, y = leach_red, color=swg_yield)) +
  theme_gcbb() +
  labs(x=expression(Area~"in"~switchgrass~("%")),
       y=expression(NO[3]-N~leaching~reduction~("%"~N))) +
  scale_x_continuous() +
  scale_y_continuous() +
#  scale_color_discrete(name="Switchgrass\nYield (kg/ha)",  guide = FALSE) +
  annotate("text", x = 0, y = 40, label = "(a)", size = 5) +
  scale_colour_manual(name="Switchgrass\nYield (kg/ha)",  guide = FALSE, values=cbPalette)

plot2 <- ggplot() +
  geom_point(data = relation, aes(x = profit_cutoff, y = leach_red, color=swg_yield)) +
  theme_gcbb() +
  labs(x=expression(Profitability~threshold~("US$"~ha^{-1})),
       y=expression(NO[3]-N~leaching~reduction~("%"~N))) +
  scale_x_continuous(breaks=seq(from=-500, to=200, by= 100)) +
  scale_y_continuous() +
#  scale_color_discrete(name="Switchgrass\nYield (kg/ha)") +
  theme(legend.position=c(0.25,0.65))+
  annotate("text", x = -500, y = 40, label = "(b)", size = 5) +
    scale_colour_manual(name="Switchgrass\nYield (kg/ha)", values=cbPalette)

grid.arrange(plot1, plot2, ncol = 2)
```

```{r decision_matrices}

rownames(z) <- seq(from=-800, to=700, by= 100)
colnames(z) <- seq(from=0, to=150, by=10)
z_t <- t(z) # transpose matrix (swap rows and columns)
z_table <- z_t[rev(seq_len(nrow(z_t))),] # reverse the order of the rows so that the matrix looks like the contour plots

kable(z_table, digits = 1, caption="Table S1: Area in switchgrass (%) under all possible conversion threshold scenarios. The profitability cut-off changes along the columns (profitability < US$ -800 ha^-1^ - US$ 700 ha^-1^) and the NO~3~-N leaching cut-off changes along the rows (NO~3~-N leaching > 150 kg N ha^-1^ - 0 kg N ha^-1^). This matrix shows the data underlying the surface plot in Fig. 2a and Fig. 3a." )

rownames(z_bm) <- seq(from=-800, to=700, by= 100)
colnames(z_bm) <- seq(from=0, to=150, by=10)
z_bm_t <- t(z_bm)
z_bm_table <- z_bm_t[rev(seq_len(nrow(z_bm_t))),] # reverse the order of the columns so that the matrix looks like the contour plots

kable(z_bm_table, digits = 1, caption="Table S2: Biomass production from switchgrass (million Mg) under all possible conversion threshold scenarios. The profitability cut-off changes along the columns (profitability < US$ -800 ha^-1^ - US$ 700 ha^-1^) and the NO~3~-N leaching cut-off changes along the rows (NO~3~-N leaching > 150 kg N ha^-1^ - 0 kg N ha^-1^). This matrix shows the data underlying the surface plot in Fig. 2b and Fig. 3b." )

rownames(z_nlr) <- seq(from=-800, to=700, by= 100)
colnames(z_nlr) <- seq(from=0, to=150, by=10)
z_nlr_t <- t(z_nlr)
z_nlr_table <- z_nlr_t[rev(seq_len(nrow(z_nlr_t))),] # reverse the order of the columns so that the matrix looks like the contour plots

kable(z_nlr_table, digits = 1, caption="Table S3: NO~3~-N leaching reduction (%) under all possible conversion threshold scenarios. The profitability cut-off changes along the columns (profitability < US$ -800 ha^-1^ - US$ 700 ha^-1^) and the NO~3~-N leaching cut-off changes along the rows (NO~3~-N leaching > 150 kg N ha^-1^ - 0 kg N ha^-1^). This matrix shows the data underlying the surface plot in Fig. 2c and Fig. 3c." )

```

```{r landforms, cache = TRUE, fig.cap="Figure S7: Major Landform Regions in Iowa."}

include_graphics("imported_images/Major_Landforms.tif", dpi = 300)
```





```{r shut, include=FALSE}
 rm(list='HeatonAgsolver_db'); gc() 
```