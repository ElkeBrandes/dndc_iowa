---
title: "Modelled NO~3~ leaching in Iowa from row cropped and switchgrass fields"
author: "Elke Brandes"
date: "Tuesday, November 01, 2016"
output: html_document
---
This paper describes the data analysis of NO3 leaching results in Iowa. The initial data are the DNDC-outputs from Gabe McNunn on a clu-mapunit scale. I have performed the first analysis steps in the PostgreSQL database and access the resulting tables with the code below (using `dplyr` and `RPostgreSQL`).

##Required packages##
```{r packages, message=FALSE}
library('RPostgreSQL') # PostgreSQL database connection
library("ggplot2") # for the figures
library("maps") # to plot maps
library("gridGraphics") # needed for the function unit in ggplot
library("tidyverse") # to make tidy tables, includes dplyr needed for PostgreSQL database connection
library('knitr') # to use kable() function

library(rgdal) # to read in shape files
library(Cairo)
library(ggmap)
library(scales)
library(RColorBrewer)
library("sp") # to use merge with a spatial data frame
```


### Connect to the PostgreSQL datbase###
With dplyr:
```{r connect_dplyr, message=FALSE}


pw <- {
  "5QUXJHTbxj"
}
isuag_db <- src_postgres(dbname = 'isuag',
                           host = 'isu-ag-db.agsolver.com',
                           port = 5432,
                           user = 'isuag',
                           password = pw)

```
With RPostgreSQL:
```{r, connect_rpostgres, message=FALSE}
pw <- {
  "5QUXJHTbxj"
}
drv <- dbDriver("PostgreSQL") # loads the PostgreSQL driver
con <- dbConnect(drv, dbname = "isuag",  # creates a connection to the postgres database
                 host = "isu-ag-db.agsolver.com", port = 5432,
                 user = "isuag", password = pw)
# note that "con" will be used later in each connection to the database
```

##1. Distributions of NO~3~ leaching in Iowa, from row cropped and switchgrass fields##

Connect to the isuag database and load tables that contain the rounded average NO~3~ leaching values (in kg/ha) for the **four scenarios**:

1. Status quo (row cropped areas in corn or soybean as is from 2012-2015)
2. Switchgrass low yield (all areas that were continuously in corn/soy from 2012-2015 were planted to switchgrass in 2006 for 10 years, assuming switchgrass yield is 7000 kg/ha)
3. Switchgrass medium yield (assuming a yield of 10000 kg/ha)
4. Switchgrass high yield (assuming a yield of 12500 kg/ha)

The leaching values and respective patch areas were aggregated to the same leaching values, and for each scenario, one table was created.

Use the dplyr PostgreSQL handle into the database and create a data frame:
```{r fetch_distr, cache=TRUE}

cgsb_leach <-tbl(isuag_db, "06_cgsb_ave_no3_leach_rounded_aggr")  %>%
  as.data.frame()
swg_low <-tbl(isuag_db, "06_swg_7500_ave_no3_leach_rounded_aggr")  %>%
  as.data.frame()
swg_med <-tbl(isuag_db, "06_swg_10000_ave_no3_leach_rounded_aggr")  %>%
  as.data.frame()
swg_hi <-tbl(isuag_db, "06_swg_12500_ave_no3_leach_rounded_aggr")  %>%
  as.data.frame()
```

I can run some test here:
```{r test_distr}
# send a query through dplyr
query = "SELECT SUM(area_ha) FROM \"06_cgsb_ave_no3_leach_rounded_aggr\" WHERE ave_no3_leach_cgsb_round > 60"
sum = tbl(isuag_db, sql(query))
sum
```

Create a list of data frames:
```{r list}
data_list <- list(cgsb_leach, swg_low, swg_med, swg_hi)
str(data_list[[1]])
```

I am using a modified theme for ggplot that has a black border and white background:
```{r theme, cache=TRUE}
theme_b_border <- function (base_size = 12, base_family = "") 
{
  theme_grey(base_size = base_size, base_family = base_family) %+replace% 
    theme(
      axis.text = element_text(size = rel(0.8), margin = margin(r=10)), #margin 
      axis.ticks = element_line(colour = "black"),
      axis.ticks.length = unit(0.15, "cm"),
      legend.key = element_rect(colour = NA), panel.background = element_rect(fill = "white", 
      colour = NA), panel.border = element_rect(fill = NA, 
      colour = "black"), panel.grid.major = element_line(colour = NA, 
      size = 0.2), panel.grid.minor = element_line(colour = NA, 
      size = 0.5), strip.background = element_rect(fill = "grey80", 
      colour = "grey50", size = 0.2))
}
```

Prepare a data frame to be used for the facet plot:
```{r data, cache=TRUE}
scenario <- c(rep("cgsb", sum(sapply(data_list[1],nrow))), rep("swg_low", sum(sapply(data_list[2],nrow))), rep("swg_med", sum(sapply(data_list[3],nrow))), rep("swg_hi", sum(sapply(data_list[4],nrow)))) %>%
factor(levels= c('cgsb', 'swg_low', 'swg_med', 'swg_hi')) # make it a factor so that it is plotted in the right order in the facets
str(scenario)   

leaching <- vector(mode="numeric", length=0)
 for (i in seq(data_list))
   leaching <- append(leaching, data_list[[i]][,1])
str(leaching)  
area <- vector(mode="numeric", length=0)
 for (i in seq(data_list))
   area <- append(area, data_list[[i]][,2])
str(area)
   
leach <- data.frame(scenario, leaching, area = area*1e-6) # this factor to show Mha

head(leach)
```

Plot the distributions:
```{r histograms, cache=TRUE, fig.cap="Figure 1: Distributions of NO3 leaching"}
scenarios <- c('cgsb'= "Status Quo (corn/soybeans)", 'swg_low' = "Low yielding switchgrass", 'swg_med' = "Medium yielding switchgrass", 'swg_hi' = "High yielding switchgrass")

ggplot(leach, aes(leaching, weight = area)) + 
  geom_histogram(binwidth=2, alpha = .5, position="identity") +
  theme_b_border() +
  scale_x_continuous(name="Mean NO3 leaching 2006-2015 (kg N/ha)") +
  scale_y_continuous(name="Area (Mha)") +
  theme(legend.position="bottom") +
  facet_wrap( ~ scenario, ncol=2, labeller = as_labeller(scenarios)) 
```

##2. Correlation between profitability and NO3 leaching in corn and soybean fields##
I am using the table `05_dndc_clumu_cgsb_swg` in the isuag database, that contains 2012-2015 mean profit and leaching values for each of the four scenarios on a subfield (clu-map unit) scale. I want to see if there is a correlation between profitability and NO3 leaching, but since the complete data set contains more than 3 million records, I want to randomly select a sub-sample for the correlation.

Using a SQL chunk, create a table from a sub-sample (n=10000) *within* the PostgreSQL database. Setseed is used so that every time I run the code I will get the same random sample.
```{sql, connection=con, message=FALSE, cache=TRUE}
SELECT setseed(0.5)
```
```{sql, connection=con, message=FALSE, cache=TRUE}
DROP TABLE IF EXISTS "r_dndc_clumu_cgsb_swg_sample";
```
```{sql, connection=con, message=FALSE, cache=TRUE}
CREATE TABLE "r_dndc_clumu_cgsb_swg_sample" AS SELECT mean_profit_ha, ave_no3_leach_ha_cgsb FROM "05_dndc_clumu_cgsb_swg" ORDER BY random() LIMIT 10000
```


Pull the new table into R:
```{r data_sample}
sample = tbl(isuag_db, "r_dndc_clumu_cgsb_swg_sample") %>%
  as.data.frame(sample)

head(sample)
str(sample)
```

Plot the sample:
```{r scatterplot, cache=TRUE, fig.cap="Figure 2: Scatterplot of a subsample (n=10000) of profitability and corn/soy leaching data on subfield areas in Iowa. The red lines indicate possible cut off values, such as -250 US$/ha for profitability (solid) and 100 kg N/ha for NO3 leaching (dashed)."}
ggplot() +
  geom_point(data = sample, aes(x = mean_profit_ha, y = ave_no3_leach_ha_cgsb)) +
  theme_b_border() +
  scale_x_continuous(name="Mean profitability 2012-2015 (US$/ha)") +
  scale_y_continuous(name="Mean NO3 leaching 2006-2015 (kg N/ha)") +
  geom_vline(aes(xintercept= -250, linetype= "dashed", color = "red"),  show.legend = FALSE) +
  geom_hline(aes(yintercept= 100, linetype= "dotted", color = "red"),  show.legend = FALSE) 
  
```

There are many records with leaching values close to 0, and then only a few that are higher but below about 10. The next plot zooms in on the y axis to see this better:
```{r scatterplot_zoom, cache=TRUE, fig.cap="Figure 3: Scatterplot of a subsample (n=10000) of profitability and corn/soy leaching data on subfield areas in Iowa. The y axis is zoomed in on 0-20 kg N/ha to better see the low leaching values. The red line indicates a possible cut off value of -250 US$/ha for profitability."}
ggplot() +
  geom_point(data = sample, aes(x = mean_profit_ha, y = ave_no3_leach_ha_cgsb)) +
  theme_b_border() +
  scale_x_continuous(name="Mean profitability 2012-2015 (US$/ha)") +
  scale_y_continuous(name="Mean NO3 leaching 2006-2015 (kg N/ha)", limits=c(0,20)) +
  geom_vline(aes(xintercept= -250, linetype= "dashed", color = "red"),  show.legend = FALSE) +
  geom_hline(aes(yintercept= 100, linetype= "dotted", color = "red"),  show.legend = FALSE) 
  
```
In order to know how much of the area is included in those very low leaching patches, I run queries in the SQL database:
```{sql, connection=con, message=FALSE, cache=TRUE}
SELECT sum(clumuha) FROM "05_dndc_clumu_cgsb_swg" WHERE ave_no3_leach_ha_cgsb < 0.1
```
```{sql, connection=con, message=FALSE, cache=TRUE}
SELECT sum(clumuha) FROM "05_dndc_clumu_cgsb_swg" WHERE ave_no3_leach_ha_cgsb < 0.5
```
```{sql, connection=con, message=FALSE, cache=TRUE}
SELECT sum(clumuha) FROM "05_dndc_clumu_cgsb_swg" WHERE ave_no3_leach_ha_cgsb < 1
```
```{sql, connection=con, message=FALSE, cache=TRUE}
SELECT sum(clumuha) FROM "05_dndc_clumu_cgsb_swg" WHERE ave_no3_leach_ha_cgsb > 1 AND ave_no3_leach_ha_cgsb < 10
```

##3. Switchgrass integration scenarios##

From figure 2 we can see that the relation between NO3 leaching and profitability is not completely random. At higher profitability, the number of sub-field patches with high NO3 leaching values decreases. The lower the profitability, the higher the heterogeneity in leaching values. In other words, by managing the areas of lowest profitability in switchgrass would target those areas of highest leaching values (but also many of lower leaching values). Managing the areas of highest leaching (e.g. above a cut off of 100 kg N/ha) would mostly affect the areas that were on average unprofitable between 2012 and 2015.

I am choosing -250 US$/ha as a profitability cut off and 100 kg N/ha as an NO3 leaching cut off. That means, I produce two switchgrass integration scenarios:

1. Profit-optimized (PO): Switchgrass is grown on the sub-field areas where mean profitability is below -150 US$/ha
2. Water quality-optimized (WO): Switchgrass is grown on the sub-field areas where NO3 leaching is above 60 kg N/ha

Each of those scenario has three "sub-scenarios" assuming the three different switchgrass yields, so I end up having 6 scenarios that I want to compare to the status quo.

Comparison criteria:

Improvement of total N leaching in form of NO3 state wide and on the county level (in % of status quo values).

Leaching sums are calculated in PostgreSQL. Access the results:
```{r scenarios}
scen_areas <-tbl(isuag_db, "05_dndc_no3_leach_sums_iowa_scenarios")  %>%
  as.data.frame()
perc_leach_red <- 
kable(scen_areas, col.names=c("Status Quo","PO 7500 kg/ha", "PO 10000 kg/ha", "PO 12500 kg/ha","WO 7500 kg/ha", "WO 10000 kg/ha", "WO 12500 kg/ha"), caption="Mean annual NO3 leaching (Mg N/ha) in Iowa modelled with DNDC under different switchgrass integration scenarios. PO: Profitability optimized, WO: Water quality optimized." )
perc_leach_red
```



##4. Disproportionate benefits?##

I want to see how NO3 leaching reduction increases with increasing area in switchgrass, to test if the disproportionate benefits hypothesis holds true in our model.
Plot the mean profitability distribution to identify profitability cut off values:
```{r profit_distribution}
profit = tbl(isuag_db, "01_profit_mean_2012_2015_aggregated") %>%
  as.data.frame()
str(profit)

ggplot(profit, aes(profit_mean_ha_rounded, weight = sum_ha)) + 
  geom_histogram(binwidth=20, alpha = .5, position="identity") +
  theme_b_border() +
  scale_x_continuous(name="Mean profitability 2012-2015 (US$/ha)") +
  scale_y_continuous(name="Area (Mha)") +
  geom_vline(aes(xintercept= 0, linetype= "dashed"),  show.legend = FALSE) 
```

I want to select the total area of polygons that fall under specific profitability thresholds (PO scenario).
```{r swg_areas_po, cache=TRUE}
swg_areas_po <- vector(mode="numeric", length=0)
# profit <- tbl(isuag_db, "05_dndc_clumu_cgsb_swg")
profit_cutoffs <- c(-500, -400, -300, -200, -150, -100, -50, 0, 50, 100, 150)
 for (i in 1:length(profit_cutoffs)) {
    query <- paste("SELECT SUM(clumuha) FROM \"05_dndc_clumu_cgsb_swg\" WHERE mean_profit_ha < ", as.character(profit_cutoffs[i]))
    sum_area <- tbl(isuag_db, sql(query)) %>%
      as.data.frame()
    sum_area <- sum_area[1,1]
    swg_areas_po <- append(swg_areas_po, sum_area) 
  }
```

```{r no3_leaching_sums, cache=TRUE}
sum_leaching <- tbl(isuag_db, "05_dndc_no3_leach_sums_iowa_dispr_benefits") %>%
  as.data.frame() %>%
  gather(corn_soybeans, swg_7500_1, swg_7500_2, swg_7500_3, swg_7500_4, swg_7500_5, swg_7500_6, swg_7500_7, swg_7500_8, swg_7500_9, swg_7500_10, swg_7500_11, swg_10000_1, swg_10000_2, swg_10000_3, swg_10000_4, swg_10000_5, swg_10000_6, swg_10000_7, swg_10000_8, swg_10000_9, swg_10000_10, swg_10000_11, swg_12500_1, swg_12500_2, swg_12500_3, swg_12500_4, swg_12500_5, swg_12500_6, swg_12500_7, swg_12500_8, swg_12500_9, swg_12500_10, swg_12500_11, key = swg_scenarios, value=ave_no2_leach)
```

```{sql connection=con, message=FALSE, cache=TRUE}
select sum(clumuha) from "05_dndc_clumu_cgsb_swg";
```

I want to select the total area of polygons that fall above specific N leaching thresholds (WO scenario).
```{r swg_areas_wo, cache=TRUE}
swg_areas_wo <- vector(mode="numeric", length=0)
leach_cutoff <- c(100, 90, 80, 70, 60, 50)
 for (i in 1:length(leach_cutoff)) {
    query <- paste("SELECT SUM(clumuha) FROM \"05_dndc_clumu_cgsb_swg\" WHERE ave_no3_leach_ha_cgsb > ", as.character(leach_cutoff[i]))
    sum_area <- tbl(isuag_db, sql(query)) %>%
      as.data.frame()
    sum_area <- sum_area[1,1]
    swg_areas_wo <- append(swg_areas_wo, sum_area) 
  }
```

Create data frames for figures:
```{r data_dispr_benefits}
swg_yield <- as.factor(c("NA",rep("7500",11), rep("10000",11),rep("12500",11)))
profit_cutoff <- c(NA, rep(profit_cutoffs,3))
swg_area_po <- c(0,rep(swg_areas_po,3))
swg_area_po_percent <- (swg_area_po/9374362)*100
N_leaching <- sum_leaching[,2]
N_reduction <- abs((N_leaching - N_leaching[1])/N_leaching[1])*100

relation_po <- data.frame(swg_yield, profit_cutoff, swg_area_po_percent, N_reduction)

swg_area_wo_percent <- (swg_areas_wo/9374362)*100

relation_wo <- data.frame(leach_cutoff, swg_area_wo_percent)
```

Plot relationsships between thresholds and % area in switchgrass:
```{r thresholds, fig.show="hold", fig.height= 3, fig.width=4.5}
ggplot() +
  geom_point(data = relation_po, aes(x = profit_cutoff, y = swg_area_po_percent)) +
  theme_b_border() +
  scale_x_continuous(name="Profitability threshold (US$/ha)", breaks=seq(from=-500, to=200, by= 100)) +
  scale_y_continuous(name="Area in switchgrass (%)", limits= c(0,65))

ggplot() +
  geom_point(data = relation_wo, aes(x = leach_cutoff, y = swg_area_wo_percent)) +
  theme_b_border() +
  scale_x_reverse(name="NO3 leaching threshold (kg/ha)", breaks=seq(from=50, to=100, by= 10)) +
  scale_y_continuous(name="Area in switchgrass (%)", limits= c(0,65))


```



Plot relationships:
```{r relations, cache=TRUE, fig.show="hold", fig.height= 3, fig.width=4.5, fig.cap="Increase in NO~3~ leaching reduction with increasing area in switchgrass (A), and with increasing profitability threshold (B)."}

ggplot() +
  geom_point(data = relation_po, aes(x = swg_area_po_percent, y = N_reduction, color=swg_yield)) +
  theme_b_border() +
  scale_x_continuous(name="Area in switchgrass (%)") +
  scale_y_continuous(name="NO3 leaching reduction (% N)") +
  scale_color_discrete(name="Switchgrass\nYield",  guide = FALSE)

ggplot() +
  geom_point(data = relation_po, aes(x = profit_cutoff, y = N_reduction, color=swg_yield)) +
  theme_b_border() +
  scale_x_continuous(name="Profitability threshold (US$/ha)", breaks=seq(from=-500, to=200, by= 100)) +
  scale_y_continuous(name="NO3 leaching reduction (% N)") +
  scale_color_discrete(name="Switchgrass\nYield") +
  theme(legend.position=c(0.2,0.7))
```

##5. Spatial distribution of NO~3~ leaching changes##

Read in the table from the isuag database that contains county identifiers ("fips") and leaching results. Then, read in a shape file with county delineations.
```{r counties}
 counties_leach = tbl(isuag_db, "07_dndc_counties") %>%
   as.data.frame()
 counties_leach$fips <- as.factor(counties_leach$fips)
 names(counties_leach)
 colnames(counties_leach)[1] <- "abbr" #rename the id to match it with the spatial data frame below
 head(counties_leach)
 
 
ia_counties <- readOGR("Z:/ElkeBrandes/projects/01 subfield profit/data analysis/02 GIS/government_units/iowa_cnty/iowa_cnty_reprojected.shp", layer = "iowa_cnty_reprojected")
class(ia_counties)
names(ia_counties)
```

Merge the data frame to the spatial data frame
```{r}
cnty_leach <- merge(ia_counties, counties_leach, by="abbr")
class(cnty_leach)
names(cnty_leach)
```




# the column "abbr" correspond to "fips" in the PostgreSQL database data.
 
# ggplot() +
#   geom_polygon(data = ia_counties, aes(x = long, y = lat, group = group), fill=NA, color="grey") +
#   geom_polygon(data = us_states, aes(x = long, y = lat, group = group), fill = NA, color = "grey") +
#   xlim(c(-97, -90)) + ylim(c(40,44)) + 
#   coord_map() +
#   theme_b_border()
```


Shut the database down:
```{r shut, message=FALSE}
 rm(list='isuag_db'); gc() 
```
